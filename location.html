<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Location service · TMT Common Software (CSW)</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>

<!--
<link rel="shortcut icon" href="images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>TMT Common Software (CSW)
</a>
<div class="version-number">
0.1*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="services.html">Services</a>
  <ul>
    <li><a href="location.html" class="active">Location service</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="index.html">TMT Common Software (CSW)</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>TMT Common Software (CSW)
</a>
<div class="version-number">
0.1*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="services.html">Services</a>
  <ul>
    <li><a href="location.html" class="active">Location service</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="index.html">TMT Common Software (CSW)</a></li>
  <li><a href="services.html">Services</a></li>
  <li>Location service</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#location-service" name="location-service" class="anchor"><span class="anchor-link"></span></a>Location service</h1>
<p>Location Service handles component (i.e., Applications, Sequencers, Assemblies, HCDs, and Services) registration and discovery in the distributed TMT software system. A component’s location information can be utilized by other component/service to connect or use it. Example of location information is</p>
<ul>
  <li>host address/port pairs</li>
  <li>URL/URIs</li>
  <li>connection protocols</li>
</ul>
<h2><a href="#artifacts" name="artifacts" class="anchor"><span class="anchor-link"></span></a>Artifacts</h2>
<dl>
  <dt>sbt</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;org.tmt&quot; %% &quot;csw-location_2.12&quot; % &quot;0.1-SNAPSHOT&quot;
</code></pre></dd>
  <dt>Maven</dt>
  <dd>
  <pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
 &lt;groupId&gt;org.tmt&lt;/groupId&gt;
 &lt;artifactId&gt;csw-location_2.12&lt;/artifactId&gt;
 &lt;version&gt;0.1-SNAPSHOT&lt;/version&gt;
 &lt;type&gt;pom&lt;/type&gt;
&lt;/dependency&gt;
</code></pre></dd>
  <dt>Gradle</dt>
  <dd>
  <pre class="prettyprint"><code class="language-gradle">dependencies {
  compile group: &quot;org.tmt&quot;, name: &quot;csw-location_2.12&quot;, version: &quot;0.1-SNAPSHOT&quot;
}
</code></pre></dd>
</dl>
<h2><a href="#create-locationservice" name="create-locationservice" class="anchor"><span class="anchor-link"></span></a>Create LocationService</h2>
<dl>
  <dt>scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">lazy val locationService = LocationServiceFactory.make()</code></pre></dd>
  <dt>java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">private static ILocationService locationService = JLocationServiceFactory.make();</code></pre></dd>
</dl>
<h2><a href="#register-a-component" name="register-a-component" class="anchor"><span class="anchor-link"></span></a>Register a component</h2>
<p>An Application, Sequencer, Assembly, HCD, or Service component may need to be used by another component as part of normal operations. It must register its location information with Location service so that other components can find it.</p>
<h4><a href="#components-connections-and-registrations" name="components-connections-and-registrations" class="anchor"><span class="anchor-link"></span></a>Components, Connections and Registrations</h4>
<ul>
  <li>Components are OMOA entities. They have a name identifier and type such as HCD, Assembly, Service.</li>
  <li>Connections are the means to reach to components and are categorized as Akka, HTTP, Tcp connection.</li>
  <li>Registrations are service endpoints stored in LocationService.</li>
</ul>
<dl>
  <dt>scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val tcpConnection = TcpConnection(ComponentId(&quot;redis&quot;, ComponentType.Service))
val tcpRegistration = TcpRegistration(tcpConnection, 6380)

val httpConnection = HttpConnection(ComponentId(&quot;configuration&quot;, ComponentType.Service))
val httpRegistration = HttpRegistration(httpConnection, 8080, &quot;path123&quot;)

val akkaConnection = AkkaConnection(ComponentId(&quot;hcd1&quot;, ComponentType.HCD))
val akkaRegistration = AkkaRegistration(akkaConnection, actorRef)</code></pre></dd>
  <dt>java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">private TcpConnection tcpConnection = new Connection.TcpConnection(new ComponentId(&quot;redis&quot;, JComponentType.Service));
private TcpRegistration tcpRegistration = new TcpRegistration(tcpConnection, 6380);

private HttpConnection httpConnection = new Connection.HttpConnection(new ComponentId(&quot;configuration&quot;, JComponentType.Service));
private HttpRegistration httpRegistration = new HttpRegistration(httpConnection, 8080, &quot;path123&quot;);

private AkkaConnection akkaConnection = new Connection.AkkaConnection(new ComponentId(&quot;hcd1&quot;, JComponentType.HCD));
private AkkaRegistration akkaRegistration = new AkkaRegistration(akkaConnection, actorRef);</code></pre></dd>
</dl>
<h2><a href="#basic-operations" name="basic-operations" class="anchor"><span class="anchor-link"></span></a>Basic operations</h2>
<ul>
  <li><code>register</code> API takes a <code>Registration</code> parameter and returns a <code>Future</code> of <code>RegistrationResult</code>.</li>
  <li>The success of <code>register</code> API can be validated by checking the <code>Location</code> instance it contains.</li>
  <li>The <code>list</code> API returns a list of alive connections.</li>
  <li>A connection of interest, can be checked if available using the <code>resolve</code> API. If the connection is alive, <code>resolve</code> returns Future of <code>RegistrationResult</code> containing the <code>Location</code>, else failure.</li>
  <li>One of the ways to <code>unregister</code> a service is by calling unregister on registrationResult received from <code>register</code> API.</li>
</ul>
<dl>
  <dt>scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">  async {
  val tcpRegistrationResult = await(locationService.register(tcpRegistration))

  tcpRegistrationResult.location.connection shouldBe tcpConnection

  await(locationService.list) shouldBe List(tcpRegistrationResult.location)
  await(locationService.resolve(tcpConnection)) shouldBe Some(tcpRegistrationResult.location)

  println(tcpRegistrationResult.location.uri)

  await(tcpRegistrationResult.unregister())

  await(locationService.list) shouldBe List.empty
  await(locationService.resolve(tcpConnection)) shouldBe None
}
Await.result(assertionF, 5.seconds)</code></pre></dd>
  <dt>java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">CompletionStage&lt;Void&gt; completionStage = locationService.register(tcpRegistration).thenCompose(tcpRegistrationResult -&gt; {
    Assert.assertEquals(tcpRegistration.connection(), tcpRegistrationResult.location().connection());
    return locationService.list().thenCompose(locations -&gt; {
        Assert.assertEquals(expectedLocations, locations);
        return locationService.resolve(tcpConnection).thenCompose(locationOption -&gt; {
            Assert.assertEquals(tcpRegistration.location(new Networks().hostname()), locationOption.get());
            System.out.println(tcpRegistrationResult.location().uri());
            return tcpRegistrationResult.unregister().thenCompose(done -&gt; {
                return locationService.list().thenCompose(locations1 -&gt; {
                    Assert.assertEquals(Collections.EMPTY_LIST, locations1);
                    return locationService.resolve(tcpConnection).thenApply(location -&gt; {
                        Assert.assertEquals(Optional.empty(), location);
                        return null;
                    });
                });
            });
        });
    });
});

completionStage.toCompletableFuture().get();</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Short note on scala async</div>
<p>Below code snippets use scala&rsquo;s async library to demonstrate LocationService API. The use of this library is optional and the API will work just fine with higher order functions provided by scala. </p>
<p>However, this library makes it easy to work with asynchronous code portions. The <code>async</code> marks a block of asynchronous code. It contains one or more await calls, which marks a point at which the computation will be suspended until the awaited Future is complete.</p>
<p>For more info, please refer: <a href="https://github.com/scala/async">https://github.com/scala/async</a></p></div>
<h2><a href="#tracking" name="tracking" class="anchor"><span class="anchor-link"></span></a>Tracking</h2>
<ul>
  <li>The lifecycle of a connection of interest can be followed using <code>track</code> API which takes a <code>Connection</code> instance as a parameter. This Connection being tracked need not already be registered with LocationService. It&rsquo;s alright to track connections that will be registered in future. In return, caller gets two values:
    <ol>
      <li>A <strong>source</strong> that will emit stream of <code>TrackingEvents</code> for the connection</li>
      <li>A <strong>Killswitch</strong> to turn off the stream when no longer needed.</li>
    </ol>
  </li>
  <li>Akka stream API provides many building blocks to process this stream such as Flow and Sink. In example, Sink is used to print each incoming <code>TrackingEvent</code>.</li>
  <li>Consumer can shut down the stream using Killswitch.</li>
</ul>
<dl>
  <dt>scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val (killSwitch, doneF) = locationService.track(tcpConnection).toMat(Sink.foreach(println))(Keep.both).run()

Thread.sleep(200)

async {
  val tcpRegistrationResult = await(locationService.register(tcpRegistration))
  val httpRegistrationResult = await(locationService.register(httpRegistration))

  Thread.sleep(200)

  await(tcpRegistrationResult.unregister())
  await(locationService.unregister(httpConnection))

  Thread.sleep(200)
  killSwitch.shutdown()
}

Await.result(doneF, 5.seconds)</code></pre></dd>
  <dt>java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">Pair&lt;KillSwitch, CompletionStage&lt;Done&gt;&gt; stream = locationService.track(tcpConnection).toMat(Sink.foreach(System.out::println), Keep.both()).run(mat);

Thread.sleep(200);

CompletionStage&lt;Void&gt; registrationStage = locationService.register(tcpRegistration).thenCompose(tcpRegistrationResult -&gt; {
    return locationService.register(httpRegistration).thenApply(httpRegistrationResult -&gt; {
        return null;
    });
});
registrationStage.toCompletableFuture().get();

Thread.sleep(200);

CompletionStage&lt;Object&gt; unRegistrationStage = locationService.unregister(tcpConnection).thenCompose(uResult1 -&gt; {
    return locationService.unregister(httpConnection).thenApply(uResult -&gt; {
        return null;
    });
});
unRegistrationStage.toCompletableFuture().get();

Thread.sleep(400);
stream.first().shutdown();</code></pre></dd>
</dl>
<h2><a href="#filtering" name="filtering" class="anchor"><span class="anchor-link"></span></a>Filtering</h2>
<ul>
  <li>The <code>List</code> API and it&rsquo;s variants offer means to inquire about available connections with LocationService.</li>
  <li>The parameterless list returns all available connections</li>
  <li>The <code>list</code> api with connection type returns connections matching the <code>ConnectionType</code>. In example it is demonstrated using &lsquo;ConnectionType.AkkaType&rsquo;.</li>
  <li>Similarly, filtering using &lsquo;ComponentType.Service&rsquo; and hostname is also supported by <code>list</code> API.</li>
  <li>Note, in the example the akka connection is not listed when filtered using hostname. This is because the actorref is created using local ActorSystem in a test class which doesn&rsquo;t have a hostname.</li>
</ul>
<dl>
  <dt>scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val assertionF: Future[Assertion] = async {
  val tcpRegistrationResult = await(locationService.register(tcpRegistration))
  val httpRegistrationResult = await(locationService.register(httpRegistration))
  val akkaRegistrationResult = await(locationService.register(akkaRegistration))

  await(locationService.list).toSet shouldBe Set(tcpRegistrationResult.location, httpRegistrationResult.location, akkaRegistrationResult.location)
  await(locationService.list(ConnectionType.AkkaType)).toSet shouldBe Set(akkaRegistrationResult.location)
  await(locationService.list(ComponentType.Service)).toSet shouldBe Set(tcpRegistrationResult.location, httpRegistrationResult.location)
  await(locationService.list(new Networks().hostname())).toSet shouldBe Set(tcpRegistrationResult.location, httpRegistrationResult.location)
}

Await.result(assertionF, 5.seconds)</code></pre></dd>
  <dt>java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">//expected list of locations
ArrayList&lt;Location&gt; expectedLocations1 = new ArrayList&lt;&gt;();
expectedLocations1.add(tcpRegistration.location(new Networks().hostname()));
expectedLocations1.add(httpRegistration.location(new Networks().hostname()));
expectedLocations1.add(akkaRegistration.location(new Networks().hostname()));

//Filter by type
ArrayList&lt;Location&gt; expectedLocations2 = new ArrayList&lt;&gt;();
expectedLocations2.add(akkaRegistration.location(new Networks().hostname()));

//Filter by service
ArrayList&lt;Location&gt; expectedLocations3 = new ArrayList&lt;&gt;();
expectedLocations3.add(tcpRegistration.location(new Networks().hostname()));
expectedLocations3.add(httpRegistration.location(new Networks().hostname()));

//Filter by hostname
ArrayList&lt;Location&gt; expectedLocations4 = new ArrayList&lt;&gt;();
expectedLocations4.add(tcpRegistration.location(new Networks().hostname()));
expectedLocations4.add(httpRegistration.location(new Networks().hostname()));

CompletionStage&lt;Void&gt; completionStage = locationService.register(tcpRegistration).thenCompose(tcpRegistrationResult -&gt; {
    return locationService.register(httpRegistration).thenCompose(httpRegistrationResult -&gt; {
        return locationService.register(akkaRegistration).thenCompose(akkaRegistrationResult -&gt; {
            return locationService.list().thenCompose(locations1 -&gt; {
                Assert.assertEquals(expectedLocations1, locations1);
                return locationService.list(JConnectionType.AkkaType).thenCompose(locations2 -&gt; {
                    Assert.assertEquals(expectedLocations2, locations2);
                    return locationService.list(JComponentType.Service).thenCompose(locations3 -&gt; {
                        Assert.assertEquals(expectedLocations3, locations3);
                        return locationService.list(new Networks().hostname()).thenApply(locations4 -&gt; {
                            Assert.assertEquals(expectedLocations4, locations4);
                            return null;
                        });
                    });
                });
            });
        });
    });
});

completionStage.toCompletableFuture().get();</code></pre></dd>
</dl>
<h2><a href="#shutdown" name="shutdown" class="anchor"><span class="anchor-link"></span></a>Shutdown</h2>
<p>This example demonstrates how to shutdown a location service. </p>
<dl>
  <dt>scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">Await.result(locationService.shutdown(), 20.seconds)</code></pre></dd>
  <dt>java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">locationService.shutdown().toCompletableFuture().get();</code></pre></dd>
</dl>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tmtsoftware/csw-prod/tree/master/docs/src/main/location.md">here</a>.
</div>

</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="location.html#location-service">Location service</a>
  <ul>
    <li><a href="location.html#artifacts">Artifacts</a></li>
    <li><a href="location.html#create-locationservice">Create LocationService</a></li>
    <li><a href="location.html#register-a-component">Register a component</a></li>
    <li><a href="location.html#basic-operations">Basic operations</a></li>
    <li><a href="location.html#tracking">Tracking</a></li>
    <li><a href="location.html#filtering">Filtering</a></li>
    <li><a href="location.html#shutdown">Shutdown</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2017</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

</html>
