<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>ESW Application Architecture Â· TMT Executive Software Documentation</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
<link rel="stylesheet" href="../assets/custom.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Executive Software Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software Documentation
</span>
<span class="md-header-nav__topic">
ESW Application Architecture
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Executive Software Documentation" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Executive Software Documentation">
TMT Executive Software Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
<ul>
  <li><a href="../esw/eswOverview.html" class="page">Executive Software Overview</a></li>
  <li><a href="../sequencersandscripts/seq-index.html" class="page">Sequencers and Sequence Components</a>
  <ul>
    <li><a href="../sequencersandscripts/sequencer.html" class="page">Sequencers in the Executive Software</a></li>
    <li><a href="../sequencersandscripts/sequencer-app.html" class="page">Running a Sequencer Using esw-ocs-app</a></li>
  </ul></li>
  <li><a href="../scripts/scripts-index.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../scripts/script-styles.html" class="page">Sequencer Script Styles</a></li>
    <li><a href="../scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../uisupport/uisupp-index.html" class="page">User Interface Support</a>
  <ul>
    <li><a href="../uisupport/UIOverview.html" class="page">User Interfaces in ESW and TMT</a></li>
    <li><a href="../uisupport/gatewayUI-template.html" class="page">Using the Gateway-only UI Template and Tutorial</a></li>
    <li><a href="../uisupport/webapp-template.html" class="page">Using the Web Application Template and Tutorial</a></li>
    <li><a href="../uisupport/gateway.html" class="page">User Interface Gateway</a></li>
  </ul></li>
  <li><a href="../technical/apps/apps-index.html" class="page">ESW Applications</a>
  <ul>
    <li><a href="../technical/apps/getting-apps.html" class="page">Getting and Running ESW Applications</a></li>
    <li><a href="../technical/apps/esw-shell.html" class="page">ESW Shell - A Testing Environment for ESW and CSW</a></li>
    <li><a href="../technical/apps/sequence-manager-app.html" class="page">Starting the Sequence Manager Application</a></li>
    <li><a href="../technical/apps/agent-service-app.html" class="page">The Agent Service Application</a></li>
    <li><a href="../technical/apps/agent-app.html" class="page">The Agent Application</a></li>
    <li><a href="../uisupport/gateway-app.html" class="page">Running the UI Gateway App</a></li>
    <li><a href="../technical/apps/esw-services.html" class="page">Running Multiple ESW Applications with esw-services</a></li>
    <li><a href="../technical/apps/eng-ui.html" class="page">ESW OCS Engineering User Interface User Manual</a></li>
  </ul></li>
  <li><a href="../technical/tech-index.html" class="page">Technical Design Documents</a>
  <ul>
    <li><a href="../technical/sequence-manager-tech.html" class="page">Sequence Manager Technical Documentation</a></li>
    <li><a href="../technical/sequencer-tech.html" class="page">Sequencer Technical Documentation</a></li>
    <li><a href="../technical/sequence-component-tech.html" class="page">Sequence Component Technical Documentation</a></li>
    <li><a href="../technical/gateway-tech.html" class="page">Gateway Technical Documentation</a></li>
    <li><a href="../technical/agent-service-tech.html" class="page">Agent Service and Agent Technical Documentation</a></li>
    <li><a href="../technical/esw-application-parts.html" class="active page">ESW Application Architecture</a></li>
    <li><a href="../technical/contracts.html" class="page">Service Contracts</a></li>
    <li><a href="../technical/testing-philosophy.html" class="page">OSW Testing Philosophy</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../technical/esw-application-parts.html#esw-application-architecture" class="header">ESW Application Architecture</a>
  <ul>
    <li><a href="../technical/esw-application-parts.html#the-main-class" class="header">The Main Class</a></li>
    <li><a href="../technical/esw-application-parts.html#the-wiring-class" class="header">The Wiring Class</a></li>
    <li><a href="../technical/esw-application-parts.html#the-http-service" class="header">The Http Service</a></li>
    <li><a href="../technical/esw-application-parts.html#route-handlers" class="header">Route Handlers</a></li>
    <li><a href="../technical/esw-application-parts.html#api-classes" class="header">API Classes</a></li>
    <li><a href="../technical/esw-application-parts.html#impl-classes-akka-clients-" class="header">Impl Classes (Akka Clients)</a></li>
    <li><a href="../technical/esw-application-parts.html#behavior-classes" class="header">Behavior Classes</a></li>
    <li><a href="../technical/esw-application-parts.html#codecs-serialization-deserialization-" class="header">Codecs (Serialization/Deserialization)</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.5.0-RC2
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../technical/esw-application-parts.html#esw-application-architecture" class="header">ESW Application Architecture</a>
  <ul>
    <li><a href="../technical/esw-application-parts.html#the-main-class" class="header">The Main Class</a></li>
    <li><a href="../technical/esw-application-parts.html#the-wiring-class" class="header">The Wiring Class</a></li>
    <li><a href="../technical/esw-application-parts.html#the-http-service" class="header">The Http Service</a></li>
    <li><a href="../technical/esw-application-parts.html#route-handlers" class="header">Route Handlers</a></li>
    <li><a href="../technical/esw-application-parts.html#api-classes" class="header">API Classes</a></li>
    <li><a href="../technical/esw-application-parts.html#impl-classes-akka-clients-" class="header">Impl Classes (Akka Clients)</a></li>
    <li><a href="../technical/esw-application-parts.html#behavior-classes" class="header">Behavior Classes</a></li>
    <li><a href="../technical/esw-application-parts.html#codecs-serialization-deserialization-" class="header">Codecs (Serialization/Deserialization)</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#esw-application-architecture" name="esw-application-architecture" class="anchor"><span class="anchor-link"></span></a>ESW Application Architecture</h1>
<p>Goal of this section is to provide walk through of the low level design of the ESW applications. This section is targeted towards future maintainers of the ESW. It should help them understand different parts of the ESW applications and easily navigate through the codebase.</p>
<p>The applications in ESW are not CSW Assemblies and HCDs, they are registered in the Location Service with ComponentType <code>Service</code>. The ESW applications have been constructed in a similar way to make the code easier to understand and test. This section describes the parts of an ESW application and introduces the terminology used in the code base.</p>
<p>ESW applications are divided into following three major categories:</p>
<ol>
  <li>Actor based, for example, Agent Akka Application.</li>
  <li>HTTP based, for example, Agent Service, Gateway Application.</li>
  <li>Embedded HTTP + Actor based - Such applications exposes two protocols for communication, one is HTTP and other is Akka. for example, ESW OCS (Sequencer) Application.</li>
</ol>
<p>Most if not all the ESW applications follows the following conventions for organizing the codebase:</p>
<ol>
  <li><strong>Main</strong> - Runnable application responsible for starting the ESW service.</li>
  <li><strong>Wiring</strong> - Initializes all the dependencies and wires them together.</li>
  <li><strong>HttpService</strong> - Starts and registers the HTTP service with Location Service.</li>
  <li><strong>Route Handlers</strong> - Defines two types of the routes for the HTTP service i.e. HTTP routes and Websocket routes.</li>
  <li><strong>API</strong> - Interface defining the contract for the Service</li>
  <li><strong>Impl</strong> - Server side implementation of the API.</li>
  <li><strong>Clients</strong> - Two types of clients implementing API i.e. HTTP and Actor clients.</li>
  <li><strong>Actor Behavior</strong> - Defines the behavior of the Service. This includes actual implementation of backend service logic.</li>
  <li><strong>Codecs</strong> - Encoders and Decoders required for the remote communication. This includes codecs required for Actors and HTTP service.</li>
</ol>
<h2><a href="#the-main-class" name="the-main-class" class="anchor"><span class="anchor-link"></span></a>The Main Class</h2>
<p>Main class is the entry point for all the ESW applications, and responsible for specifying the command line arguments, options and parsing them to domain models.</p>
<p>This capability is provided by extending Main class with <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-commons/src/main/scala/esw/commons/cli/EswCommandApp.scala">EswCommandApp</a> which is part of <a href="https://github.com/alexarchambault/case-app">case-app</a>. <strong>case-app</strong> is a command line argument parsing library for scala.</p>
<p>With CaseApp, main class arguments have <code>commands</code> and <code>options</code>. A class is associated with each supported command and that class has fields corresponding to each supported program option. These model classes represent the command and its options.</p>
<p>Examples of main classes are:</p>
<ul>
  <li>
  <p>The User Interface Gateway Service application class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-gateway/esw-gateway-server/src/main/scala/esw/gateway/server/GatewayMain.scala">GatewayMain</a> and the <code>start</code> command class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-gateway/esw-gateway-server/src/main/scala/esw/gateway/server/ServerCommand.scala">ServerCommand</a>.</p></li>
  <li>
  <p>The Agent Service application class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-agent-service/esw-agent-service-app/src/main/scala/esw/agent/service/app/AgentServiceApp.scala">AgentServiceApp</a> and the <code>start</code> command class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-agent-service/esw-agent-service-app/src/main/scala/esw/agent/service/app/AgentServiceAppCommand.scala">AgentServiceAppCommand</a>.</p></li>
</ul>
<h2><a href="#the-wiring-class" name="the-wiring-class" class="anchor"><span class="anchor-link"></span></a>The Wiring Class</h2>
<p>When the main class executes it uses the command and arguments to create a new instance of a <code>Wiring</code> class. The <code>Wiring</code> class is the place where all resources or dependencies the application uses are initialized.</p>
<p>Some of the common examples of instances and resources created by <code>Wiring</code> are: <code>ActorSystem</code>, API implementation instances, Application Settings, <code>HttpService</code>, HTTP and Websocket handlers and clients to connect to other services like Location Service, Event Service etc</p>
<p>Examples of application <code>Wiring</code>:</p>
<ul>
  <li>
  <p>For the User Interface Gateway, the wiring class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-gateway/esw-gateway-server/src/main/scala/esw/gateway/server/GatewayWiring.scala">GatewayWiring</a>.</p></li>
  <li>
  <p>For the Agent Service, the wiring class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-agent-service/esw-agent-service-app/src/main/scala/esw/agent/service/app/AgentServiceWiring.scala">AgentServiceWiring</a>.</p></li>
  <li>
  <p>For the Sequence Manager, the wiring class is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-sm/esw-sm-app/src/main/scala/esw/sm/app/SequenceManagerWiring.scala">SequenceManagerWiring</a>.</p></li>
</ul><div class="callout note "><div class="callout-title">Hint</div>
<p>ESW architecture classes are usually named to describe their function in the application architecture (e.g., SequenceManagerWiring or AgentServiceAppMain).</p></div>
<h2><a href="#the-http-service" name="the-http-service" class="anchor"><span class="anchor-link"></span></a>The Http Service</h2>
<p>As mentioned in the introductory section, many ESW applications for example, Gateway, ocs-app (Sequencer), Sequence Manager etc. are either HTTP based or Embedded HTTP + Actor based, and requires capabilities to start and register with Location Service.</p>
<p>We have extracted out these common capabilities in independent module called <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-http-core/src">esw-http-core</a>. This module has class <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-http-core/src/main/scala/esw/http/core/wiring/HttpService.scala">HttpService</a> which is responsible for initializing a HTTP Server and registering it with Location Service.</p>
<p><code>esw-http-core</code> module has other common utilities like,</p>
<ol>
  <li><a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-http-core/src/main/scala/esw/http/core/wiring/HttpService.scala">ActorRuntime</a> - Small wrapper over <code>ActorSystem</code> responsible for providing implicit <code>ActorSystem</code>, <code>ExecutionContext</code>, starting Logging Service and closing resources on shutdown.</li>
  <li><a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-http-core/src/main/scala/esw/http/core/wiring/Settings.scala">Settings</a> - Reading application specific configurations like service prefix, HttpConnection (Used to register with Location Service) etc</li>
</ol><div class="callout note "><div class="callout-title">Note</div>
<p>The User Interface Gateway is only registered as an HTTP service in Location Service. Because of its role in the TMT architecture as the gateway for HTTP requests from browser-based user interfaces, and its role in authentication of users, it does not provide a public Akka location in the Location Service.</p></div>
<h2><a href="#route-handlers" name="route-handlers" class="anchor"><span class="anchor-link"></span></a>Route Handlers</h2>
<p>An HTTP Service uses routes, which map the incoming requests to the code that uses the information in the request to handle the request. A <code>route handler</code> is the application-specific code that maps the request to the application code. There may be two types of route handlers in an ESW application: <code>PostHandler</code> and <code>WebsocketHandler</code>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>ESW infrastructure services do not use REST-like path-oriented requests. Rather, all requests are encoded as JSON and POSTed to the service. This is common in services that are not directly user-facing. This also simplifies the route handling since there are only a few routes. The content of the requests is documented in the contracts.</p></div>
<h3><a href="#posthandler" name="posthandler" class="anchor"><span class="anchor-link"></span></a>PostHandler</h3>
<p>This handler implements routes corresponding to HTTP POST requests. The underlying infrastructure used to handle HTTP requests has been placed in a common ESW library called <a href="https://github.com/tmtsoftware/msocket">msocket</a>.</p>
<p>Examples of PostHandler are:</p>
<ul>
  <li>
  <p>For the User Interface Gateway, the POST route handler is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-gateway/esw-gateway-server/src/main/scala/esw/gateway/server/handlers/GatewayPostHandler.scala">GatewayPostHandler</a>.</p></li>
  <li>
  <p>For the Agent Service, the POST route handler is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-agent-service/esw-agent-service-app/src/main/scala/esw/agent/service/app/handlers/AgentServicePostHandler.scala">AgentServicePostHandler</a>.</p></li>
</ul>
<h3><a href="#websockethandler" name="websockethandler" class="anchor"><span class="anchor-link"></span></a>WebsocketHandler</h3>
<p>Some applications need to keep open connections. For instance, the User Interface Gateway needs to subscribe to events from Event Service or wait for command responses fom Command Service. In this case, a client posts a subscription request and the result is a WebSocket.</p>
<p>Since, WebSocket requests work on top of the HTTP protocol, routes in the WebsocketHandler are also handled by <code>HttpService</code> along with PostHandler routes.</p>
<p>Examples of <code>WebsocketHandler</code> are:</p>
<ul>
  <li>
  <p>For the User Interface Gateway, the WebSocket handler is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-gateway/esw-gateway-server/src/main/scala/esw/gateway/server/handlers/GatewayWebsocketHandler.scala">GatewayWebsocketHandler</a>.</p></li>
  <li>
  <p>For the Sequencer, the WebSocket handler is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-handler/src/main/scala/esw/ocs/handler/SequencerWebsocketHandler.scala">SequencerWebsocketHandler</a>.</p></li>
</ul><div class="callout note "><div class="callout-title">Note</div>
<p>Applications that do not need streaming data do not have a WebSocketHandler. For instance, the Agent Service does not have a WebSocketHandler.</p></div>
<h2><a href="#api-classes" name="api-classes" class="anchor"><span class="anchor-link"></span></a>API Classes</h2>
<p>The Application Programmer Interface or API classes define the functionality of the service. The API class is used and implemented by the service clients.</p>
<p>For reference, the following figure shows how the API classes and the other classes in this section are related.</p>
<p><img src="../images/techdocs/ESWAppFigures1.png" alt="ESW App Parts" /></p>
<p>Examples of service API classes are:</p>
<ul>
  <li>
  <p>For the Sequencer, the API is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/shared/src/main/scala/esw/ocs/api/SequencerApi.scala">SequencerApi</a>.</p></li>
  <li>
  <p>For Sequence Manager, the API is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-sm/esw-sm-api/shared/src/main/scala/esw/sm/api/SequenceManagerApi.scala">SequencerManagerApi</a>.</p></li>
</ul>
<p>Because an ESW application often provides both an Akka-based client and an HTTP-based client, the API class may be used in 2 places.</p>
<h2><a href="#impl-classes-akka-clients-" name="impl-classes-akka-clients-" class="anchor"><span class="anchor-link"></span></a>Impl Classes (Akka Clients)</h2>
<p>The Impl or implementation classes are one implementation of the API. In an ESW application based on Akka, the service itself is implemented as Akka-based actors in the <code>Behavior classes</code>.</p>
<p>The API is written as a typical API with methods that are called and return results.<br/>Most of the time, the impl classes are converting the API method to an Akka-based message and sending the message to the Behavior actor. If it gets a response as a message, it converts it to the correct type for the API.</p>
<p>Examples of impl or Akka client classes are:</p>
<ul>
  <li>
  <p>For the Sequencer, the impl is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/jvm/src/main/scala/esw/ocs/api/actor/client/SequencerImpl.scala">SequencerImpl</a>.</p></li>
  <li>
  <p>For Sequence Manager, the impl is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-sm/esw-sm-api/jvm/src/main/scala/esw/sm/api/actor/client/SequenceManagerImpl.scala">SequencerManagerImpl</a>.</p></li>
</ul>
<p>These impl classes can call other services to fulfill the requests or handle it locally using the service&rsquo;s Behavior classes.</p>
<h2><a href="#behavior-classes" name="behavior-classes" class="anchor"><span class="anchor-link"></span></a>Behavior Classes</h2>
<p>At their core, the ESW applications are implemented as Akka Actors. A <code>behavior class</code> is the top level Akka implementation of the service. It is called a behavior because that&rsquo;s what Akka calls the type returned by a newly constructed typed actor.</p>
<p>Behavior classes receive Akka messages, which are often defined in a <code>protocol</code> package such as <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-sm/esw-sm-api/shared/src/main/scala/esw/sm/api/protocol/">this</a>, which includes two message files for the Sequence Manager requests and responses. The Impl classes are clients, and don&rsquo;t have logic to manage the application state; state and functionality is handled by the actor behavior classes. State-based functionality is often implemented using the Akka actor state machine pattern.</p>
<p>Examples of behavior classes are:</p>
<ul>
  <li>
  <p>For the Sequencer, the behavior is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-impl/src/main/scala/esw/ocs/impl/core/SequencerBehavior.scala">SequencerBehavior</a>.</p></li>
  <li>
  <p>For Sequence Manager, the behavior is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-sm/esw-sm-impl/src/main/scala/esw/sm/impl/core/SequenceManagerBehavior.scala">SequencerManagerBehavior</a>.</p></li>
  <li>
  <p>For Agent, the behavior is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-agent-akka/esw-agent-akka-app/src/main/scala/esw/agent/akka/app/AgentActor.scala">AgentActor</a>.</p></li>
</ul>
<h2><a href="#codecs-serialization-deserialization-" name="codecs-serialization-deserialization-" class="anchor"><span class="anchor-link"></span></a>Codecs (Serialization/Deserialization)</h2>
<p>When a request is sent over the network to a service, it needs to be converted from the programming language model and sent over the network in some agreed upon format. Serialization (encoding/marshalling) is the conversion from the programming language model to the network format, and deserialization (decoding/unmarshalling) is the conversion back from the network format to the programming language representation. In CSW/ESW Akka messages between remote actors are serialized into a format called Concise Binary Object Representation or CBOR (see <a href="https://cbor.io">CBOR RFC8949 standard</a>). Messages using the HTTP transport are serialized and deserialized to Javscript Object Notation or JSON (see <a href="https://www.json.org/json-en.html">JSON spec</a>).</p>
<p>For serialization, CSW/ESW applications use the open-source <a href="https://sirthias.github.io/borer/">Borer</a> library to automatically generate serialization code that converts model classes to/from the JSON and CBOR formats. One big advantage of this library over others is that it can serialize/deserialize to JSON as well as CBOR.</p>
<h3><a href="#codec-classes" name="codec-classes" class="anchor"><span class="anchor-link"></span></a>Codec Classes</h3>
<p>In many cases Borer will <em>automatically</em> generate serialization classes or <code>codecs</code>, but messages must be explicitly indicated with a Borer library call. For example in <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/shared/src/main/scala/esw/ocs/api/codecs/OcsCodecs.scala">OcsCodecs</a>, the codec for a step in a sequence is created with this line:</p>
<pre class="prettyprint"><code class="language-scala">implicit lazy val stepCodec: Codec[Step] = deriveCodec 
</code></pre>
<p>Here <code>deriveCodec</code> does the job of generating decoder/encoder code for serialization/deserialization. These codec classes are parameterized with the model case classes and are marked implicit so that when a class extends this codec class it gets the model class codec automatically. You can even have hierarchy of model classes and only need to provide a top level class/marker trait to automatically derive child class codecs. For example in <code>SequencerServiceCodecs</code>:</p>
<pre class="prettyprint"><code class="language-scala">implicit lazy val sequencerPostRequestValue: Codec[SequencerRequest]  = deriveAllCodecs
</code></pre>
<p>Here you see <code>deriveAllCodecs</code>, which causes the generation of decoder/encoder for the complete class hierarchy starting from the top level <code>SequencerRequest</code>.</p>
<p>There are mainly two use cases when you need to serialize/deserialize a request and response:</p>
<ol>
  <li>Remote Actor Communication (Akka actor)</li>
  <li>HTTP Communication (Akka HTTP</li>
</ol>
<h4><a href="#remote-actor-communication" name="remote-actor-communication" class="anchor"><span class="anchor-link"></span></a>Remote Actor Communication</h4>
<p>Actors registers their location with Location Service when they are created. Using this location, other actors or services running on different JVM&rsquo;s or machine can communicate by message passing. These messages have to undergo some form of serialization (i.e. the objects have to be converted to and from byte arrays). This is where de/serialization (codecs) come into play. We use <a href="https://cbor.io/">CBOR</a> format uniformly for serializing/deserializing actor messages. For example, when a Sequencer receives requests from the User Interface Gateway via Akka actors due to a UI call, the message is serialized as CBOR.</p>
<p>The first step for the Akka/CBOR case is to add Borer codecs for message model classes so that encoder/decoders can be derived as described above. An example is: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/jvm/src/main/scala/esw/ocs/api/actor/OcsMsgCodecs.scala">OcsMsgCodecs</a> that extends <code>OcsCodecs</code> used above. This example shows the Borer Codec type parameterized with the message class model classes that are sent to Sequencer in requests and responses.</p>
<p>In order for the Akka infrastructure to see and use the Borer serializing code, a class is created that inherits from the abstract Akka serializer infrastructure class: <code>CborAkkaSerializer</code> that is part of the CSW code and <code>register</code> each of the service message classes.</p>
<p>For the Sequencer messages, this class is called <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/jvm/src/main/scala/esw/ocs/api/actor/OcsAkkaSerializer.scala">OcsAkkaSerializer</a>. The message classes must also be marked as Serializable, which in this case is done with the <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/shared/src/main/scala/esw/ocs/api/codecs/OcsAkkaSerializable.scala">OcsAkkaSerializable</a> trait. Both the serializer and the serializable class are present in the configuration of application (through the classpath) so that Akka actors can use them for serialization/deserialization.</p>
<p>The final step needed is configuration to make sure Akka is aware of the special serialization by hooking OcsAkkaSerializer into the Akka infrastructure. For the Sequencer (and any Akka-based app), this is done in the <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/jvm/src/main/resources/reference.conf">reference.conf</a> file of the clients of Sequencer. As shown below, the <code>ocs-framework-cbor</code> property is set to the class name of <code>OcsAkkaSerializer</code>, and whenever a class is marked with <code>OcsAkkaSerializable</code> Akka will use the <code>ocs-framework-cbor</code> serializer.</p>
<pre class="prettyprint"><code class="language-scala">akka.actor {
  serializers {
    ocs-framework-cbor = &quot;esw.ocs.api.actor.OcsAkkaSerializer&quot;
  }
  serialization-bindings {
    &quot;esw.ocs.api.codecs.OcsAkkaSerializable&quot; = ocs-framework-cbor
  }
  provider = remote
}
</code></pre>
<p>This resource file is part of the <strong>esw-ocs-api</strong> package, so any client or service that depends on this api jar file will be configured to serialize and deserialize Akka CBOR-based messages.</p>
<p>Refer <a href="https://doc.akka.io/docs/akka/current/serialization.html">Akka Serialization</a> documentation for more details on how to wire up custom CBOR based serializer up with Akka.</p>
<p>Some of the examples for Actor remote message codecs are <code>OcsCodecs</code>, <code>SequencerServiceCodecs</code> etc</p>
<h4><a href="#http-based-communication" name="http-based-communication" class="anchor"><span class="anchor-link"></span></a>HTTP-based Communication</h4>
<p>HTTP based services are implemented using <a href="https://github.com/tmtsoftware/msocket">msocket</a> library which usage <a href="https://doc.akka.io/docs/akka-http/current/">Akka HTTP</a> under the hood.</p>
<p>MSocket exposes two factories, <code>PostRouteFactory[Req]</code> and <code>WebsocketRouteFactory[Req]</code> for generating HTTP and Websocket routes respectively. Both these factories require implicit decoder in scope, so that Akka HTTP server can decode the incoming HTTP request. This mechanism is called <code>Unmarshalling</code> in Akka HTTPs terminology. These decoders are brought into scope by <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-app/src/main/scala/esw/ocs/app/wiring/SequencerWiring.scala">SequencerWiring</a> extending from <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/shared/src/main/scala/esw/ocs/api/codecs/SequencerServiceCodecs.scala">SequencerServiceCodecs</a>.</p>
<p>Similarly, <code>PostHandler</code> and <code>WebsocketHandler</code> are responsible for processing incoming HTTP requests and returning HTTP response. Hence, it requires implicit encoders in scope. This mechanism is called <code>Marshalling</code> in Akka HTTPs terminology. In case of <code>SequencerPostHandler</code> and <code>SequencerWebsocketHandler</code>, these encoders are brought into scope using following import <code>import esw.ocs.api.codecs.SequencerServiceCodecs.*</code></p>
<p>Another place where de/serialization required is while creating HTTP <code>postClient</code> using <code>msocket</code> library. The critical part of this is that the request must be serialized to JSON to be included as the payload to an HTTP POST method and deserialize the JSON response coming from HTTP service.</p>
<p>An example of this is the HTTP client for Sequencer: <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/shared/src/main/scala/esw/ocs/api/client/SequencerClient.scala">SequencerClient</a>, which is created in the <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/jvm/src/main/scala/esw/ocs/api/actor/client/SequencerApiFactory.scala">SequencerApiFactory</a> (which also creates the Akka client).</p>
<p>The client code must be constructed with the serialization codecs for the HTTP-based requests and responses. For example, <a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/esw-ocs/esw-ocs-api/shared/src/main/scala/esw/ocs/api/codecs/SequencerServiceCodecs.scala">SequencerServiceCodecs</a> extends <code>OcsCodecs</code> mentioned above. <code>SequencerClient</code> extends this and has access to all the needed codecs.</p>
<p>The complete flow of classes discussed above is:</p>
<p>Main (using case app) -&gt; Wiring -&gt; HttpService(esw-http-core) -&gt; HttpPostHandler(using Codecs) + WebsocketHandler(using Codecs) -&gt; Behavior classes(using Codecs).</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/fc99c5987bfef9da8b3fd44f1fe0dfbef9fce54a/docs/src/main/technical/esw-application-parts.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.5.0-RC2
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../technical/agent-service-tech.html" title="Agent Service and Agent Technical Documentation" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Agent Service and Agent Technical Documentation
</span>
</div>
</a>
<a href="../technical/contracts.html" title="Service Contracts" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Service Contracts
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
