<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../assets/images/favicon.png">
<title>Finite State Machines Â· TMT Executive Software Documentation</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../index.html" title="TMT Executive Software Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software Documentation
</span>
<span class="md-header-nav__topic">
Finite State Machines
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../index.html" title="TMT Executive Software Documentation" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../../index.html" title="TMT Executive Software Documentation">
TMT Executive Software Documentation
</a>
</label>
<ul>
  <li><a href="../../../esw/eswOverview.html" class="page">Executive Software Overview</a></li>
  <li><a href="../../../sequencersandscripts/seq-index.html" class="page">Sequencers and Sequence Components</a>
  <ul>
    <li><a href="../../../sequencersandscripts/sequencer.html" class="page">Sequencers in the Executive Software</a></li>
    <li><a href="../../../sequencersandscripts/sequencer-app.html" class="page">Running a Sequencer Using esw-ocs-app</a></li>
  </ul></li>
  <li><a href="../../../scripts/scripts-index.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../../../scripts/script-styles.html" class="page">Sequencer Script Styles</a></li>
    <li><a href="../../../scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../../../scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../../../uisupport/uisupp-index.html" class="page">User Interface Support</a>
  <ul>
    <li><a href="../../../uisupport/UIOverview.html" class="page">User Interfaces in ESW and TMT</a></li>
    <li><a href="../../../uisupport/gatewayUI-template.html" class="page">Using the Gateway-only UI Template and Tutorial</a></li>
    <li><a href="../../../uisupport/webapp-template.html" class="page">Using the Web Application Template and Tutorial</a></li>
    <li><a href="../../../uisupport/gateway.html" class="page">User Interface Gateway</a></li>
  </ul></li>
  <li><a href="../../../technical/apps/apps-index.html" class="page">ESW Applications</a>
  <ul>
    <li><a href="../../../technical/apps/getting-apps.html" class="page">Getting and Running ESW Applications</a></li>
    <li><a href="../../../technical/apps/esw-shell.html" class="page">ESW Shell - A Testing Environment for ESW and CSW</a></li>
    <li><a href="../../../technical/apps/sequence-manager-app.html" class="page">Starting the Sequence Manager Application</a></li>
    <li><a href="../../../technical/apps/agent-service-app.html" class="page">The Agent Service Application</a></li>
    <li><a href="../../../technical/apps/agent-app.html" class="page">The Agent Application</a></li>
    <li><a href="../../../uisupport/gateway-app.html" class="page">Running the UI Gateway App</a></li>
    <li><a href="../../../technical/apps/esw-services.html" class="page">Running Multiple ESW Applications with esw-services</a></li>
    <li><a href="../../../technical/apps/eng-ui.html" class="page">ESW OCS Engineering User Interface User Manual</a></li>
  </ul></li>
  <li><a href="../../../technical/tech-index.html" class="page">Technical Design Documents</a>
  <ul>
    <li><a href="../../../technical/sequence-manager-tech.html" class="page">Sequence Manager Technical Documentation</a></li>
    <li><a href="../../../technical/sequencer-tech.html" class="page">Sequencer Technical Documentation</a></li>
    <li><a href="../../../technical/sequence-component-tech.html" class="page">Sequence Component Technical Documentation</a></li>
    <li><a href="../../../technical/gateway-tech.html" class="page">Gateway Technical Documentation</a></li>
    <li><a href="../../../technical/agent-service-tech.html" class="page">Agent Service and Agent Technical Documentation</a></li>
    <li><a href="../../../technical/esw-application-parts.html" class="page">ESW Application Architecture</a></li>
    <li><a href="../../../technical/contracts.html" class="page">Service Contracts</a></li>
    <li><a href="../../../technical/testing-philosophy.html" class="page">OSW Testing Philosophy</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../scripts/dsl/constructs/fsm.html#finite-state-machines" class="header">Finite State Machines</a>
  <ul>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#define-a-fsm" class="header">Define a FSM</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#start-fsm" class="header">Start FSM</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#wait-for-completion" class="header">Wait for Completion</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#reactive-fsm" class="header">Reactive FSM</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#example-fsm" class="header">Example FSM</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.6.0-M1
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../scripts/dsl/constructs/fsm.html#finite-state-machines" class="header">Finite State Machines</a>
  <ul>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#define-a-fsm" class="header">Define a FSM</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#start-fsm" class="header">Start FSM</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#wait-for-completion" class="header">Wait for Completion</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#reactive-fsm" class="header">Reactive FSM</a></li>
    <li><a href="../../../scripts/dsl/constructs/fsm.html#example-fsm" class="header">Example FSM</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#finite-state-machines" name="finite-state-machines" class="anchor"><span class="anchor-link"></span></a>Finite State Machines</h1>
<p>Scripts have ability to define, include, and run <a href="https://en.wikipedia.org/wiki/Finite-state_machine" title="Finite State Machine (FSM)">Finite State Machine (FSM)</a>. FSM can transition between defined states and can be made reactive to Events and Commands.</p>
<h2><a href="#define-a-fsm" name="define-a-fsm" class="anchor"><span class="anchor-link"></span></a>Define a FSM</h2>
<h3><a href="#create-the-fsm" name="create-the-fsm" class="anchor"><span class="anchor-link"></span></a>Create the FSM</h3>
<p>To create an instance of an FSM, a helper method <code>Fsm</code> is provided as shown in example. This method takes following parameters:</p>
<ol>
  <li><code>name</code> of FSM</li>
  <li><code>initial state</code> of the FSM</li>
  <li><code>block</code> having states of the FSM</li>
</ol>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L19-L21" target="_blank" title="Go to snippet source">source</a><code class="language-kts">val irisFsm: Fsm = Fsm(name = &quot;iris-fsm&quot;, initState = &quot;INIT&quot;) {
    // place to define all states of FSM
}</code></pre></dd>
</dl>
<h3><a href="#define-state" name="define-state" class="anchor"><span class="anchor-link"></span></a>Define State</h3>
<p>As mentioned above, the third parameter of <code>Fsm</code> method is a block which is the place to define all the states of the FSM. A method named <code>state</code> needs to be called with parameters <code>name</code> of the state and the <code>block</code> of actions to be performed in that state.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L99-L101" target="_blank" title="Go to snippet source">source</a><code class="language-kts">state(&quot;INIT&quot;) {
    // actions to be performed in this state
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">State names</div>
<ol>
  <li>State names are <strong>case-insensitive</strong>.</li>
  <li>In case of multiple states with same name, the last one will be considered.</li>
</ol></div>
<h3><a href="#state-transition" name="state-transition" class="anchor"><span class="anchor-link"></span></a>State Transition</h3>
<p>To transition between states, the <code>become</code> method needs to be called with name of <em>next state</em>. This will <strong>change the state of the FSM to the next state and start executing it</strong>. An <code>InvalidStateException</code> will be thrown if the provided next state is not defined.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L119" target="_blank" title="Go to snippet source">source</a><code class="language-kts">become(state = &quot;IN-PROGRESS&quot;)</code></pre></dd>
</dl><div class="callout warning "><div class="callout-title">Caution with Become</div>
<p>State transition should ideally be the <strong>last call in state</strong> or should be <strong>done with proper control flow</strong> so that become is <strong>not called multiple times</strong>.</p></div>
<p>Along with changing state, it is also possible to pass <em>Params</em> from the current state to the next state. Params can be given to <em>become</em> as the last argument, which will then be injected in the next state as a parameter.</p>
<p>In the case where <strong>state transition does not happen</strong> while executing a state, the <strong>FSM will stay in the same state</strong> and any re-evaluation of the FSM after that will execute the same state until a state transition happens. The <a href="fsm.html#reactive-fsm">reactive variables</a> plays an important role in this as they are the way to re-evaluate the FSM state.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L131-L142" target="_blank" title="Go to snippet source">source</a><code class="language-kts">state(&quot;LOW&quot;) {
    on(temparature.first() &lt; 20) {
        // do something but state transition does not happen
    }

    on(temparature.first() &gt;= 20) {
        // do something and transit state
        become(&quot;HIGH&quot;)
    }
}</code></pre></dd>
</dl>
<p>In the example above, the FSM is in LOW state. If the temperature is below 20, then there won&rsquo;t be any state transition, and the FSM remain in the LOW state. A change in temperature after that will re-evaluate the &ldquo;LOW&rdquo; state again and if the temperature is greater than or equal to 20, then current state will change to HIGH. In the example <code>temperature</code> is an <a href="fsm.html#event-based-variables">event based variable</a> which enables re-evaluation of the current state on changes in temperature value.</p>
<h3><a href="#complete-fsm" name="complete-fsm" class="anchor"><span class="anchor-link"></span></a>Complete FSM</h3>
<p><code>completeFsm</code> <strong>marks the FSM as complete</strong>. Calling it will immediately <strong>stop execution of the FSM</strong> and next steps will be ignored. Therefore, it should be called at the end of a state.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L123-L124" target="_blank" title="Go to snippet source">source</a><code class="language-kts">completeFsm()   // will complete the Fsm
// anything after this will not be executed</code></pre></dd>
</dl>
<h3><a href="#fsm-helper-constructs" name="fsm-helper-constructs" class="anchor"><span class="anchor-link"></span></a>FSM Helper Constructs</h3>
<p>The following are some useful FSM constructs. </p>
<ol>
  <li>
    <p><code>entry</code> : executes the given <code>block</code> only when <strong>state transition happens from a different state</strong></p>
    <dl>
      <dt>Kotlin</dt>
      <dd>
      <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L107-L109" target="_blank" title="Go to snippet source">source</a><code class="language-kts">entry {
    // do something
}</code></pre></dd>
    </dl>
  </li>
  <li>
    <p><code>on</code> : executes the given <code>block</code> if the given <code>condition</code> evaluates to <strong>true</strong>. This construct should be used for conditional execution of a task.</p>
    <dl>
      <dt>Kotlin</dt>
      <dd>
      <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L133-L140" target="_blank" title="Go to snippet source">source</a><code class="language-kts">on(temparature.first() &lt; 20) {
    // do something but state transition does not happen
}

on(temparature.first() &gt;= 20) {
    // do something and transit state
    become(&quot;HIGH&quot;)
}</code></pre></dd>
    </dl>
  </li>
  <li>
    <p><code>after</code> : executes the given <code>block</code> after the given <code>duration</code></p>
    <dl>
      <dt>Kotlin</dt>
      <dd>
      <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L113-L115" target="_blank" title="Go to snippet source">source</a><code class="language-kts">after(100.milliseconds) {
    // do something
}</code></pre></dd>
    </dl>
  </li>
</ol>
<h2><a href="#start-fsm" name="start-fsm" class="anchor"><span class="anchor-link"></span></a>Start FSM</h2>
<p>After creating instance of FSM, it needs to be <strong>explicitly started</strong> by calling <code>start</code> on it. This will <strong>start executing the initial state</strong> of the FSM, which is provided while defining the instance.</p><div class="callout warning "><div class="callout-title">Caution</div>
<p>Calling <code>start</code> more than once is not supported and will lead to unpredictable behaviour. </p></div>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L25" target="_blank" title="Go to snippet source">source</a><code class="language-kts">irisFsm.start()</code></pre></dd>
</dl>
<h2><a href="#wait-for-completion" name="wait-for-completion" class="anchor"><span class="anchor-link"></span></a>Wait for Completion</h2>
<p>As an FSM has the ability to be complete itself, <code>await</code> can be called to <strong>wait for the FSM completion</strong>. <strong>Execution will be paused</strong> at the <code>await</code> statement until the FSM is marked complete.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L29" target="_blank" title="Go to snippet source">source</a><code class="language-kts">irisFsm.await()</code></pre></dd>
</dl>
<p>Calling <code>await</code> before calling <code>start</code> will start the FSM internally and then wait for completion.</p>
<h2><a href="#reactive-fsm" name="reactive-fsm" class="anchor"><span class="anchor-link"></span></a>Reactive FSM</h2>
<p>Reactive FSM means that changes of state can be tied to change in Events as well as Commands. An FSM can be made to react to change in Event and Command parameters with the help of <code>Event based variables</code> and <code>Command flags</code>. This reaction is called &ldquo;re-evaluation&rdquo;, which causes the code for the current state to be executed again. It is necessary to <em>bind</em> an FSM to reactive variables to achieve the reactive behavior.</p>
<h3><a href="#event-based-variables" name="event-based-variables" class="anchor"><span class="anchor-link"></span></a>Event-based variables</h3>
<p>Event-based variables are the way to make an FSM react to CSW Events. They are linked to Events (or Parameters of Events) and are then bound to an FSM such that when the value of the linked Event (or Parameter) changes, the FSM is re-evaluated. Event-based variables can be used to share data between multiple sequencers using Events.</p>
<p>There are two types of Event-based variables.</p>
<h4><a href="#eventvariable" name="eventvariable" class="anchor"><span class="anchor-link"></span></a>EventVariable</h4>
<p>An <code>EventVariable</code> will be tied to an Event published on the given EventKey. The example below shows creating an instance of an EventVariable, and the <em>getEvent</em> method which returns the latest event. </p>
<p>An EventVariable needs 2 parameters:</p>
<ul>
  <li><em>event key</em>: specifies which Event to tie the variable to</li>
  <li><em>duration</em>: (optional) polling period for updating the value of the Event (Significance of duration parameter is explained <a href="fsm.html#poll">below</a>.)</li>
</ul>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L35-L38" target="_blank" title="Go to snippet source">source</a><code class="language-kts">val eventVariable: EventVariable = EventVariable(&quot;ESW.IRIS_darkNight.temperature&quot;)

eventVariable.getEvent() // to get the latest Event</code></pre></dd>
</dl>
<h4><a href="#paramvariable" name="paramvariable" class="anchor"><span class="anchor-link"></span></a>ParamVariable</h4>
<p>A <code>ParamVariable</code> will be tied to a specific Parameter Key of an Event published on given EventKey The example below shows creating an instance of a ParamVariable and the usage of other helper methods. </p>
<p>A ParamVariable takes 4 parameters:</p>
<ul>
  <li><em>initial</em>: initial value for the Parameter. The value of the parameter in the Event is updated when the ParamVariable is created.</li>
  <li><em>event key</em>: specifies the Event with the linked Parameter</li>
  <li><em>param Key</em>: specifies which Parameter to tie the variable to</li>
  <li><em>duration</em>: (optional) polling period for updating the value of the Parameter (Significance of duration parameter is explained <a href="fsm.html#poll">below</a>.)</li>
</ul>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L51-L58" target="_blank" title="Go to snippet source">source</a><code class="language-kts">val paramVariable: ParamVariable&lt;Int&gt; = ParamVariable(0, &quot;ESW.temperature.temp&quot;, tempKey)

paramVariable.getParam() // to get the current values of the parameter
paramVariable.first() // to get the first value from the values of the parameter
paramVariable.setParam(10, 11) // publishes the given values on event key

paramVariable.getEvent() // to get the latest Event</code></pre></dd>
</dl>
<p>To make the FSM react to Event-based variables, we need to create an instance of the above event based variables and <strong>bind the FSM</strong> to it.</p>
<p>An FSM can be bound to multiple variables and vice versa.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L63" target="_blank" title="Go to snippet source">source</a><code class="language-kts">eventBasedVariable.bind(irisFsm)</code></pre></dd>
</dl>
<p>Event-based variables have the <strong>ability to behave in one of two ways</strong>:</p>
<ul>
  <li>Subscribe to the Events getting published</li>
  <li>Poll for a new event with a specified period</li>
</ul>
<h4><a href="#subscribe-to-an-event" name="subscribe-to-an-event" class="anchor"><span class="anchor-link"></span></a>Subscribe to an Event</h4>
<p>If the <code>duration</code> parameter of an Event-based variable is <strong>not</strong> specified, a subscription is made to the Event, and the value is updated (and the current state of the FSM is re-evaluated) whenever it is published. </p>
<p>The following example shows how to create Event Variables with the subscribing behavior and <code>bind</code> FSM to it.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L33-L67" target="_blank" title="Go to snippet source">source</a><code class="language-kts">// ------------ EventVariable ---------------
val eventVariable: EventVariable = EventVariable(&quot;ESW.IRIS_darkNight.temperature&quot;)
eventVariable.bind(irisFsm)

// ------------ ParamVariable ---------------
val tempKey: Key&lt;Int&gt; = intKey(&quot;temperature&quot;)

val paramVariable: ParamVariable&lt;Int&gt; = ParamVariable(0, &quot;ESW.temperature.temp&quot;, tempKey)
paramVariable.bind(irisFsm) // binds the FSM and event variable</code></pre></dd>
</dl>
<h4><a href="#poll" name="poll" class="anchor"><span class="anchor-link"></span></a>Poll</h4>
<p>If it is preferable to have the FSM re-evaluated at a constant periodic rate regardless of when new Events are published, polling behavior can be used by specifying the <code>duration</code> parameter when creating the Event-based variable. This can be useful when the publisher is too fast and there is no need respond so quickly to it.</p>
<p>The example code demonstrates this feature. The binding part is same as in previous example. </p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L47-L80" target="_blank" title="Go to snippet source">source</a><code class="language-kts">val tempKey: Key&lt;Int&gt; = intKey(&quot;temperature&quot;)

// ------------ ParamVariable ---------------
val pollingParamVar: ParamVariable&lt;Int&gt; =
        ParamVariable(0, &quot;ESW.temperature.temp&quot;, tempKey, 2.seconds)

pollingParamVar.bind(irisFsm)

// ------------ EventVariable ---------------
val pollingEventVar = EventVariable(&quot;ESW.IRIS_darkNight.temperature&quot;, 2.seconds)
pollingEventVar.bind(irisFsm)</code></pre></dd>
</dl>
<h3><a href="#commandflag" name="commandflag" class="anchor"><span class="anchor-link"></span></a>CommandFlag</h3>
<p>Command Flag acts as bridge that can be used to pass <code>Parameters</code> to an FSM from outside (i.e. via a Command Handler). A Command Flag can be defined in a scope accessible by a Command Handler and the FSM, and then be bound to the FSM. This causes the FSM to re-evaluate whenever the value of the Command Flag changes, which occurs when the <code>set</code> method is called in the Command Flag (which can be placed in a Command Handler, see <a href="fsm.html#example-fsm">example below</a>).</p>
<p>A Command Flag can be bound to multiple FSMs, and multiple Command Flags can be bound to a single FSM. A Command Flag is limited to the scope of a single script. It does not have any effect on external scripts.</p>
<p>The following example shows how to create a <code>CommandFlag</code>, <code>bind</code> an FSM to it, and use the methods <code>get</code> and <code>set</code> to retrieve and set the value of parameters in the Command Flag.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L84-L91" target="_blank" title="Go to snippet source">source</a><code class="language-kts">val flag = CommandFlag()
flag.bind(irisFsm) // bind the FSM and command flag

onSetup(&quot;setup-command&quot;) { command -&gt;
    flag.set(command.params) // will set params and refreshes the bound FSMs with the new params
}

val params = flag.value() // extract the current params value in FSM</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<ul>
  <li>Binding FSM to reactive variables can be done anytime in the lifecycle of FSM not only before starting it. Doing it after completion of FSM does not do anything.</li>
  <li><strong>Binding is necessary to achieve the reactive behavior</strong>.</li>
</ul></div>
<h2><a href="#example-fsm" name="example-fsm" class="anchor"><span class="anchor-link"></span></a>Example FSM</h2>
<p>In the below example, <code>temparatureFsm</code> demonstrates how to define and use FSM in the scripts. The Event-based variable is declared with the Event key <code>esw.temperature.temp</code> and parameter <code>temperature</code>, and the <code>temperatureFsm</code> is bound to it. The job of the <code>temperatureFsm</code> is to decide the <code>state</code> based on the <code>temperature</code> and publish it on the EventKey <code>esw.temperatureFsm</code> with the ParamKey <code>state</code>. The state is determined by comparing the &ldquo;current temperature&rdquo; (obtained from a ParamVariable) with the &ldquo;temperatureLimit&rdquo;, which defaults to 40, but can be updated using the Setup command &ldquo;changeTemperatureLimit&rdquo;.</p>
<p>THe logic of state change is:</p>
<table>
  <thead>
    <tr>
      <th align="center">condition </th>
      <th align="center">state </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="center">temp == 30 </td>
      <td align="center">FINISH </td>
    </tr>
    <tr>
      <td align="center">temp &gt; tempLimit </td>
      <td align="center">ERROR </td>
    </tr>
    <tr>
      <td align="center">else </td>
      <td align="center">OK </td>
    </tr>
  </tbody>
</table>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/FsmExample.kts#L12-L102" target="_blank" title="Go to snippet source">source</a><code class="language-kts"><br/>// method to publish the state of the FSM
val stateKey = stringKey(&quot;state&quot;)
val tempFsmEvent = SystemEvent(&quot;esw.temperatureFsm&quot;, &quot;state&quot;)
suspend fun publishState(baseEvent: SystemEvent, state: String) =
        publishEvent(baseEvent.add(stateKey.set(state)))

// temperature Fsm states
val OK = &quot;OK&quot;
val ERROR = &quot;ERROR&quot;
val FINISHED = &quot;FINISHED&quot;

// Event-based variable for current temperature
val tempKey = longKey(&quot;temperature&quot;)
val temperatureVar = ParamVariable(0, &quot;esw.temperature.temp&quot;, tempKey)

// CommandFlag, and method to get expected temperature from it
val commandFlag = CommandFlag()
fun getTemperatureLimit(defaultTemperatureLimit: Int): Int {
    val tempLimitParameter = commandFlag.value().get(intKey(&quot;temperatureLimit&quot;))
    return if (tempLimitParameter.isDefined)
        tempLimitParameter.get().first
    else
        defaultTemperatureLimit
}

// key for parameter passed to Error state from Ok state
val deltaKey = longKey(&quot;delta&quot;)

// FSM definition
val temperatureFsm = Fsm(&quot;TEMP&quot;, OK) {
    val initialTemperatureLimit = 40                         // [[ 1 ]]

    state(OK) {
        val currentTemp = temperatureVar.first()             // [[ 2 ]]
        val tempLimit = getTemperatureLimit(initialTemperatureLimit)

        entry {
            publishState(tempFsmEvent, OK)                   // [[ 3 ]]
        }
        on(currentTemp == 30L) {
            become(FINISHED)                                 // [[ 4 ]]
        }
        on(currentTemp &gt; tempLimit) {
            val deltaParam = deltaKey.set(currentTemp - tempLimit)
            become(ERROR, Params(setOf(deltaParam)))         // [[ 5 ]]
        }
        on(currentTemp &lt;= tempLimit) {
            info(&quot;temperature is below expected threshold&quot;,
                    mapOf(&quot;limit&quot; to tempLimit, &quot;current&quot; to currentTemp)
            )
        }
    }

    state(ERROR) { params -&gt;
        val tempLimit = getTemperatureLimit(initialTemperatureLimit)

        entry {
            info(&quot;temperature is above expected threshold&quot;,
                    mapOf(&quot;limit&quot; to tempLimit, &quot;delta&quot; to params(deltaKey).first)
            )
            publishState(tempFsmEvent, ERROR)
        }
        on(temperatureVar.first() &lt; tempLimit) {
            become(OK)
        }
    }

    state(FINISHED) {
        completeFsm()                                        // [[ 6 ]]
    }
}

// bind reactives to FSM
temperatureVar.bind(temperatureFsm)
commandFlag.bind(temperatureFsm)                             // [[ 7 ]]

// Command handlers
onSetup(&quot;startFSM&quot;) {
    temperatureFsm.start()                                   // [[ 8 ]]
}

onSetup(&quot;changeTemperatureLimit&quot;) { command -&gt;
    commandFlag.set(command.params)                          // [[ 9 ]]
}

onSetup(&quot;waitForFSM&quot;) {
    temperatureFsm.await()                                   // [[ 10 ]]
    info(&quot;FSM is no longer running.&quot;)
}
</code></pre></dd>
</dl>
<p>Full example code is available <a href="https://github.com/tmtsoftware/esw/blob/v0.6.0-M1/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/FsmExample.kts">here</a>.</p>
<p>Key things in above example code are :</p>
<ul>
  <li><code>[[ 1 ]]</code>: Shows <strong>top-level scope of the FSM which can used to declare variables</strong> in FSM&rsquo;s scope and statements which should be executed while starting the FSM. Statements written here will be executed only once when the FSM starts.</li>
  <li><code>[[ 2 ]]</code>: The scope of the state. Statements written here will be executed on every evaluation of the state. So variables declared here will be reinitialized whenever state is re-evaluated. In the above case, <em>tempLimit</em> and <em>currentTemp</em> will be initialized every time the OK state is evaluated.</li>
  <li><code>[[ 3 ]]</code>: The code in the entry block is only executed when first transitioning to this state. Therefore, state will not be published repeatedly.</li>
  <li><code>[[ 4 ]]</code>: State transitions from <code>OK</code> state to <code>FINISHED</code>.</li>
  <li><code>[[ 5 ]]</code>: State transitions from <code>OK</code> state to <code>ERROR</code> with a <em>Params</em> set containing the delta temperature. The ERROR state shows how to consume Params in a state.</li>
  <li><code>[[ 6 ]]</code>: Marks the FSM complete. Re-evaluation or state transitions cannot happen after this is executed.</li>
  <li><code>[[ 7 ]]</code>: Shows the binding <code>temperatureFsm</code> to <code>temperatureVar</code> and <code>commandFlag</code>. After this point, a running FSM will re-evaluate whenever events are published on <code>temperatureVar</code>.</li>
  <li><code>[[ 8 ]]</code>: Starts <strong>evaluating the initial state</strong> of the FSM. Until this is called the code in the <code>Fsm</code> block only specifies the FSM functionality. However, note that the initialization code in the top-level scope of the FSM is executed (item <code>[[ 1 ]]</code>) on construction.</li>
  <li><code>[[ 9 ]]</code>: Updates the Params of the <code>CommandFlag</code>. In our example, we are using those params to specify the temperature limit.</li>
  <li><code>[[ 10 ]]</code>: Waits for completion of the FSM. In our example, the script execution will be blocked until the <code>completeFsm</code> method is called in <code>[[ 6 ]]</code>, which occurs when switching to the FINISHED state. Any code after the <code>await</code> call will execute after the FSM is completed.</li>
</ul>
<p>Example code also demos the use of the <a href="fsm.html#fsm-helper-constructs">helper constructs</a> like <code>entry</code>, <code>on</code>.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/scripts/dsl/constructs/fsm.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.6.0-M1
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../scripts/dsl/constructs/loop.html" title="Including Looping in Scripts" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Including Looping in Scripts
</span>
</div>
</a>
<a href="../../../scripts/dsl/constructs/blocking.html" title="Blocking Operations Within Script" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Blocking Operations Within Script
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
