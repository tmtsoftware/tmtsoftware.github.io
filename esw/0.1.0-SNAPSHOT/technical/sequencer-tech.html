<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Sequencer Technical Documentatation Â· TMT Executive Software Documentation</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Executive Software Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software Documentation
</span>
<span class="md-header-nav__topic">
Sequencer Technical Documentatation
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Executive Software Documentation" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Executive Software Documentation">
TMT Executive Software Documentation
</a>
</label>
<ul>
  <li><a href="../esw/eswOverview.html" class="page">Executive Software Overview</a></li>
  <li><a href="../sequencersandscripts/seq-index.html" class="page">Sequencers and Sequence Components</a>
  <ul>
    <li><a href="../sequencersandscripts/sequencer.html" class="page">Sequencers in the Executive Software</a></li>
    <li><a href="../sequencersandscripts/sequencer-app.html" class="page">Running a Sequencer Using ocs-app</a></li>
  </ul></li>
  <li><a href="../scripts/scripts-index.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../scripts/script-styles.html" class="page">Sequencer Script Styles</a></li>
    <li><a href="../scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../uisupport/uisupp-index.html" class="page">User Interface Support</a>
  <ul>
    <li><a href="../uisupport/UIOverview.html" class="page">User Interfaces in ESW and TMT</a></li>
    <li><a href="../uisupport/frontend-template.html" class="page">Creating and Using the Frontend UI Template</a></li>
    <li><a href="../uisupport/backend-template.html" class="page">Creating and Using the UI Backend Template</a></li>
    <li><a href="../uisupport/gateway.html" class="page">User Interface Gateway</a></li>
  </ul></li>
  <li><a href="../technical/tech-index.html" class="page">Technical Design Documents</a>
  <ul>
    <li><a href="../technical/sequence-manager-tech.html" class="page">Sequence Manager Technical Documentation</a></li>
    <li><a href="../technical/sequencer-tech.html" class="active page">Sequencer Technical Documentatation</a></li>
    <li><a href="../technical/sequence-component-tech.html" class="page">Sequence Component Technical Documentation</a></li>
    <li><a href="../technical/gateway-tech.html" class="page">Gateway Technical Documentation</a></li>
    <li><a href="../technical/contracts.html" class="page">Service Contracts</a></li>
    <li><a href="../technical/agent-service-tech.html" class="page">Agent Service and Agent Technical Documentation</a></li>
    <li><a href="../technical/apps/apps-index.html" class="page">Applications</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../technical/sequencer-tech.html#sequencer-technical-documentatation" class="header">Sequencer Technical Documentatation</a>
  <ul>
    <li><a href="../technical/sequencer-tech.html#modules" class="header">Modules</a></li>
    <li><a href="../technical/sequencer-tech.html#sequencer-interfaces" class="header">Sequencer Interfaces</a></li>
    <li><a href="../technical/sequencer-tech.html#implementation-details" class="header">Implementation Details</a></li>
    <li><a href="../technical/sequencer-tech.html#running-sequencer" class="header">Running Sequencer</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../technical/sequencer-tech.html#sequencer-technical-documentatation" class="header">Sequencer Technical Documentatation</a>
  <ul>
    <li><a href="../technical/sequencer-tech.html#modules" class="header">Modules</a></li>
    <li><a href="../technical/sequencer-tech.html#sequencer-interfaces" class="header">Sequencer Interfaces</a></li>
    <li><a href="../technical/sequencer-tech.html#implementation-details" class="header">Implementation Details</a></li>
    <li><a href="../technical/sequencer-tech.html#running-sequencer" class="header">Running Sequencer</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#sequencer-technical-documentatation" name="sequencer-technical-documentatation" class="anchor"><span class="anchor-link"></span></a>Sequencer Technical Documentatation</h1>
<p>Sequencer is OMOA component which has responsibility of executing Sequence of Steps. In an observation, Sequencers will form a hierarchy where with a top-level ESW Sequencer sending Sequences to downstream Sequencers and downstream Sequencers sending commands to Assemblies/HCDs.</p>
<p>The Sequencer implementation has two main parts:</p>
<ol>
  <li>Sequencer Framework</li>
  <li>Scripting Support</li>
</ol>
<p>Sequencer Framework uses an Akka Actor at a core and is responsible for executing the received Sequence and calling handlers in the Script. Sequencer Scripting Support defines behaviour of Sequencer while executing Sequence. Scripts are written using Domain Specific Language provided as a part of Framework.</p>
<h2><a href="#modules" name="modules" class="anchor"><span class="anchor-link"></span></a>Modules</h2>
<ul>
  <li>
  <p>esw-ocs-api - This is cross-compiled module, which is compiled into JVM as well as JavaScript code. This module includes <code>SequencerApi</code> which defines an interface for Sequencer. This module also consists of core models, actor client, JVM and JavaScript client for Sequencer.</p></li>
  <li>
  <p>esw-ocs-impl - This module consists of the core implementation of Sequencer the actor which is <code>SequencerBehaviour</code> (Sequencer Actor), Engine and SequencerData.</p></li>
  <li>
  <p>esw-ocs-app - This module consists of wiring as well as cli application to start Sequencer. The wiring integrates Sequencer into the rest of the ESW/CSW environment.</p></li>
  <li>
  <p>esw-ocs-dsl - This module consists of Scala implementation supporting the Script DSL.</p></li>
  <li>
  <p>esw-ocs-dsl-kt - This module consists of Kotlin counterpart of the Script DSL.</p></li>
  <li>
  <p>esw-ocs-handler - This handler module is responsible for providing HTTP routes for Sequencer HTTP server. Sequencer provides an HTTP and Akka interface. The HTTP routes are defined and implemented here.</p></li>
</ul>
<h2><a href="#sequencer-interfaces" name="sequencer-interfaces" class="anchor"><span class="anchor-link"></span></a>Sequencer Interfaces</h2>
<p>Sequencer exposes its interface in three ways:</p>
<ol>
  <li>Akka interface - Sequencer is registered as an Akka-based component. One can resolve Sequencer and use the Akka client to interact with Sequencer.</li>
  <li>HTTP direct interface - Each Sequencer also exposes an HTTP-based interface as an embedded Sequencer Server (direct and unprotected usage). This access provides routes that allow user to directly control the Sequencer without any auth protection. UI applications are supposed to use Gateway interface described below to interact with Sequencer as Gateway provided auth protection layer.</li>
  <li>HTTP Gateway interface - It is also possible to interact with Sequencer using the UI Application Gateway (as public interface). Being public interface, this access requires user to be authenticated and authorized. The Gateway hosts the Sequencer API, which communicates with the Sequencer via the Akka interface. Please refer to the Gateway documentation for <a href="../uisupport/gateway.html">more information</a>.</li>
</ol>
<h2><a href="#implementation-details" name="implementation-details" class="anchor"><span class="anchor-link"></span></a>Implementation Details</h2>
<p>Sequencer framework uses Akka Actor as core implementation (Sequencer Actor). The following figure explains the architecture of the Sequencer framework. Sequencer is registered with Location Service. The future SOSS Planning Tool or ESW.HCMS Script Monitoring Tool will use the Location of the top-level Sequencer returned by Sequence Manager to resolve the top-level Sequencer, and will send the Observation&rsquo;s Sequence to top-level Sequencer. Once the Sequence is started, Engine continuously polls for a next step as soon as the previous step is finished with success. It will execute the step using the appropriate handler written in the Script. If any step in Sequence fails, the Sequence is terminated with Error, and an Error is returned to the caller. The submission of a Sequence to the Sequencer uses CSW Command Service (i.e. submit, submitAndWait, etc.).</p>
<p>Engine and Sequencer Actor are core parts of Framework. The framework part is the same for every Sequencer, but the Script can vary. The Script defines the behaviour of the Sequencer for each step within a Sequence.</p>
<p><img src="../images/ocs/sequencer.png" alt="Sequencer Architecture" /></p>
<p>The following sections explain the core components of Sequencer:</p>
<ol>
  <li>Sequencer Lifecycle</li>
  <li>Scripting Support</li>
</ol>
<h3><a href="#sequencer-lifecycle" name="sequencer-lifecycle" class="anchor"><span class="anchor-link"></span></a>Sequencer Lifecycle</h3>
<p>The Sequencer lifecycle is implemented as a fairly complicated finite state machine as shown in the figure below. This Section explains the different states and messges accepted in each respective state of Sequencer. At any given time a Sequencer is in exactly one of these states. The state of the Sequencer is tied to whether or not it has received a Sequence and whether or not the Sequence has started executing. Sequencer supports a set of commands/messages, and on receiving those commands, it takes an action and transitions to other states.</p>
<p>Following are the states supported by the Sequencer:</p>
<ul>
  <li><strong>Idle/Online:</strong> This is the default state of the Sequencer. A Sequencer is idle when it is starts up. It has a Script since it has been loaded/created by the Sequence Component, but there is no Sequence under execution. A Sequencer can come to the idle state from the following situations:
    <ul>
      <li>when the Sequencer starts up for the first time with a Script loaded</li>
      <li>when the Sequencer has finished execution of a Sequence</li>
      <li>when the Sequencer was offline, and a goOnline command is received</li>
    </ul>
  </li>
</ul>
<p>In this state, the Sequencer can only receive a Sequence, <code>goOffline</code>, or <code>shutdown</code>, in which the Sequencer transitions to the <code>Loaded</code>, <code>Offline</code>, and <code>Killed</code> states, respectively.</p>
<ul>
  <li>
  <p><strong>Loaded:</strong> A Sequencer is in loaded state when a Sequence is received and ready for execution, but execution of the Sequence hasn&rsquo;t started. A separate <code>start</code> command is expected to start execution of the Sequence. All sequence editor actions (for e.g. add, remove, reset) are accepted in this state. From this state, the Sequencer can go to the <code>InProgress</code> state on receiving a <code>start</code> command, or it could go to the <code>Offline</code> state if <code>goOffline</code> command is sent. On receiving a <code>reset</code> command, which discards all the pending steps, the Sequencer will go to <code>Idle</code> state.</p></li>
  <li>
  <p><strong>InProgress/Running:</strong> The Sequencer is in the <code>Running</code> state only when it is executing a Sequence. All sequence editor actions (for e.g. add, remove, reset) are accepted in this state. From the <code>Running</code> state, the Sequencer can go to <code>Idle</code> state on completion of a Sequence, or it can be <code>shutdown</code>. A Sequencer cannot go <code>Offline</code> from this state; the Sequencer must first to go to the <code>Idle</code> state and then <code>Offline</code>.</p></li>
  <li>
  <p><strong>Offline:</strong> The Sequencer goes to the <code>Offline</code> state only on receiving a <code>goOffline</code> command, which can either come from an upstream Sequencer, or from a user through the admin dashboard. In this state, only a few commands are excepted (for eg. goOnline, shutdown, status etc).</p></li>
  <li>
  <p><strong>Killed:</strong> This is the final state of the Sequencer, achieved when receiving a <code>shutdown</code> command. The shutdown command can be sent in any state, hence a Sequencer can transition to this state from any other state. However, a Sequencer doesn&rsquo;t stay in this state long; when a Sequencer is killed, it is removed from the Location Service, and ActorSystem is shutdown, effectively destroying the Sequencer.</p></li>
</ul>
<p><img src="../images/ocs/state-transition.png" alt="sequencer-state-transition" /></p>
<h3><a href="#scripting-support" name="scripting-support" class="anchor"><span class="anchor-link"></span></a>Scripting Support</h3>
<p>Sequencer Scripts are the most important part of the Sequencer architecture. The scripting environment has following core requirements:</p>
<p><strong>Domain Specific Language</strong> (DSL) constructs for writing Scripts. For example, <code>par</code> to execute commands in parallel, <code>onSetup</code> like constructs where the script writer will define logic to be executed when <code>Setup</code> steps are processed. Kotlin has been used to create the DSL for writing a Script. Kotlin has excellent language support for writing an embedded DSL. Kotlin also has excellent support for asynchronous processing/tasks that allows a more script-like syntax for the kinds of things ESW Scripts need to do.</p>
<p><strong>Mutable State within the script</strong> To handle mutable state in thread safe manner, Script is implemented using the Active Object Pattern. Every operation in a Script needs to be asynchronous and non-blocking in nature, and each operation will be scheduled on Single Threaded Execution Context (StrandEC). This ensures that state inside the Script can be accessed/modified at any place inside with the guarantee of thread safety. If there is need to have CPU intensive or blocking operations in Script, patterns supporting these needs to be followed which uses another Execution Context so that Script StrandEC is not blocked. The scripting DSL provides special constructs for background processing.</p>
<h2><a href="#running-sequencer" name="running-sequencer" class="anchor"><span class="anchor-link"></span></a>Running Sequencer</h2>
<p>For running Sequencer Script, please refer <a href="../sequencersandscripts/sequencer-app.html">this</a>.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/technical/sequencer-tech.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../technical/sequence-manager-tech.html" title="Sequence Manager Technical Documentation" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Sequence Manager Technical Documentation
</span>
</div>
</a>
<a href="../technical/sequence-component-tech.html" title="Sequence Component Technical Documentation" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Sequence Component Technical Documentation
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
