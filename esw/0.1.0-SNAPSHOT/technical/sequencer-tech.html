<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Sequencer Technical Documentation Â· TMT Executive Software Documentation</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Executive Software Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software Documentation
</span>
<span class="md-header-nav__topic">
Sequencer Technical Documentation
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Executive Software Documentation" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Executive Software Documentation">
TMT Executive Software Documentation
</a>
</label>
<ul>
  <li><a href="../esw/eswOverview.html" class="page">Executive Software Overview</a></li>
  <li><a href="../sequencersandscripts/seq-index.html" class="page">Sequencers and Sequence Components</a>
  <ul>
    <li><a href="../sequencersandscripts/sequencer.html" class="page">Sequencers in the Executive Software</a></li>
    <li><a href="../sequencersandscripts/sequencer-app.html" class="page">Running a Sequencer Using esw-ocs-app</a></li>
  </ul></li>
  <li><a href="../scripts/scripts-index.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../scripts/script-styles.html" class="page">Sequencer Script Styles</a></li>
    <li><a href="../scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../uisupport/uisupp-index.html" class="page">User Interface Support</a>
  <ul>
    <li><a href="../uisupport/UIOverview.html" class="page">User Interfaces in ESW and TMT</a></li>
    <li><a href="../uisupport/gatewayUI-template.html" class="page">Using the Gateway-only UI Template and Tutorial</a></li>
    <li><a href="../uisupport/webapp-template.html" class="page">Using the Web Application Template and Tutorial</a></li>
    <li><a href="../uisupport/gateway.html" class="page">User Interface Gateway</a></li>
    <li><a href="../uisupport/gateway-app.html" class="page">Running the UI Gateway App</a></li>
  </ul></li>
  <li><a href="../technical/apps/apps-index.html" class="page">ESW Applications</a>
  <ul>
    <li><a href="../technical/apps/getting-apps.html" class="page">Getting and Running ESW Applications</a></li>
    <li><a href="../technical/apps/esw-shell.html" class="page">ESW Shell - A Testing Environment for ESW and CSW</a></li>
    <li><a href="../technical/apps/sequence-manager-app.html" class="page">Starting the Sequence Manager Application</a></li>
    <li><a href="../technical/apps/agent-service-app.html" class="page">The Agent Service Application</a></li>
    <li><a href="../technical/apps/agent-app.html" class="page">The Agent Application</a></li>
    <li><a href="../technical/apps/esw-services.html" class="page">Running Multiple ESW Applications with esw-services</a></li>
    <li><a href="../technical/apps/eng-ui.html" class="page">ESW OCS Engineering User Interface User Manual</a></li>
  </ul></li>
  <li><a href="../technical/tech-index.html" class="page">Technical Design Documents</a>
  <ul>
    <li><a href="../technical/sequence-manager-tech.html" class="page">Sequence Manager Technical Documentation</a></li>
    <li><a href="../technical/sequencer-tech.html" class="active page">Sequencer Technical Documentation</a></li>
    <li><a href="../technical/sequence-component-tech.html" class="page">Sequence Component Technical Documentation</a></li>
    <li><a href="../technical/gateway-tech.html" class="page">Gateway Technical Documentation</a></li>
    <li><a href="../technical/agent-service-tech.html" class="page">Agent Service and Agent Technical Documentation</a></li>
    <li><a href="../technical/esw-application-parts.html" class="page">ESW Application Architecture</a></li>
    <li><a href="../technical/contracts.html" class="page">Service Contracts</a></li>
    <li><a href="../technical/testing-philosophy.html" class="page">OSW Testing Philosophy</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../technical/sequencer-tech.html#sequencer-technical-documentation" class="header">Sequencer Technical Documentation</a>
  <ul>
    <li><a href="../technical/sequencer-tech.html#modules" class="header">Modules</a></li>
    <li><a href="../technical/sequencer-tech.html#sequence-execution-process" class="header">Sequence execution process</a></li>
    <li><a href="../technical/sequencer-tech.html#implementation-details" class="header">Implementation Details</a></li>
    <li><a href="../technical/sequencer-tech.html#sequencer-interfaces" class="header">Sequencer Interfaces</a></li>
    <li><a href="../technical/sequencer-tech.html#interacting-with-sequencer" class="header">Interacting with Sequencer</a></li>
    <li><a href="../technical/sequencer-tech.html#running-sequencer" class="header">Running Sequencer</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../technical/sequencer-tech.html#sequencer-technical-documentation" class="header">Sequencer Technical Documentation</a>
  <ul>
    <li><a href="../technical/sequencer-tech.html#modules" class="header">Modules</a></li>
    <li><a href="../technical/sequencer-tech.html#sequence-execution-process" class="header">Sequence execution process</a></li>
    <li><a href="../technical/sequencer-tech.html#implementation-details" class="header">Implementation Details</a></li>
    <li><a href="../technical/sequencer-tech.html#sequencer-interfaces" class="header">Sequencer Interfaces</a></li>
    <li><a href="../technical/sequencer-tech.html#interacting-with-sequencer" class="header">Interacting with Sequencer</a></li>
    <li><a href="../technical/sequencer-tech.html#running-sequencer" class="header">Running Sequencer</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#sequencer-technical-documentation" name="sequencer-technical-documentation" class="anchor"><span class="anchor-link"></span></a>Sequencer Technical Documentation</h1>
<p>Sequencer is OMOA component which has responsibility of executing Sequence of Steps. In an observation, Sequencers will form a hierarchy where with a top-level ESW Sequencer sending Sequences to downstream Sequencers and downstream Sequencers sending commands to Assemblies/HCDs.</p>
<p>The Sequencer implementation has two main parts:</p>
<ol>
  <li>Sequencer Framework</li>
  <li>Scripting Support</li>
</ol>
<p>Sequencer Framework uses an Akka Actor at a core and is responsible for executing the received Sequence and calling handlers in the Script. Sequencer Scripting Support defines behaviour of Sequencer while executing Sequence. Scripts are written using Domain Specific Language provided as a part of Framework.</p>
<h2><a href="#modules" name="modules" class="anchor"><span class="anchor-link"></span></a>Modules</h2>
<ul>
  <li>
  <p>esw-ocs-api - This is cross-compiled module, which is compiled into JVM as well as JavaScript code. This module includes <code>SequencerApi</code> which defines an interface for Sequencer. This module also consists of core models, actor client, JVM and JavaScript client for Sequencer.</p></li>
  <li>
  <p>esw-ocs-impl - This module consists of the core implementation of Sequencer the actor which is <code>SequencerBehaviour</code> (Sequencer Actor), Engine and SequencerData.</p></li>
  <li>
  <p>esw-ocs-app - This module consists of wiring as well as cli application to start Sequencer. The wiring integrates Sequencer into the rest of the ESW/CSW environment.</p></li>
  <li>
  <p>esw-ocs-dsl - This module consists of Scala implementation supporting the Script DSL.</p></li>
  <li>
  <p>esw-ocs-dsl-kt - This module consists of Kotlin counterpart of the Script DSL.</p></li>
  <li>
  <p>esw-ocs-handler - This handler module is responsible for providing HTTP routes for Sequencer HTTP server. Sequencer provides an HTTP and Akka interface. The HTTP routes are defined and implemented here.</p></li>
</ul>
<h2><a href="#sequence-execution-process" name="sequence-execution-process" class="anchor"><span class="anchor-link"></span></a>Sequence execution process</h2>
<h4><a href="#starting-a-sequencer" name="starting-a-sequencer" class="anchor"><span class="anchor-link"></span></a>Starting a Sequencer</h4>
<p>When we do load script from a sequence component, it creates a <a href="https://github.com/tmtsoftware/esw/blob/master/esw-ocs/esw-ocs-app/src/main/scala/esw/ocs/app/wiring/SequencerWiring.scala">Sequencer Wiring</a>. Sequencer Wiring passes the Kotlin script class name as string parameter to <a href="https://github.com/tmtsoftware/esw/blob/master/esw-ocs/esw-ocs-impl/src/main/scala/esw/ocs/impl/script/ScriptLoader.scala">Script Loader</a>, which uses Java reflection APIs to dynamically load script class with given name and create its instance. This loaded script is then passed to an execution <a href="https://github.com/tmtsoftware/esw/blob/master/esw-ocs/esw-ocs-impl/src/main/scala/esw/ocs/impl/core/Engine.scala">Engine</a> which is responsible for processing each step. After initialization, Sequencer&rsquo;s Akka and HTTP connection is registered to Location Service.</p>
<h4><a href="#loading-and-running-a-sequence-in-sequencer" name="loading-and-running-a-sequence-in-sequencer" class="anchor"><span class="anchor-link"></span></a>Loading and Running a sequence in Sequencer</h4>
<ul>
  <li>During initialization of Sequencer, it is set to IDLE state and initialized with empty data in Sequence Data like empty Step List,etc.</li>
  <li>Once initialized, user can either <strong>Load and start a sequence</strong> or <strong>Submit a sequence</strong>, in both cases list of commands will be converted to richer model of list of Steps.
    <ul>
      <li><strong>Load and Start a Sequence</strong>: Using <code>loadSequence</code> api, <code>SequencerData</code>(described below) will be initialized with Sequence Steps.  User can then use <code>startSequence</code> api to start the execution of steps.</li>
      <li><strong>Submit a Sequence</strong>: Using <code>submit</code> / <code>submitAndWait</code> api, <code>SequencerData</code> will be initialized with Sequence Steps, and start the sequence execution.</li>
    </ul>After any of above flow, Sequencer will go into RUNNING state.
  </li>
</ul>
<p><code>SequencerData</code> has different fields as follows:</p>
<ul>
  <li><code>stepList</code> - This will store steps of the Sequence</li>
  <li><code>runId</code> - This is runId of Sequence</li>
  <li><code>sequenceResponseSubscribers</code> - This is a list of Subscribers who is interested in response either by <strong>submitting a sequence</strong> or <strong>querying response</strong>.
    <ul>
      <li>When subscriber has submitted the sequence using <code>submitAndWait</code> API, it will get response once Sequence is completed with Success/Failure</li>
      <li>For other Subscribers(who has not submitted the sequence), they can also get same response using <code>queryFinal</code> API, for this they need to provide runId of Sequence</li>
    </ul>
  </li>
</ul>
<h5><a href="#mapping-between-steps-and-script-handlers" name="mapping-between-steps-and-script-handlers" class="anchor"><span class="anchor-link"></span></a>Mapping between steps and script handlers</h5>
<p>A Kotlin script file contains multiple command names and associated handler blocks with them.</p>
<pre><code>onSetup(&quot;commandName&quot;) { 
  ...handler block of command
}
</code></pre>
<p>When a Script is loaded, <a href="https://github.com/tmtsoftware/esw/blob/master/esw-ocs/esw-ocs-dsl/src/main/scala/esw/ocs/dsl/script/ScriptDsl.scala">ScriptDsl</a> stores all command names with respective handler code blocks, you can think of it like a map with command name as key and handler code block as its value.</p>
<p>The sequence submitted by a client to sequencer contains list of commands that need to be executed. These commands are stored as richer model of steps. When a step is picked for execution by Engine, its corresponding code block is picked from mapping in ScriptDsl and that block is executed.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Engine is a continuous running loop, it pulls next step once current step is finished.</p></div>
<h4><a href="#completion-of-a-sequence" name="completion-of-a-sequence" class="anchor"><span class="anchor-link"></span></a>Completion of a Sequence</h4>
<p>Once every step is executed, it is marked as Finished with Success or Failure. If any of step is Failed, Sequence is terminated and Error response is sent to all Subscribers. If all steps are completed with Success, then Success response is sent to all Subscribers.</p>
<h2><a href="#implementation-details" name="implementation-details" class="anchor"><span class="anchor-link"></span></a>Implementation Details</h2>
<p>Sequencer framework uses Akka Actor as core implementation (Sequencer Actor). The following figure explains the architecture of the Sequencer framework. Sequencer is registered with Location Service. The future SOSS Planning Tool or ESW.HCMS Script Monitoring Tool will use the Location of the top-level Sequencer returned by Sequence Manager to resolve the top-level Sequencer, and will send the Observation&rsquo;s Sequence to top-level Sequencer.</p>
<p>Engine and Sequencer Actor are core parts of Framework. The framework part is the same for every Sequencer, but the Script can vary. The Script defines the behaviour of the Sequencer for each step within a Sequence.</p>
<p><img src="../images/ocs/sequencer.png" alt="Sequencer Architecture" /></p>
<p>The following sections explain the core components of Sequencer:</p>
<ol>
  <li>Sequencer Lifecycle</li>
  <li>Scripting Support</li>
</ol>
<h3><a href="#sequencer-lifecycle" name="sequencer-lifecycle" class="anchor"><span class="anchor-link"></span></a>Sequencer Lifecycle</h3>
<p>The Sequencer lifecycle is implemented as a fairly complicated finite state machine as shown in the figure below. This Section explains the different states and messages accepted in each respective state of Sequencer. At any given time a Sequencer is in exactly one of these states. The state of the Sequencer is tied to whether or not it has received a Sequence and whether the Sequence has started executing. Sequencer supports a set of commands/messages, and on receiving those commands, it takes an action and transitions to other states.</p>
<p>Following are the states supported by the Sequencer:</p>
<ul>
  <li>
  <p><strong>Idle/Online:</strong> This is the default state of the Sequencer. A Sequencer is idle when it is starts up. It has a Script since it has been loaded/created by the Sequence Component, but there is no Sequence under execution. A Sequencer can come to the idle state from the following situations:</p></li>
  <li>
  <p>when the Sequencer starts up for the first time with a Script loaded</p></li>
  <li>when the Sequencer has finished execution of a Sequence</li>
  <li>when the Sequencer was offline, and a goOnline command is received</li>
</ul>
<p>In this state, the Sequencer can only receive a Sequence, <code>goOffline</code>, or <code>shutdown</code>, in which the Sequencer transitions to the <code>Loaded</code>, <code>Offline</code>, and <code>Killed</code> states, respectively.</p>
<ul>
  <li>
  <p><strong>Loaded:</strong> A Sequencer is in loaded state when a Sequence is received and ready for execution, but execution of the Sequence hasn&rsquo;t started. A separate <code>start</code> command is expected to start execution of the Sequence. All sequence editor actions (for e.g. add, remove, reset) are accepted in this state. From this state, the Sequencer can go to the <code>Running</code> state on receiving a <code>start</code> command, or it could go to the <code>Offline</code> state if <code>goOffline</code> command is sent. On receiving a <code>reset</code> command, which discards all the pending steps, the Sequencer will go to <code>Idle</code> state.</p></li>
  <li>
  <p><strong>InProgress/Running:</strong> The Sequencer is in the <code>Running</code> state only when it is executing a Sequence. All sequence editor actions (for e.g. add, remove, reset) are accepted in this state. From the <code>Running</code> state, the Sequencer can go to <code>Idle</code> state on completion of a Sequence, or it can be <code>shutdown</code>. A Sequencer cannot go <code>Offline</code> from this state; the Sequencer must first to go to the <code>Idle</code> state and then <code>Offline</code>.</p></li>
  <li>
  <p><strong>Offline:</strong> The Sequencer goes to the <code>Offline</code> state only on receiving a <code>goOffline</code> command, which can either come from an upstream Sequencer, or from a user through the admin dashboard. In this state, only a few commands are excepted (for eg. goOnline, shutdown, status etc).</p></li>
  <li>
  <p><strong>Killed:</strong> This is the final state of the Sequencer, achieved when receiving a <code>shutdown</code> command. The shutdown command can be sent in any state, hence a Sequencer can transition to this state from any other state. However, a Sequencer doesn&rsquo;t stay in this state long; when a Sequencer is killed, it is removed from the Location Service, and ActorSystem is shutdown, effectively destroying the Sequencer.</p></li>
</ul>
<p><img src="../images/ocs/state-transition.png" alt="sequencer-state-transition" /></p>
<h3><a href="#scripting-support" name="scripting-support" class="anchor"><span class="anchor-link"></span></a>Scripting Support</h3>
<p>Sequencer Scripts are the most important part of the Sequencer architecture. The scripting environment has following core requirements:</p>
<p><strong>Domain Specific Language</strong> (DSL) constructs for writing Scripts. For example, <code>par</code> to execute commands in parallel, <code>onSetup</code> like constructs where the script writer will define logic to be executed when <code>Setup</code> steps are processed. Kotlin has been used to create the DSL for writing a Script. Kotlin has excellent language support for writing an embedded DSL. Kotlin also has excellent support for asynchronous processing/tasks that allows a more script-like syntax for the kinds of things ESW Scripts need to do.</p>
<p><strong>Mutable State within the script</strong> To handle mutable state in thread safe manner, Script is implemented using the Active Object Pattern. Every operation in a Script needs to be asynchronous and non-blocking in nature, and each operation will be scheduled on Single Threaded Execution Context (StrandEC). This ensures that state inside the Script can be accessed/modified at any place inside with the guarantee of thread safety. If there is need to have CPU intensive or blocking operations in Script, patterns supporting these needs to be followed which uses another Execution Context so that Script StrandEC is not blocked. The scripting DSL provides special constructs for background processing.</p>
<p>Scripting Support is implemented using Kotlin. <code>onSetup</code> and <code>onObserve</code> handlers are provided which will be used by script writers to write behaviour when <code>Setup</code> and <code>Observe</code> commands are received. Specific <code>onSetup</code> handler will be picked based on command name specified in handler. For more details about scripting please refer <a href="../scripts/scripts-index.html">here</a></p>
<h2><a href="#sequencer-interfaces" name="sequencer-interfaces" class="anchor"><span class="anchor-link"></span></a>Sequencer Interfaces</h2>
<p>Sequencer exposes its interface in three ways:</p>
<ol>
  <li>Akka interface - Sequencer is registered as an Akka-based component. One can resolve Sequencer and use the Akka client to interact with Sequencer.</li>
  <li>HTTP direct interface - Each Sequencer also exposes an HTTP-based interface as an embedded Sequencer Server (direct and unprotected usage). This access provides routes that allow user to directly control the Sequencer without any auth protection. UI applications are supposed to use Gateway interface described below to interact with Sequencer as Gateway provided auth protection layer.</li>
  <li>HTTP Gateway interface - It is also possible to interact with Sequencer using the UI Application Gateway (as outside network interface). Being outside network interface, this access requires user to be authenticated and authorized. The Gateway hosts the Sequencer API, which communicates with the Sequencer via the Akka interface. Please refer to the Gateway documentation for <a href="../uisupport/gateway.html">more information</a>.</li>
</ol>
<p>Following snippet shows instantiating Akka Interface to interact with Sequencer:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L28-L35" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private implicit val actorSystem: ActorSystem[SpawnProtocol.Command] = ActorSystemFactory.remote(SpawnProtocol(), &quot;example&quot;)
private val sequencerAkkaConnection: AkkaConnection                  = AkkaConnection(ComponentId(Prefix(ESW, &quot;IRIS_DARKNIGHT&quot;), Sequencer))
private val locationService: LocationService                         = HttpLocationServiceFactory.makeLocalClient(actorSystem)

private val sequencerAkkaLocation: AkkaLocation =
  Await.result(locationService.resolve(sequencerAkkaConnection, 10.seconds), 10.seconds).get

private val sequencer: SequencerApi = SequencerApiFactory.make(sequencerAkkaLocation)</code></pre></dd>
</dl>
<p>Following snippet shows instantiating HTTP direct Interface to interact with Sequencer:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L39-L44" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private val sequencerHttpConnection: HttpConnection = HttpConnection(ComponentId(Prefix(ESW, &quot;IRIS_DARKNIGHT&quot;), Sequencer))
private val sequencerHttpLocation: HttpLocation =
  Await.result(locationService.resolve(sequencerHttpConnection, 10.seconds), 10.seconds).get
private val sequencerHttpClient: SequencerApi = SequencerApiFactory.make(sequencerHttpLocation)

sequencerHttpClient.getSequence</code></pre></dd>
</dl>
<p>For interacting using HTTP Gateway interface, please refer <a href="gateway-tech.html">here</a></p><div class="callout note "><div class="callout-title">Note</div>
<p>Sequencer Http direct interface is not supposed to be used from anywhere as it is unprotected and also bind to inside network ip.</p></div>
<h2><a href="#interacting-with-sequencer" name="interacting-with-sequencer" class="anchor"><span class="anchor-link"></span></a>Interacting with Sequencer</h2>
<p>One can use Akka Interface or HTTP Gateway interface to interact with Sequencer. APIs to interact with Sequencer are broadly categorised as following.</p>
<ul>
  <li>Sequencer Command Service - Provided as a part of CSW. Provides way to submit sequence and receive response.</li>
  <li>Sequence Editor APIs - Provided as a part of ESW. Provided way to edit sequence submitted to Sequencer.</li>
  <li>Sequencer Lifecycle APIs - Provided as a part of ESW. Provided way to send lifecycle commands to Sequencer.</li>
  <li>Other APIs - Provided as a part of ESW.</li>
</ul>
<h3><a href="#sequencer-command-service" name="sequencer-command-service" class="anchor"><span class="anchor-link"></span></a>Sequencer Command Service</h3>
<p>Commands can be sent to Sequencer to submit sequence and response is received in return.</p>
<p><a href="sequencer-tech.html#sequencer-interfaces">Sequencer Interface</a> exposes APIs on top of <a href="https://tmtsoftware.github.io/csw/0.1.0-SNAPSHOT/services/sequencer-command-service">Sequencer Command Service</a>. Sequencer Command Service provides way to submit sequence to Sequencer and receive started or final response. Sequencer Command Service is provided as a part of CSW and details about using Sequencer Command Service can be found <a href="https://tmtsoftware.github.io/csw/0.1.0-SNAPSHOT/services/sequencer-command-service">here</a>.</p>
<h3><a href="#sequence-editor-apis" name="sequence-editor-apis" class="anchor"><span class="anchor-link"></span></a>Sequence Editor APIs</h3>
<p>Sequence Editor APIs allow actions to edit sequence such as add more steps, delete/replace existing steps, Add/remove breakpoint in sequence. For using Sequence Editor actions, sequencer must be running a sequence. If Sequencer is not running any sequence then, Sequencer will return <code>Unhandled</code> response.</p>
<ul>
  <li>add</li>
</ul>
<p>This API allows to add more steps to sequence. Steps will be added in the end of sequence.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L48-L52" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val stepsToAdd: List[SequenceCommand] = List(
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-iris&quot;)),
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-tcs&quot;))
)
sequencer.add(stepsToAdd)</code></pre></dd>
</dl>
<ul>
  <li>prepend</li>
</ul>
<p>This API allows to add more steps to sequence. Steps will be added after currently running step of sequence.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L56-L60" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val stepsToPrepend: List[SequenceCommand] = List(
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-iris&quot;)),
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-tcs&quot;))
)
sequencer.prepend(stepsToPrepend)</code></pre></dd>
</dl>
<ul>
  <li>getSequence</li>
</ul>
<p>This API allows returns Sequence running in Sequencer if any.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L64" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private val stepList: StepList = Await.result(sequencer.getSequence, 1.seconds).get</code></pre></dd>
</dl>
<ul>
  <li>replace</li>
</ul>
<p>This API allows to replace particular step in the sequence with more steps.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L68-L72" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val stepsToReplace: List[SequenceCommand] = List(
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-iris&quot;)),
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-tcs&quot;))
)
sequencer.replace(stepList.steps(4).id, stepsToReplace)</code></pre></dd>
</dl>
<ul>
  <li>insertAfter</li>
</ul>
<p>This API allows to insert more steps after particular step in the sequence.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L76-L80" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val stepsToInsertAfter: List[SequenceCommand] = List(
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-iris&quot;)),
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-tcs&quot;))
)
sequencer.insertAfter(stepList.steps(4).id, stepsToInsertAfter)</code></pre></dd>
</dl>
<ul>
  <li>delete</li>
</ul>
<p>This API allows to delete particular step in the sequence.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L84-L85" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private val stepToDelete: Id = stepList.steps(4).id
sequencer.delete(stepToDelete)</code></pre></dd>
</dl>
<ul>
  <li>add and remove breakpoint</li>
</ul>
<p>These APIs allows to add and remove breakpoint for particular step in the sequence.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L89-L91" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private val breakpointStep: Id = stepList.steps(4).id
sequencer.addBreakpoint(breakpointStep)
sequencer.removeBreakpoint(breakpointStep)</code></pre></dd>
</dl>
<ul>
  <li>reset</li>
</ul>
<p>These APIs allows to discard all pending steps in the sequence.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L95" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.reset()</code></pre></dd>
</dl>
<ul>
  <li>pause and resume sequence</li>
</ul>
<p>These APIs allows to pause and resume sequence. This essentially adds/removes breakpoint at first pending step in sequence</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L99-L100" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.pause
sequencer.resume</code></pre></dd>
</dl>
<h3><a href="#sequencer-lifecycle-apis" name="sequencer-lifecycle-apis" class="anchor"><span class="anchor-link"></span></a>Sequencer Lifecycle APIs</h3>
<p>Sequencer Lifecycle APIs allow to send lifecycle commands to Sequencer such as goOnline, abortSequence etc.</p>
<p>Certain commands are restricted depending on state of Sequencer. For example, goOnline command is handled only when Sequencer is in Offline state. If goOnline is sent otherwise it will return <code>Unhandled</code> response with error msg. For details refer <a href="sequencer-tech.html#sequencer-lifecycle">Sequencer Lifecycle Section</a></p>
<ul>
  <li>isAvailable</li>
</ul>
<p>This API allows to check if Sequencer is in Idle state or not. It returns true if Sequencer is in Idle state.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L108" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.isAvailable</code></pre></dd>
</dl>
<ul>
  <li>online/offline</li>
</ul>
<p>These APIs allow to send goOnline/goOffline mode commands to Sequencer. <code>isOnline</code> command returns true if Sequencer is online.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L112-L114" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.isOnline
sequencer.goOnline()
sequencer.goOffline()</code></pre></dd>
</dl>
<ul>
  <li>abortSequence</li>
</ul>
<p>This API allow to abort running sequence. This essentially discards pending steps from sequence and also call <code>onAbortSequence</code> handler written in script.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L118" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.abortSequence()</code></pre></dd>
</dl>
<ul>
  <li>Stop</li>
</ul>
<p>This API allow to stop sequence. This essentially discards pending steps from sequence and also call <code>onStop</code> handler written in script.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L122" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.stop()</code></pre></dd>
</dl>
<ul>
  <li>getSequencerState</li>
</ul>
<p>Sequencer is implememted as state machine. It accepts/discards msgs based on Sequencer State. This API allow returns current sequencer state.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L126" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.getSequencerState</code></pre></dd>
</dl>
<ul>
  <li>diagnosticMode</li>
</ul>
<p>This API allow to send diagnosticMode command to Sequencer. This calls <code>onDiagnosticMode</code> handler written in script</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L130" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.diagnosticMode(UTCTime.now(), &quot;diagnostic-mode&quot;)</code></pre></dd>
</dl>
<ul>
  <li>operationsMode</li>
</ul>
<p>This API allow to send operationsMode command to Sequencer. This calls <code>onOperationsMode</code> handler written in script</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L134" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.operationsMode()</code></pre></dd>
</dl>
<ul>
  <li>subscribeSequencerState</li>
</ul>
<p>This API allows subscribing to state of Sequencer. It returns a Source of <code>SequencerStateResponse</code> which contains current <code>SequencerState</code> and <code>StepList</code>. The <code>Subscription</code> can be used to unsubscribe.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L138-L139" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val sequencerStateSource: Source[SequencerStateResponse, Subscription] =
  sequencer.subscribeSequencerState()</code></pre></dd>
</dl>
<h3><a href="#other-apis" name="other-apis" class="anchor"><span class="anchor-link"></span></a>Other APIs</h3>
<ul>
  <li>loadSequence</li>
</ul>
<p>This API allows to load sequence in Sequencer. Loaded Sequence does not start execution unless <code>StartSequence</code> Command is received. One can replace already loaded sequence by firing another <code>loadSequence</code> command.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L143-L147" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val sequence: Sequence = Sequence(
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-iris&quot;)),
  Setup(Prefix(ESW, &quot;filter.wheel&quot;), CommandName(&quot;setup-tcs&quot;))
)
sequencer.loadSequence(sequence)</code></pre></dd>
</dl>
<ul>
  <li>startSequence</li>
</ul>
<p>This API allows to start execution of previously loaded sequence in Sequencer. This return <code>SubmitResponse</code> which is <code>Started</code> in case of success.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L151" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.startSequence()</code></pre></dd>
</dl>
<ul>
  <li>getSequenceComponent</li>
</ul>
<p>This API allows to get location of Sequence Component running the Sequencer.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/scala/esw/examples/SequencerAPIExample.scala#L104-L155" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sequencer.getSequenceComponent
sequencer.getSequenceComponent</code></pre></dd>
</dl>
<h2><a href="#running-sequencer" name="running-sequencer" class="anchor"><span class="anchor-link"></span></a>Running Sequencer</h2>
<p>For running Sequencer Script, please refer <a href="../sequencersandscripts/sequencer-app.html">this</a>.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/technical/sequencer-tech.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../technical/sequence-manager-tech.html" title="Sequence Manager Technical Documentation" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Sequence Manager Technical Documentation
</span>
</div>
</a>
<a href="../technical/sequence-component-tech.html" title="Sequence Component Technical Documentation" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Sequence Component Technical Documentation
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
