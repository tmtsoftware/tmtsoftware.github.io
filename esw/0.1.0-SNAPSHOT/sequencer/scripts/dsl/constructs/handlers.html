<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../../assets/tmt_favicon.ico">
<title>Script Handlers Â· TMT Executive Software (ESW)</title>
<link rel="stylesheet" href="../../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../../lib/prettify/prettify.css">
<script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software (ESW)
</span>
<span class="md-header-nav__topic">
Script Handlers
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../../../index.html" title="TMT Executive Software (ESW)">
TMT Executive Software (ESW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
<ul>
  <li><a href="../../../../sequencer/seqcompsequencer/index.html" class="page">Sequence Components and Sequencers</a>
  <ul>
    <li><a href="../../../../sequencer/seqcompsequencer/Terms.html" class="page">OCS Terms</a></li>
    <li><a href="../../../../sequencer/seqcompsequencer/SeqComp.html" class="page">Sequence Component</a></li>
    <li><a href="../../../../sequencer/seqcompsequencer/Sequencers.html" class="page">Sequencers</a></li>
    <li><a href="../../../../sequencer/seqcompsequencer/state-transition.html" class="page">Sequencer Lifecycle</a></li>
  </ul></li>
  <li><a href="../../../../sequencer/scripts/scripts.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/script-styles.html" class="page">Sequencer Script Styles</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../../../../commons/contracts.html" class="page">ESW Service contract</a></li>
  <li><a href="../../../../apps/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../../../../apps/sequencerapp.html" class="page">sequencer-app</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#script-handlers" class="header">Script Handlers</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#command-handlers" class="header">Command Handlers</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#online-and-offline-handlers" class="header">Online and Offline Handlers</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#abort-sequence-handler" class="header">Abort Sequence Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#stop-handler" class="header">Stop Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#shutdown-handler" class="header">Shutdown Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#diagnostic-mode-handler" class="header">Diagnostic Mode Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#operations-mode-handler" class="header">Operations Mode Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#error-handlers" class="header">Error Handlers</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#script-handlers" class="header">Script Handlers</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#command-handlers" class="header">Command Handlers</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#online-and-offline-handlers" class="header">Online and Offline Handlers</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#abort-sequence-handler" class="header">Abort Sequence Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#stop-handler" class="header">Stop Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#shutdown-handler" class="header">Shutdown Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#diagnostic-mode-handler" class="header">Diagnostic Mode Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#operations-mode-handler" class="header">Operations Mode Handler</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/handlers.html#error-handlers" class="header">Error Handlers</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#script-handlers" name="script-handlers" class="anchor"><span class="anchor-link"></span></a>Script Handlers</h1>
<p>A Sequencer script processes Sequences by defining &ldquo;handlers&rdquo; in the script. This is done by completing the special handler functions described below. There are handlers that can be created to process the Setup and Observe commands, which make up the Sequence, but there are also handlers for specific reasons including: aborting and stopping a sequence, putting the Sequencer in Online and Offline modes, and putting the Sequencer into a Diagnostic mode and back to Operations mode. There is also a global error handler to catch all uncaught exceptions, and a shutdown handler to perform cleanup befores the Sequencer shut down and exits. Each of these handlers are described below, with a section on <a href="handlers.html#error-handlers">how to handle exceptions</a> after that.</p>
<h2><a href="#command-handlers" name="command-handlers" class="anchor"><span class="anchor-link"></span></a>Command Handlers</h2>
<h3><a href="#onsetup" name="onsetup" class="anchor"><span class="anchor-link"></span></a>onSetup</h3>
<p>This handler is used to handle a <a href="https://tmtsoftware.github.io/csw/0.1.0-SNAPSHOT/api/java/csw/params/commands/Setup.html">Setup</a> command sent to this Sequencer. The handler takes two parameters:</p>
<ol>
  <li><strong>command name</strong> which is matched against the sequence command sent. If the command name matches, corresponding block provided is executed</li>
  <li><strong>block</strong> of code which contains logic to act on the Setup command.</li>
</ol>
<p>In this <code>onSetup</code> example, commands are sent in parallel to each of the WFOS filter wheels. </p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L27-L35" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;setupInstrument&quot;) {command -&gt;
    // split command and send to downstream
    val assembly1 = Assembly(WFOS, &quot;filter.blueWheel&quot;, 5.seconds)
    val assembly2 = Assembly(WFOS, &quot;filter.redWheel&quot;, 5.seconds)
    par(
            { assembly1.submit(Setup(&quot;WFOS.wfos_darknight&quot;, &quot;move&quot;)) },
            { assembly2.submit(Setup(&quot;WFOS.wfos_darknight&quot;, &quot;move&quot;)) }
    )
}</code></pre></dd>
</dl>
<p>In the block provided to this handler, all the CSW services (Event, Alarm, Time Service, etc) and control DSL (loop, par etc) are accessible.</p>
<h3><a href="#onobserve" name="onobserve" class="anchor"><span class="anchor-link"></span></a>onObserve</h3>
<p>This handler is used to handle an <a href="https://tmtsoftware.github.io/csw/0.1.0-SNAPSHOT/api/java/csw/params/commands/Observe.html">Observe</a> command sent to this Sequencer. The handler takes two parameters:</p>
<ol>
  <li><strong>command name</strong> which is matched against the sequence command sent, if the command name matches, corresponding block provided is executed</li>
  <li><strong>block</strong> of code which contains logic to act on the Observe command.</li>
</ol>
<p>The following example imagines a WFOS Sequencer receiving an <code>Observe</code> that contains an exposureTime parameter. The exposureTime is extracted into a <code>Setup</code> that is sent to the detector Assembly to start the exposure.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L40-L48" target="_blank" title="Go to snippet source"></a><code class="language-kts">// A detector assembly is defined with a long timeout of 60 minutes
val detectorAssembly = Assembly(WFOS, &quot;detectorAssembly&quot;, 60.minutes)
val exposureKey = floatKey(&quot;exposureTime&quot;)

onObserve(&quot;startExposure&quot;) { observe -&gt;
    // Extract the input exposure time and send a startObserve command to the detector Assembly
    val expsosureTime = observe(exposureKey).head()
    detectorAssembly.submitAndWait(Setup(&quot;WFOS.sequencer&quot;, &quot;startObserve&quot;, observe.obsId).add(observe(exposureKey)))
}</code></pre></dd>
</dl>
<h2><a href="#online-and-offline-handlers" name="online-and-offline-handlers" class="anchor"><span class="anchor-link"></span></a>Online and Offline Handlers</h2>
<h3><a href="#ongoonline" name="ongoonline" class="anchor"><span class="anchor-link"></span></a>onGoOnline</h3>
<p>On receiving the <code>goOnline</code> command, the onGoOnline handler, if defined, will be called. The Sequencer will become online only if the handler executes successfully.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L52-L55" target="_blank" title="Go to snippet source"></a><code class="language-kts">onGoOnline {
    // send command to downstream components
    assembly.goOnline()
}</code></pre></dd>
</dl>
<h3><a href="#ongooffline" name="ongooffline" class="anchor"><span class="anchor-link"></span></a>onGoOffline</h3>
<p>On receiving the <code>goOffline</code> command, the onGoOffline handler, if defined, will be called. The Sequencer will become offline only if the handler executes successfully. Offline handlers could be written to clear the sequencer state before going offline.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L59-L62" target="_blank" title="Go to snippet source"></a><code class="language-kts">onGoOffline {
    // send command to downstream components
    assembly.goOffline()
}</code></pre></dd>
</dl>
<h2><a href="#abort-sequence-handler" name="abort-sequence-handler" class="anchor"><span class="anchor-link"></span></a>Abort Sequence Handler</h2>
<p>The abort handler could be used to perform any cleanup tasks that need to be done before the current sequence is aborted (e.g. abort an exposure). Note that, even if the handlers fail, the sequence will be aborted.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L66-L68" target="_blank" title="Go to snippet source"></a><code class="language-kts">onAbortSequence {
    // cleanup steps to be done before aborting will go here
}</code></pre></dd>
</dl>
<h2><a href="#stop-handler" name="stop-handler" class="anchor"><span class="anchor-link"></span></a>Stop Handler</h2>
<p>This handler is provided to clear/save the Sequencer state or stop exposures before stopping. Note that, even if the handlers fail, the sequence will be aborted.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L72-L74" target="_blank" title="Go to snippet source"></a><code class="language-kts">onStop {
    // steps for clearing sequencer-state before stopping will go here
}</code></pre></dd>
</dl>
<h2><a href="#shutdown-handler" name="shutdown-handler" class="anchor"><span class="anchor-link"></span></a>Shutdown Handler</h2>
<p>This handler will be called just before the Sequencer is shutdown. Note that, even if the handlers fail, the Sequencer will be shutdown.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L78-L80" target="_blank" title="Go to snippet source"></a><code class="language-kts">onShutdown {
    // cleanup steps to be done before shutdown will go here
}</code></pre></dd>
</dl>
<h2><a href="#diagnostic-mode-handler" name="diagnostic-mode-handler" class="anchor"><span class="anchor-link"></span></a>Diagnostic Mode Handler</h2>
<p>This handler can be used to perform actions that need to be done when the Sequencer goes in the diagnostic mode. The handler gets access to two parameters:</p>
<ul>
  <li><strong>startTime:</strong> UTC time at which the diagnostic mode actions should take effect</li>
  <li><strong>hint:</strong> represents the diagnostic data mode supported by the Sequencer</li>
</ul>
<p>The Sequencer can choose to publish any diagnostic data in this handler based on the hint received, and/or send a diagnostic command to downstream components.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L21-L94" target="_blank" title="Go to snippet source"></a><code class="language-kts">var diagnosticEventCancellable: Cancellable? = null

onDiagnosticMode { startTime, hint -&gt;
    // start publishing diagnostic data on a supported hint (for e.g. engineering)
    when (hint) {
        &quot;engineering&quot; -&gt; {
            val diagnosticEvent = SystemEvent(&quot;ESW.ESW_darknight&quot;, &quot;diagnostic&quot;)
            diagnosticEventCancellable = schedulePeriodically(startTime, 50.milliseconds) {
                publishEvent(diagnosticEvent)
            }
        }
    }
}</code></pre></dd>
</dl>
<h2><a href="#operations-mode-handler" name="operations-mode-handler" class="anchor"><span class="anchor-link"></span></a>Operations Mode Handler</h2>
<p>This handler can be used to perform actions that need to be done when the Sequencer goes in the operations mode. Script writers can use this handler to stop all the publishing being done by the <a href="handlers.html#diagnostic-mode-handler">diagnostic mode handler</a>, and/or send an operations mode command to downstream components.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L98-L103" target="_blank" title="Go to snippet source"></a><code class="language-kts">onOperationsMode {
    // cancel all publishing events done from diagnostic mode
    diagnosticEventCancellable?.cancel()
    // send operations command to downstream
    assembly.operationsMode()
}</code></pre></dd>
</dl>
<h2><a href="#error-handlers" name="error-handlers" class="anchor"><span class="anchor-link"></span></a>Error Handlers</h2>
<p>In many cases, any errors encountered in a script would likely cause the command (and therefore, sequence) to fail. Most of the time, not much can be done other than capture and report the error that occurred. It is possible to perform some remediation, but it is likely the sequence would need to run again.</p>
<p>For this reason, we have simplified the error handling of commands such that any DSL APIs that essentially return a negative (e.g. Error or Cancelled) <code>SubmitResponse</code> are recasted as exceptions, which can then be caught by error handlers that are global to the sequence command handler, or the entire script. In this way, such error handling does not need to be repeated throughout the script for each command sent.</p>
<p>A script can error out in following scenarios:</p>
<ol>
  <li>
  <p><strong>Script Initialization Error</strong> : When the construction of script throws exception then script initialization fails. In this scenario, the framework will log the error cause. The Sequencer will not start on this failure. One needs to fix the error and then load script again.</p></li>
  <li>
    <p><strong>Command Handlers Failure</strong> : While executing a sequence, <a href="handlers.html#command-handlers">Command Handlers</a> e.g. <code>onSetup</code> , <code>onObserve</code> can fail because of two reasons:</p>
    <ol>
      <li>handler throws exception or</li>
      <li>The <code>Command Service</code> or <code>Sequencer Command Service</code> used to interact with downstream <code>Assembly/HCD/Sequencer</code> returns negative <code>SubmitResponse</code>. A negative <code>SubmitResponse</code> is by default considered as error. In this case of failure, sequence is terminated with failure.</li>
    </ol>
  </li>
  <li>
  <p><strong>Handlers Failure</strong> : This failure occurs when any of handlers other than Command Handlers fail (e.g. <code>OnGoOnline</code>, <code>onDiagnosticMode</code> etc.). In this scenario, framework will log the error cause. Sequence execution will continue. </p></li>
</ol>
<p>The Script DSL provides following constructs to handle failures while executing script:</p>
<h3><a href="#global-error-handler" name="global-error-handler" class="anchor"><span class="anchor-link"></span></a>Global Error Handler</h3>
<p><strong>onGlobalError</strong> : This construct is provided for the script writer. Logic in the <code>onGlobalError</code> will be executed for all <strong>Handler Failures</strong> including <strong>Command Handler Failures</strong> except the <a href="handlers.html#shutdown-handler">Shutdown Handler</a>. If the <code>onGlobalError</code> handler is not provided by script, then only the logging of error cause is done by the framework.</p>
<p>Following example shows usage of <code>onGlobalError</code></p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L107-L137" target="_blank" title="Go to snippet source"></a><code class="language-kts">// Scenario-1 onObserve handler fails
onObserve(&quot;trigger-filter-wheel&quot;) { command -&gt;
    val triggerStartEvent = ObserveEvent(&quot;esw.command&quot;, &quot;trigger.start&quot;, command(stringKey(name = &quot;triggerTime&quot;)))
    // publishEvent fails with EventServerNotAvailable which fails onObserve handler
    // onGlobalError handler is called
    // Sequence is terminated with failure.
    publishEvent(triggerStartEvent)
}

// Scenario-2 onSetup handler fails - submit returns negative SubmitResponse
onSetup(&quot;command-2&quot;) { command -&gt;
    val assembly1 = Assembly(IRIS, &quot;filter.wheel&quot;, 5.seconds)

    // Submit command to assembly return negative response. (error by default) onGlobalError handler is called.
    // Sequence is terminated with failure.
    assembly1.submit(command)
}

// Scenario-3
onDiagnosticMode { startTime, hint -&gt;
    // publishEvent fails with EventServerNotAvailable
    // onDiagnosticMode handler fails
    // onGlobalError is called. Sequence execution continues.
    publishEvent(ObserveEvent(&quot;esw.diagnostic.mode&quot;, hint))
}

onGlobalError { error -&gt;
    val errorReason = stringKey(&quot;reason&quot;).set(error.reason)
    val observationEndEvent = ObserveEvent(&quot;esw.observation.end&quot;, &quot;error&quot;, errorReason)
    publishEvent(observationEndEvent)
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>Error in all handlers <strong>except the Shutdown Handler</strong> will execute the global error handler provided by script. If an error handler is not provided, the framework will log the error cause.</p></div>
<h3><a href="#error-handling-at-command-handler-level" name="error-handling-at-command-handler-level" class="anchor"><span class="anchor-link"></span></a>Error handling at command handler level</h3>
<p><strong>onError</strong> : This construct is specifically provided for <strong>Command Handler Failures</strong>. An <code>onError</code> block can be written specifically for each <code>onSetup</code> and <code>onObserve</code> handler. The <code>SubmitResponse</code> error is captured in a <code>ScriptError</code> type and passed to the <code>onError</code> block. This type contains a <code>reason</code> String explaining what went wrong. In case of failure, <code>onError</code> will be called first followed by <code>onGlobalError</code> and the sequence will be terminated with failure. After the error handling blocks are called, the command and sequence, terminate with an Error status.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L141-L146" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;submit-error-handling&quot;) { command -&gt;
    // some logic that results into a Runtime exception
    val result: Int = 1 / 0
}.onError { err -&gt;
    error(err.reason)
}</code></pre></dd>
</dl>
<p>By default, a negative <code>SubmitResponse</code> is considered an error.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L150-L156" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;submit-error-handling&quot;) { command -&gt;
    val positiveSubmitResponse: SubmitResponse = assembly.submit(command)

}.onError { err -&gt;
    // onError is called when submit command to the assembly fails with a negative response (error, invalid etc)
    error(err.reason)
}</code></pre></dd>
</dl>
<p><strong>retry</strong>: This construct can be attached to an <code>onSetup</code> or <code>onObserve</code> handler to automatically retry  the handler code in the case of <strong>Command Handler Failures</strong>. A <code>retry</code> block expects a <code>retryCount</code> and optional parameter <code>interval</code> which specifies an interval after which <code>onSetup</code> or <code>onObserve</code> will be retried in case of failure. The <code>retry</code> block can be used along with <code>onError</code> or it can be used independently. If <code>retry</code> is combined with <code>onError</code>, the <code>onError</code> block will be called before each retry attempt. If the command handler still fails after all retry attempts, the command fails with an Error status. Then the <code>onGlobalError</code> block will be executed (if provided), and the sequence will be terminated with a failure as well (see <a href="handlers.html#global-error-handler">Global Error Handler</a>.</p>
<p>The following example shows the <code>retry</code> construct used along with <code>onError</code>.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L160-L167" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;submit-error-handling&quot;) { command -&gt;
    val assembly1 = Assembly(IRIS, &quot;filter.wheel&quot;, 5.seconds)

    // Submit command to assembly return negative response. - error by default
    assembly1.submit(command)
}.onError { err -&gt;
    error(err.reason)
}.retry(2)</code></pre></dd>
</dl>
<p>The following example shows <code>retry</code> with an interval specified and used without an <code>onError</code> block.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/HandlersExample.kts#L171-L176" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;submit-error-handling&quot;) { command -&gt;
    val assembly1 = Assembly(IRIS, &quot;filter.wheel&quot;, 5.seconds)

    // Submit command to assembly return negative response. - error by default
    assembly1.submit(command)
}.retry(2, 10.seconds)</code></pre></dd>
</dl>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/sequencer/scripts/dsl/constructs/handlers.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../../sequencer/scripts/dsl/constructs/define-script.html" title="Defining A Script" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Defining A Script
</span>
</div>
</a>
<a href="../../../../sequencer/scripts/dsl/constructs/loop.html" title="Including Looping in Scripts" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Including Looping in Scripts
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../../."}})</script>
<script type="text/javascript" src="../../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
