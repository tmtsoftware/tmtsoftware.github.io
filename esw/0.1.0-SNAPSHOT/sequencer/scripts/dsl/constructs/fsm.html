<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../../assets/tmt_favicon.ico">
<title>Finite State Machines Â· TMT Executive Software (ESW)</title>
<link rel="stylesheet" href="../../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../../lib/prettify/prettify.css">
<script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software (ESW)
</span>
<span class="md-header-nav__topic">
Finite State Machines
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../../../index.html" title="TMT Executive Software (ESW)">
TMT Executive Software (ESW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
<ul>
  <li><a href="../../../../sequencer/scripts/scripts.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../../../../sequencer/state-transition.html" class="page">Sequencer State Transition</a></li>
  <li><a href="../../../../apps/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../../../../apps/sequencerapp.html" class="page">sequencer-app</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#finite-state-machines" class="header">Finite State Machines</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#define-fsm" class="header">Define FSM</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#start-fsm" class="header">Start FSM</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#wait-for-completion" class="header">Wait for completion</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#reactive-fsm" class="header">Reactive FSM</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#example-fsm" class="header">Example FSM</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#finite-state-machines" class="header">Finite State Machines</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#define-fsm" class="header">Define FSM</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#start-fsm" class="header">Start FSM</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#wait-for-completion" class="header">Wait for completion</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#reactive-fsm" class="header">Reactive FSM</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/fsm.html#example-fsm" class="header">Example FSM</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#finite-state-machines" name="finite-state-machines" class="anchor"><span class="anchor-link"></span></a>Finite State Machines</h1>
<p>Scripts have ability to define and run <a href="https://en.wikipedia.org/wiki/Finite-state_machine" title="Finite State Machine (FSM)">Finite State Machine (FSM)</a>. FSM can transition between defined states and can be made reactive to Event and Command.</p>
<h2><a href="#define-fsm" name="define-fsm" class="anchor"><span class="anchor-link"></span></a>Define FSM</h2>
<h3><a href="#create-fsm" name="create-fsm" class="anchor"><span class="anchor-link"></span></a>Create FSM</h3>
<p>To create an instance of FSM, a helper method <code>Fsm</code> is provided as shown in example. This method takes following parameters:</p>
<ol>
  <li><code>name</code> of FSM</li>
  <li><code>initial state</code> of the FSM</li>
  <li><code>block</code> having states of the FSM</li>
</ol>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L22-L24" target="_blank" title="Go to snippet source"></a><code class="language-kts">val irisFsm: Fsm = Fsm(name = &quot;iris-fsm&quot;, initState = &quot;INIT&quot;) {
    // place to define all states of FSM
}</code></pre></dd>
</dl>
<h3><a href="#define-state" name="define-state" class="anchor"><span class="anchor-link"></span></a>Define state</h3>
<p>As mentioned above, the third parameter of <code>Fsm</code> method is a block which is the place to define all the states of FSM. A method named <code>state</code> needs to be called with parameters <code>name</code> of the state and the <code>block</code> of actions to be performed in that state.</p><div class="callout note "><div class="callout-title">Note</div>
<ol>
  <li>State names are <strong>case-insensitive</strong>.</li>
  <li>In case of multiple states with same name, the last one will be considered.</li>
</ol></div>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L79-L81" target="_blank" title="Go to snippet source"></a><code class="language-kts">state(&quot;INIT&quot;) {
    // actions to be performed in this state
}</code></pre></dd>
</dl>
<h3><a href="#state-transition" name="state-transition" class="anchor"><span class="anchor-link"></span></a>State transition</h3>
<p>To transit between states, <code>become</code> method needs to be called with name of next <code>state</code>. This will <strong>change the state</strong> of the fsm to the given state and <strong>start executing next state</strong>. <code>InvalidStateException</code> will be thrown if provided state is not defined.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L99" target="_blank" title="Go to snippet source"></a><code class="language-kts">become(state = &quot;IN-PROGRESS&quot;)</code></pre></dd>
</dl><div class="callout warning "><div class="callout-title">Caution</div>
<p>State transition should ideally be the <strong>last call in state</strong> or should be <strong>done with proper control flow</strong> so that become is <strong>not called multiple times</strong>.</p></div>
<p>In a case where <strong>state transition does not happen</strong> while executing a state, the <strong>FSM will stay in the same state</strong> and re-evaluating FSM after that will execute the same state until any state transition happens. The <a href="fsm.html#reactive-fsm">reactive variables</a> plays an important role in this as they are the way to re-evaluate the FSM state.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L111-L122" target="_blank" title="Go to snippet source"></a><code class="language-kts">state(&quot;LOW&quot;) {
    on(temparature.get() &lt; 20) {
        // do something but state transition does not happen
    }

    on(temparature.get() &gt;= 20) {
        // do something and transit state
        become(&quot;HIGH&quot;)
    }
}</code></pre></dd>
</dl>
<p>In the example above, the FSM is in LOW state. If the temperature is below 20, then there won&rsquo;t be any state transition which will keep the FSM in same LOW state. Change in temperature after that will re-evaluate the &ldquo;LOW&rdquo; state again and if the temperature is greater than or equal to 20 then current state will change to HIGH. In the example <code>temperature</code> is a <a href="fsm.html#event-variable">event variable</a> which enables the re-evaluation of current state on changes in temperature value.</p>
<h3><a href="#complete-fsm" name="complete-fsm" class="anchor"><span class="anchor-link"></span></a>Complete FSM</h3>
<p><code>completeFsm</code> <strong>marks the FSM complete</strong>. Calling it will immediately <strong>stop execution of the FSM</strong> and next steps will be ignored, so it should be called at the end of the state.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L103-L104" target="_blank" title="Go to snippet source"></a><code class="language-kts">completeFsm()   // will complete the Fsm
// anything after this will not be executed</code></pre></dd>
</dl>
<h3><a href="#helper-constructs" name="helper-constructs" class="anchor"><span class="anchor-link"></span></a>Helper constructs</h3>
<ol>
  <li>
    <p><code>entry</code> : executes the given <code>block</code> only when <strong>state transition happens from a different state</strong></p>
    <dl>
      <dt>Kotlin</dt>
      <dd>
      <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L87-L89" target="_blank" title="Go to snippet source"></a><code class="language-kts">entry {
    // do something
}</code></pre></dd>
    </dl>
  </li>
  <li>
    <p><code>on</code> : executes the given <code>block</code> if given <code>condition</code> evaluates to <strong>true</strong>. This construct should be used for conditional execution of any task.</p>
    <dl>
      <dt>Kotlin</dt>
      <dd>
      <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L113-L120" target="_blank" title="Go to snippet source"></a><code class="language-kts">on(temparature.get() &lt; 20) {
    // do something but state transition does not happen
}

on(temparature.get() &gt;= 20) {
    // do something and transit state
    become(&quot;HIGH&quot;)
}</code></pre></dd>
    </dl>
  </li>
  <li>
    <p><code>after</code> : executes the given <code>block</code> after the given <code>duration</code></p>
    <dl>
      <dt>Kotlin</dt>
      <dd>
      <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L93-L95" target="_blank" title="Go to snippet source"></a><code class="language-kts">after(100.milliseconds) {
    // do something
}</code></pre></dd>
    </dl>
  </li>
</ol>
<h2><a href="#start-fsm" name="start-fsm" class="anchor"><span class="anchor-link"></span></a>Start FSM</h2>
<p>After creating instance of FSM, it needs to be <strong>explicitly started</strong> by calling <code>start</code> on it. This will <strong>start executing the initial state</strong> of fsm which is provided while creating instance of it.</p><div class="callout warning "><div class="callout-title">Caution</div>
<p>Calling <code>start</code> more than once is not supported and will lead to unpredictable behaviour. </p></div>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L28" target="_blank" title="Go to snippet source"></a><code class="language-kts">irisFsm.start()</code></pre></dd>
</dl>
<h2><a href="#wait-for-completion" name="wait-for-completion" class="anchor"><span class="anchor-link"></span></a>Wait for completion</h2>
<p>As FSM has ability to be complete itself, <code>await</code> can be called to <strong>wait for its completion</strong>. <strong>Execution will be paused</strong> at the <code>await</code> statement till the FSM is marked complete.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L32" target="_blank" title="Go to snippet source"></a><code class="language-kts">irisFsm.await()</code></pre></dd>
</dl>
<p>Calling <code>await</code> before calling <code>start</code> will start the fsm internally and then wait for completion.</p>
<h2><a href="#reactive-fsm" name="reactive-fsm" class="anchor"><span class="anchor-link"></span></a>Reactive FSM</h2>
<p>FSM can be made to react to changes in Event and Command parameters with help of <code>Event variables</code> and <code>Command flags</code>.</p>
<p><strong><code>bind</code>ing FSM to reactive variable is necessary</strong> to achieve the reactive behavior of FSM.</p>
<h3><a href="#event-variable" name="event-variable" class="anchor"><span class="anchor-link"></span></a>Event variable</h3>
<p>Event variables are the way to make fsm react to events. Event variable can be tied to only one Parameter Key in an event. To make FSM react to Event variable, we need to create a <code>EventVariable</code> for a specific Parameter Key of an Event and <strong>bind the FSM</strong> to it. FSM can be bind to multiple Event variables and vise versa.</p>
<p>Event variables use Event Service underneath, which makes it possible to share data between multiple sequencers. Whenever any event is published on the key of given event, all the FSMs bound to that variable will be re-evaluated.</p>
<p>Event variables are of 2 types:</p>
<ol>
  <li><code>SystemVar</code> - are based on SystemEvent</li>
  <li><code>ObserveVar</code> - are based on ObserveEvent</li>
</ol>
<p>Event variable takes 4 arguments: - the initial value to set in Event parameter against the given parameter Key - the event key to tie Event variable to - the param Key whose value to read from Event parameters - the duration (optional) of the polling (Significance of duration parameter is explained <a href="fsm.html#poll">below</a>.)</p>
<p>Event variable has capability to behave one of two ways</p>
<ul>
  <li>Subscribe to the Events getting published</li>
  <li>Poll for a new event after every certain interval</li>
</ul>
<h4><a href="#subscribe" name="subscribe" class="anchor"><span class="anchor-link"></span></a>Subscribe</h4>
<p>Event variable subscribes to the given Event key and re-evaluates the FSMs current state as soon as an event is published.</p>
<p>Following examples shows how to create Event variables with subscribing behavior, <code>bind</code> FSM to it and methods like <code>get</code> and <code>set</code>. <code>set</code> will publish the event with modified parameter.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L37-L50" target="_blank" title="Go to snippet source"></a><code class="language-kts">//**  System Var **//
val tempKey: Key&lt;Int&gt; = intKey(&quot;temperature&quot;)
val systemVar: EventVariable&lt;Int&gt; = SystemVar(0, &quot;esw.temperature.temp&quot;, tempKey)

systemVar.bind(irisFsm) // binds the FSM and event variable

//**  Observe Var **//
val coordKey: Key&lt;Coord&gt; = coordKey(&quot;co-ordinates&quot;)
val observeVar: EventVariable&lt;Coord&gt; = ObserveVar(JEqCoord.make(0, 0), &quot;IRIS.observe.coord&quot;, coordKey)
observeVar.get() // returns the value of the parameter from the latest event

observeVar.bind(irisFsm) // binds the FSM and event variable

observeVar.set(JEqCoord.make(1, 1)) // publishes the given value on event key</code></pre></dd>
</dl>
<h4><a href="#poll" name="poll" class="anchor"><span class="anchor-link"></span></a>Poll</h4>
<p>Polling behavior is for situations when it&rsquo;s <strong>not necessary to re-evaluate FSM state on every Event</strong> and can be done periodically after a certain duration. Event variable polls to get the latest Event with given duration and if a new Event is published, it will re-evaluate the FSMs current state. Polling behavior can be used when the publisher is too fast and there is no need respond so quickly to it.</p>
<p>For creating Event variable with polling behavior, it needs an extra argument which is the <code>duration</code> to poll with, the example code demos it. Other methods like <code>get</code>, <code>set</code> and <code>bind</code> are same as shown <a href="fsm.html#subscribe">Subscribe</a> examples above.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L54-L58" target="_blank" title="Go to snippet source"></a><code class="language-kts">// SystemVar with polling duration of 2 seconds
val pollingSysVar: EventVariable&lt;Int&gt; = SystemVar(0, &quot;esw.temperature.temp&quot;, tempKey, 2.seconds)

// ObserveVar with polling duration of 2 seconds
val pollingObsVar: EventVariable&lt;Coord&gt; = ObserveVar(JEqCoord.make(0, 0), &quot;iris.observe.coord&quot;, coordKey, 2.seconds)</code></pre></dd>
</dl>
<h3><a href="#commandflag" name="commandflag" class="anchor"><span class="anchor-link"></span></a>CommandFlag</h3>
<p>Command flag acts as bridge which can used to pass <code>Parameters</code> to FSM from outside. Setting the params in command flag will re-evaluate the all the FSMs with provided params which are bound to that flag. It is possible to bind one FSM to multiple command flags and vise versa. Command flag is limited to scope of a single script. It does not have any remote impact.</p>
<p>Example shows how to create <code>CommandFlag</code>, <code>bind</code> FSM to it and methods <code>get</code> and <code>set</code> which are provided to retrieve or set the value of params in command flag.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/Fsm.kts#L64-L71" target="_blank" title="Go to snippet source"></a><code class="language-kts">val flag = CommandFlag()
flag.bind(irisFsm) // bind the FSM and command flag

onSetup(&quot;setup-command&quot;) { command -&gt;
    flag.set(command.params) // will set params and refreshes the bound FSMs with the new params
}

flag.value() // way to extract the current params value in FSM</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<ul>
  <li>Binding FSM to reactive variables can be done anytime in the lifecycle of FSM not only before starting it. Doing it after completion of FSM does not do anything.</li>
  <li><strong>Binding is must for achieving the reactive behavior</strong>.</li>
</ul></div>
<h2><a href="#example-fsm" name="example-fsm" class="anchor"><span class="anchor-link"></span></a>Example FSM</h2>
<p>In the below example, <code>temparatureFsm</code> demonstrates how to define and use FSM in the scripts. The event variable is declared with event key <code>esw.temperature.temp</code> for param <code>temperature</code> and <code>temperatureFsm</code> is bind to it. The job of the <code>temperatureFsm</code> is to decide the <code>state</code> based on the <code>temperature</code> and publish it on event key <code>esw.temperatureFsm</code> with param key <code>state</code>.</p>
<p>Logic of state change is:</p>
<table>
  <thead>
    <tr>
      <th align="center">condition </th>
      <th align="center">state </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="center">temp == 30 </td>
      <td align="center">FINISH </td>
    </tr>
    <tr>
      <td align="center">temp &gt; 40 </td>
      <td align="center">ERROR </td>
    </tr>
    <tr>
      <td align="center">else </td>
      <td align="center">OK </td>
    </tr>
  </tbody>
</table>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/FsmExample.kts#L12-L78" target="_blank" title="Go to snippet source"></a><code class="language-kts">val tempKey = longKey(&quot;temperature&quot;)
val stateKey = stringKey(&quot;state&quot;)

val tempFsmEvent = SystemEvent(&quot;esw.temperatureFsm&quot;, &quot;state&quot;)
suspend fun publishState(baseEvent: SystemEvent, state: String) =
        publishEvent(baseEvent.add(stateKey.set(state)))

// temperature Fsm states
val OK = &quot;OK&quot;
val ERROR = &quot;ERROR&quot;
val FINISHED = &quot;FINISHED&quot;

val temperatureVar = SystemVar(0, &quot;esw.temperature.temp&quot;, tempKey)
val commandFlag = CommandFlag()

val temperatureFsm = Fsm(&quot;TEMP&quot;, OK) {
    var fsmVariable = 10                                     // [[ 1 ]]

    state(OK) {
        val currentTemp = temperatureVar.get()        // [[ 2 ]]
        val expectedTemp = commandFlag.value().get(intKey(&quot;expected-temperature&quot;)).get().first

        entry {
            publishState(tempFsmEvent, OK)
        }
        on(currentTemp == 30L) {
            become(FINISHED)                                 // [[ 3 ]]
        }
        on(currentTemp &gt; 40) {
            become(ERROR)
        }
        on(currentTemp &lt;= expectedTemp) {
            info(&quot;temperataure is below expected threshold&quot;,
                    mapOf(&quot;exepected&quot; to expectedTemp, &quot;current&quot; to currentTemp)
            )
        }
    }

    state(ERROR) {
        entry {
            publishState(tempFsmEvent, ERROR)
        }
        on(temperatureVar.get() &lt; 40) {
            become(OK)
        }
    }

    state(FINISHED) {
        completeFsm()                                        // [[ 4 ]]
    }
}

temperatureVar.bind(temperatureFsm)
commandFlag.bind(temperatureFsm)                             // [[ 5 ]]

onSetup(&quot;command-1&quot;) {
    temperatureFsm.start()                                   // [[ 6 ]]
}

onSetup(&quot;command-2&quot;) { command -&gt;
    commandFlag.set(command.params)                          // [[ 7 ]]
}

onSetup(&quot;command-3&quot;) {
    temperatureFsm.await()                                   // [[ 8 ]]
}
</code></pre></dd>
</dl>
<p>Full example code is available <a href="https://github.com/tmtsoftware/esw/blob/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/FsmExample.kts">here</a>.</p>
<p>Key things in above example code are :</p>
<ul>
  <li><code>[[ 1 ]]</code>: Shows <strong>top-level scope of the FSM which can used to declare variables</strong> in FSM&rsquo;s scope and statements which should be executed while starting the FSM. Statements written here will be executed only once when the FSM starts.</li>
  <li><code>[[ 2 ]]</code>: The scope of the state. Statements written here will be executed on every evaluation of the state. So variables declared here will be reinitialized whenever state is re-evaluated. In the above case, the <em>expectedTemp</em> and <em>currentTemp</em> will be initialized every time the OK state is evaluated.</li>
  <li><code>[[ 3 ]]</code>: State transitions from <code>OK</code> state to <code>FINISHED</code>.</li>
  <li><code>[[ 4 ]]</code>: Marks the FSM complete. Re-evaluation or state transitions cannot happen after this is executed.</li>
</ul>
<p>Till point <code>[[ 4 ]]</code>, it&rsquo;s all about <strong>defining the blue-print</strong> and <strong>initialising state of FSM</strong> which includes executing statements at <code>[[ 1 ]]</code>.</p>
<ul>
  <li><code>[[ 5 ]]</code>: Shows the binding <code>temperatureFsm</code> to <code>temperatureVar</code> and <code>commandFlag</code>. After this point, FSM will re-evaluate whenever events are published on <code>temperatureVar</code>.</li>
  <li><code>[[ 6 ]]</code>: Starts <strong>evaluating the initial state</strong> of the FSM</li>
  <li><code>[[ 7 ]]</code>: Sets the Params of the Command in the Command flag</li>
  <li><code>[[ 8 ]]</code>: Waits for completion of the FSM. In example, the script execution will be blocked till line <code>[[ 4 ]]</code> is executed which will mark the FSM complete. The script will continue execution after FSM is marked complete.</li>
</ul>
<p>Example code also demos the use of the <a href="fsm.html#helper-constructs">helper constructs</a> like <code>entry</code>, <code>on</code>.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/sequencer/scripts/dsl/constructs/fsm.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../../sequencer/scripts/dsl/constructs/loop.html" title="Including Looping in Scripts" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Including Looping in Scripts
</span>
</div>
</a>
<a href="../../../../sequencer/scripts/dsl/constructs/misc.html" title="Other DSL" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Other DSL
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../../."}})</script>
<script type="text/javascript" src="../../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
