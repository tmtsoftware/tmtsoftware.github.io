<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../../assets/tmt_favicon.ico">
<title>Command Service for Assemblies and HCDs Â· TMT Executive Software (ESW)</title>
<link rel="stylesheet" href="../../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../../lib/prettify/prettify.css">
<script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software (ESW)
</span>
<span class="md-header-nav__topic">
Command Service for Assemblies and HCDs
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../../../index.html" title="TMT Executive Software (ESW)">
TMT Executive Software (ESW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
<ul>
  <li><a href="../../../../sequencer/seqcompsequencer/index.html" class="page">Sequence Components and Sequencers</a>
  <ul>
    <li><a href="../../../../sequencer/seqcompsequencer/Terms.html" class="page">OCS Terms</a></li>
    <li><a href="../../../../sequencer/seqcompsequencer/SeqComp.html" class="page">Sequence Component</a></li>
    <li><a href="../../../../sequencer/seqcompsequencer/Sequencers.html" class="page">Sequencers</a></li>
    <li><a href="../../../../sequencer/seqcompsequencer/state-transition.html" class="page">Sequencer Lifecycle</a></li>
  </ul></li>
  <li><a href="../../../../sequencer/scripts/scripts.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/script-styles.html" class="page">Sequencer Script Styles</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../../../../commons/contracts.html" class="page">ESW Service contract</a></li>
  <li><a href="../../../../apps/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../../../../apps/sequencerapp.html" class="page">sequencer-app</a></li>
  </ul></li>
  <li><a href="../../../../eswgateway/esw-gateway.html" class="page">Esw Gateway</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#command-service-for-assemblies-and-hcds" class="header">Command Service for Assemblies and HCDs</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#assembly" class="header">Assembly</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#hcd" class="header">HCD</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#command-service-dsl" class="header">Command Service DSL</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#going-to-online-offline-mode" class="header">Going To online/offline Mode</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#operations-mode-and-diagnostic-mode" class="header">Operations Mode and Diagnostic Mode</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#locking-and-unlocking-assemblies-and-hcds" class="header">Locking and Unlocking Assemblies and HCDs</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#source-code-for-examples" class="header">Source code for examples</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#command-service-for-assemblies-and-hcds" class="header">Command Service for Assemblies and HCDs</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#assembly" class="header">Assembly</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#hcd" class="header">HCD</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#command-service-dsl" class="header">Command Service DSL</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#going-to-online-offline-mode" class="header">Going To online/offline Mode</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#operations-mode-and-diagnostic-mode" class="header">Operations Mode and Diagnostic Mode</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#locking-and-unlocking-assemblies-and-hcds" class="header">Locking and Unlocking Assemblies and HCDs</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/services/command-service.html#source-code-for-examples" class="header">Source code for examples</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#command-service-for-assemblies-and-hcds" name="command-service-for-assemblies-and-hcds" class="anchor"><span class="anchor-link"></span></a>Command Service for Assemblies and HCDs</h1>
<p>A Sequencer script can send commands to Assemblies and HCDs. This section describes the Command Service DSL that is a wrapper for the CSW Command Service module for sending commands to Assemblies or HCDs within scripts. You can refer to detailed documentation of the Command Service provided by CSW <a href="https://tmtsoftware.github.io/csw/0.1.0-SNAPSHOT/commons/command.html#commandservice">here</a>.</p>
<p>The DSL provides a way to define an Assembly or HCD as an object. This object encapsulates the Location Service and Command Service of CSW to provide a higher level DSL for script usage. This DSL exposes following APIs:</p>
<p>A Sequencer can also send Sequences to other Sequencers. See <a href="sequencer-command-service.html">here</a> for more information on sending Sequences to Sequencers.</p>
<h2><a href="#assembly" name="assembly" class="anchor"><span class="anchor-link"></span></a>Assembly</h2>
<p>The Assembly DSL method creates a Command Service entity for an Assembly with the provided <code>Prefix</code> that can be used to send commands from a script, such as sending Setups or Observes or lifecycle methods e.g. goOnline, goOffline, lock Assembly etc. This DSL method provides a default timeout which will be used for commands like submitAndWait, queryFinal etc, but also allows adding an Assembly-specific default timeout. The built-in default timeout is 10 seconds. Commands requiring a timeout also allow command-specific timeouts.</p>
<p>Assembly takes the following parameters:</p>
<ul>
  <li><code>prefix</code>: Prefix of the Assembly as defined in the Assembly&rsquo;s model file</li>
  <li><code>defaultTimeout</code>: optional command response timeout to be used when not explicitly provided for command</li>
</ul>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L16-L18" target="_blank" title="Go to snippet source"></a><code class="language-kts">val galilAssembly = Assembly(WFOS, &quot;FilterWheel&quot;)

val galilAssembly2 = Assembly(WFOS, &quot;FilterWheel&quot;, defaultTimeout = 20.seconds)</code></pre></dd>
</dl>
<h2><a href="#hcd" name="hcd" class="anchor"><span class="anchor-link"></span></a>HCD</h2>
<p>The HCD DSL method creates a Command Service DSL entity for an HCD with the provided <code>Prefix</code> that can be used to send commands from a script, such as sending Setups or Observes or lifecycle methods e.g. goOnline, goOffline, lock HCD etc. This DSL method provides a default timeout which will be used for commands like submitAndWait, queryFinal etc., but also allows adding an HCD-specific default timeout. The built-in timeout is 10.seconds. Commands requiring a timeout also allow command-specific timeouts.</p>
<p>HCD takes the following parameters:</p>
<ul>
  <li><code>prefix</code>: - Prefix of HCD as defined in the HCD&rsquo;s model file</li>
  <li><code>defaultTimeout</code>: - optional command response timeout to be used when not explicitly provided for command</li>
</ul>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L22-L24" target="_blank" title="Go to snippet source"></a><code class="language-kts">val filterWheelHcd = Hcd(WFOS, &quot;GalilHcd1&quot;)

val filterWheelHcd2 = Hcd(WFOS, &quot;GalilHcd1&quot;, defaultTimeout = 20.seconds)</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Resolving a Component with Location Service</div>
<p>Since all the components in the TMT architecture are dynamic in nature, which implies they can be shutdown and spawned dynamically on some other location, the Assembly/HCD is resolved each time the Command Service DSL is used. It is possible to create an Assembly or HCD entity for a non-existent component, but a command to the component will fail because the component is resolved when the command is sent. </p></div>
<h2><a href="#command-service-dsl" name="command-service-dsl" class="anchor"><span class="anchor-link"></span></a>Command Service DSL</h2>
<p>The Command Service API provided by the DSL for use in scripts is similar to the CommandService API provided by Scala or Java. The big difference is that the DSL does not return a Future. In the scripting language, even though the commands are asynchronous, each completes and returns its value, such as a <code>SubmitResponse</code>, not a <code>Future[SubmitResponse]</code>. This section describes each of the available DSL methods. </p>
<h3><a href="#submit" name="submit" class="anchor"><span class="anchor-link"></span></a>Submit</h3>
<p>The <code>submit</code> method of the DSL allows sending a <code>Setup</code> or <code>Observe</code> command to an Assembly/HCD. <code>submit</code> returns a positive <code>SubmitResponse</code> which can be <code>Completed</code> or <code>Started</code>. A very short command may quickly return <code>Completed</code>. A command that starts actions that are long-running returns <code>Started</code>. </p><div class="callout note "><div class="callout-title">submit or submitAndWait?</div>
<p><code>submit</code> is similar to <code>submitAndWait</code> in that both send a command to another component. <code>submit</code> is the right choice when the command starts long-running actions, and you need to take additional actions before the command completes. A successful long-running command returns a <code>Started</code> response that includes a <code>runId</code>, which can be used with <code>query</code> or <code>queryFinal</code> to wait for the commands final response at a later time.</p>
<p><code>submitAndWait</code> combines <code>submit</code> and <code>queryFinal</code> as a shortcut when you only need to wait for all started actions to complete before taking the next script step.</p></div>
<p>The following example shows a <code>submit</code> to the Galil Assembly that is going to take a long time.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L48-L61" target="_blank" title="Go to snippet source"></a><code class="language-kts">val parameters = intKey(&quot;target&quot;).set(100)
val galilCommand = Setup(&quot;ESW.IRIS_darkNight&quot;, &quot;moveWheel&quot;, command.obsId).add(parameters)
val startedResponse = galilAssembly.submit(galilCommand)</code></pre></dd>
</dl>
<h4><a href="#error-handling-in-scripts" name="error-handling-in-scripts" class="anchor"><span class="anchor-link"></span></a>Error Handling in Scripts</h4>
<p>In most cases errors encountered in the execution of a script will likely cause the command (and therefore, Sequence) to fail. Most of the time, not much can be done when an error occurs other than to report the error that occurred. In some cases, it is possible some remediation can be performed, but it is likely the Sequence would need to run again. For this reason, the error handling of commands in a script has been simplified such that errors from the Command Service DSL calls are captured and delivered to error handlers specific to a single sequence command handler, or global to the entire script. In this way, such error handling does not need to be repeated throughout the script for each command sent.</p>
<p>To add an error handler to a command handler, extend the command handler block with a <code>.onError</code> block. The <code>SubmitResponse</code> error is captured in a <code>ScriptError</code> type and passed into the block. This type contains a <code>reason</code> String explaining what went wrong. If the command handler does not have an <code>onError</code> block, the global error handler will be called. See the page on <a href="../constructs/handlers.html">Script Handlers</a> for more information. After this block is called, the command sending the sequence terminates with an Error status.</p>
<p>Because of this mechanism, a <code>submit</code> (and other Command Service API calls) always returns a positive <code>SubmitResponse</code>. For <code>submit</code>, the two possible responses are <code>Started</code> and <code>Completed</code>. They can be handled using the <code>.onStarted</code> and <code>.onCompleted</code> methods, respectively. These methods allow you to specify a block of code to be called in each of those cases. Alternatively, a Kotlin <code>when</code> can be used to perform pattern matching on the result. An example of both are shown below, along with an example of an <code>onError</code> handler for the sequence command handler. Since there are only two positive options, forming an if statement using the <code>isStarted</code> call on the <code>SubmitResponse</code> is convenient in many cases.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L75-L116" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;submit-error-handling&quot;) { command -&gt;

    /* =========== Scenario-1 (default) ============
     * if submit returns negative response (which is considered as error by default)
     * then current execution flow breaks and onError command handler gets invoked
     * Hence, only Started (in case of long-running command) or Completed (in case of short running command) response is returned
     */
    val parameters = intKey(&quot;target&quot;).set(100)
    val galilCommand = Setup(&quot;ESW.IRIS_darkNight&quot;, &quot;moveWheel&quot;, command.obsId).add(parameters)
    val positiveSubmitResponse: CommandResponse.SubmitResponse = galilAssembly.submit(galilCommand)

    //  First approach - using custom dsl (this is an alternative to kotlin pattern match using when)
    positiveSubmitResponse
            .onStarted { startedRes -&gt;
                val completedResponse = galilAssembly.queryFinal(startedRes.runId())
                info(&quot;command completed with result: ${completedResponse.result}&quot;)
            }
            .onCompleted { completed -&gt;
                info(&quot;command with ${completed.runId()} is completed with result: ${completed.result}&quot;)
            }

    // Second approach - using kotlin pattern matching
    when (positiveSubmitResponse) {
        is CommandResponse.Started -&gt; {
            val completedResponse = galilAssembly.queryFinal(positiveSubmitResponse.runId())
            info(&quot;command completed with response: $completedResponse&quot;)
        }
        is CommandResponse.Completed -&gt; info(&quot;command with ${positiveSubmitResponse.runId()} is completed&quot;)
    }

    // Third approach - use the isStarted value
    if (positiveSubmitResponse.isStarted) {
        val completedResponse = galilAssembly.queryFinal(positiveSubmitResponse.runId())
        info(&quot;command completed with result: ${completedResponse.result}&quot;)
    } else {
        info(&quot;command with ${positiveSubmitResponse.runId()} is completed with result: ${positiveSubmitResponse.result}&quot;)
    }

}.onError { err -&gt;
    // onError is called when submit command to galil assembly fails
    error(err.reason)
}</code></pre></dd>
</dl>
<p>If you desire to handle errors manually on a per-command basis, the <code>resumeOnError</code> flag can be used. If this flag is set to true, then script execution continues, and action is taken based on custom logic in the script using an <code>.onFailed</code> method. You can still choose to terminate the Sequence using the <code>onFailedTerminate</code> utility. This will cause similar behavior as when the flag is not set by calling the <code>onError</code> or <code>onGlobalError</code> blocks and terminating the sequence, if the <code>SubmitResponse</code> is some kind of error.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L120-L146" target="_blank" title="Go to snippet source"></a><code class="language-kts">onSetup(&quot;submit-error-handling-resume&quot;) { command -&gt;
    /* =========== Scenario-2 (resumeOnError = true) ============
     * if submit returns negative response
     * then current execution flow will continue because resumeOnError = true
     * Here, all the possible SubmitResponses are expected to be returned
     */
    val parameters = intKey(&quot;target&quot;).set(100)
    val galilCommand = Setup(&quot;ESW.iris_darkNight&quot;, &quot;moveWheel&quot;, command.obsId).add(parameters)
    val submitResponse: CommandResponse.SubmitResponse = galilAssembly.submit(galilCommand, resumeOnError = true)

    //  First approach - using custom dsl (this is an alternative to kotlin pattern match using when)
    submitResponse
            .onStarted { startedRes -&gt;
                val completedResponse = galilAssembly.queryFinal(startedRes.runId())
                info(&quot;command completed with result: ${completedResponse.result}&quot;)
            }
            .onCompleted { completed -&gt;
                info(&quot;command with ${completed.runId()} is completed with result: ${completed.result}&quot;)
            }
            .onFailed { negativeResponse -&gt;
                error(&quot;command with ${negativeResponse.runId()} is failed with result: $negativeResponse&quot;)

            }

    // Script writer can still choose to terminate sequence in case of negative response
    submitResponse.onFailedTerminate()
}</code></pre></dd>
</dl>
<h3><a href="#submitandwait" name="submitandwait" class="anchor"><span class="anchor-link"></span></a>SubmitAndWait</h3>
<p>The <code>submitAndWait</code> DSL method combines <code>submit</code> and <code>queryFinal</code> allowing you to submit a command to an Assembly/HCD and wait for the final response. A timeout can be specified if needed, indicating the time <code>submitAndWait</code> will wait to receive the final <code>SubmitResponse</code>. If this time expires, the command will timeout, breaking script execution flow, and the Sequence is terminated with failure. If timeout is not provided explicitly, then the timeout provided while creating the instance of Assembly or HCD is used as default timeout. This command follows the same error handling semantics as <code>submit</code> as described above.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L48-L51" target="_blank" title="Go to snippet source"></a><code class="language-kts">val parameters = intKey(&quot;target&quot;).set(100)
val galilCommand = Setup(&quot;ESW.IRIS_darkNight&quot;, &quot;moveWheel&quot;, command.obsId).add(parameters)
galilAssembly.submitAndWait(galilCommand, timeout = 20.seconds)</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Do I Need a Result Variable?</div>
<p>Note that this example does not save the <code>submitAndWait</code> result. If a <code>submitAndWait</code> does not return a result, and since the <code>submitAndWait</code> returns only after the actions are completed, and errors are handled elsewhere, there is not much reason to bother with the result. If it is the case where the command returns a result in the <code>Completed</code>, save the returned <code>Completed</code> value and retrieve the result.</p></div>
<h3><a href="#query" name="query" class="anchor"><span class="anchor-link"></span></a>Query</h3>
<p>The <code>query</code> DSL method allows you to check the status of a <code>submit</code> command that has returned a <code>Started</code> response . The <code>Started</code> response contains a <code>runId</code> that can be used to identify the command to <code>query</code>. The <code>query</code> command returns immediately while <code>queryFinal</code> waits for the final response. Therefore, <code>query</code> can be used to poll for the final response. Note that if the <code>runId</code> is not present or has been removed from the CRM, the response returned is an <code>Invalid</code> response with an <code>IdNotAvailableIssue</code>. This command follows the same error handling semantics as <code>submit</code> as described above.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L55-L56" target="_blank" title="Go to snippet source"></a><code class="language-kts">val response = galilAssembly.submit(command)
val queryResponse = galilAssembly.query(response.runId())</code></pre></dd>
</dl>
<h3><a href="#queryfinal" name="queryfinal" class="anchor"><span class="anchor-link"></span></a>QueryFinal</h3>
<p>The <code>queryFinal</code> DSL method allows querying for the final response of a <code>submit</code> command that has returned a <code>Started</code> response . The <code>Started</code> response contains a <code>runId</code> that can be used to identify the command. A timeout can be specified, indicating how long <code>queryFinal</code> wait for getting the final <code>SubmitResponse</code>. If this time expires, the command will timeout, breaking script execution flow, and the sequence is terminated with failure. If timeout is not provided explicitly, then the timeout provided while creating instance of Assembly/HCD is used. Note that if the <code>runId</code> is not present or has been removed from the CRM, the response returned is an <code>Invalid</code> response with an <code>IdNotAvailableIssue</code>. This command follows the same error handling semantics as <code>submit</code> as described above.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L61-L63" target="_blank" title="Go to snippet source"></a><code class="language-kts">val startedResponse = galilAssembly.submit(galilCommand)
val finalResponse = galilAssembly.queryFinal(startedResponse.runId())</code></pre></dd>
</dl>
<h3><a href="#subscribecurrentstate" name="subscribecurrentstate" class="anchor"><span class="anchor-link"></span></a>SubscribeCurrentState</h3>
<p>This DSL allows subscribing to the current state data of the Assembly/HCD. You can provide a list of state names to subscribe to. If not provided, all current state values are subscribed to. This DSL takes a callback (or lambda), which is called whenever the Assembly/HCD publishes an item in the list of subscribed values.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L67-L70" target="_blank" title="Go to snippet source"></a><code class="language-kts">galilAssembly.subscribeCurrentState(StateName(&quot;stateName1&quot;)) { currentState -&gt;
    // do something with currentState matching provided state name
    println(&quot;current state : $currentState&quot;)
}</code></pre></dd>
</dl>
<h2><a href="#going-to-online-offline-mode" name="going-to-online-offline-mode" class="anchor"><span class="anchor-link"></span></a>Going To online/offline Mode</h2>
<p>A Sequencer can command an Assembly or HCD to go to the online or offline state. This is a wrapper for putting another Assembly/HCD into Online or Offline mode. When an Assembly/HCD receives this command, its respective handlers are called. The detailed documentation of Online/Fffline handlers for Assembly/HCD can be found <a href="https://tmtsoftware.github.io/csw/0.1.0-SNAPSHOT/framework/handling-lifecycle.html#component-online-and-offline">here</a></p>
<h3><a href="#gooffline" name="gooffline" class="anchor"><span class="anchor-link"></span></a>goOffline</h3>
<p>A declared Assembly/HCD includes a DSL command puts an Assembly/HCD into Offline mode. <code>goOffline</code> can be called from anywhere in script. This results in the triggering of the <code>onGoOffline</code> handler in the component. The following example shows a Sequencer sending the <code>goOffline</code> command to a downstream &ldquo;Galil Assembly&rdquo; when it receives a <code>goOffline</code> command.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L164-L169" target="_blank" title="Go to snippet source"></a><code class="language-kts">onGoOffline {
    // do some actions to go offline

    galilAssembly.goOffline()

}</code></pre></dd>
</dl>
<h3><a href="#goonline" name="goonline" class="anchor"><span class="anchor-link"></span></a>goOnline</h3>
<p>A declared Assembly/HCD includes a DSL command to put an Assembly/HCD into Online mode. <code>goOnline</code> can be called from anywhere in the script. This results in the triggering of the <code>onGoOnline</code> handler in the component. The following example shows a Sequencer sending the <code>goOnline</code> command to a downstream &ldquo;Galil Assembly&rdquo; when it receives a <code>goOnline</code> command.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L173-L176" target="_blank" title="Go to snippet source"></a><code class="language-kts">onGoOnline {
    // do some actions to go online
    galilAssembly.goOnline()
}</code></pre></dd>
</dl>
<h2><a href="#operations-mode-and-diagnostic-mode" name="operations-mode-and-diagnostic-mode" class="anchor"><span class="anchor-link"></span></a>Operations Mode and Diagnostic Mode</h2>
<p>A Sequencer can place an Assembly or HCD in a diagnostic technical data mode. There are two methods in the Assembly/HCD Command Service DSL related to technical data collection.</p>
<h3><a href="#diagnosticmode" name="diagnosticmode" class="anchor"><span class="anchor-link"></span></a>diagnosticMode</h3>
<p>The <code>diagnosticMode</code> DSL method puts an Assembly/HCD into Diagnostic data mode based on a hint at the specified <code>startTime</code>. <code>diagnosticMode</code> can be called from anywhere in script. The hint is specifified by the component. Not all components have diagnostic modes for technical data. The following example shows a Sequencer sending the <code>diagnosticMode</code> command to a downstream &ldquo;Galil Assembly&rdquo; when it receives a <code>diagnosticMode</code> command.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L150-L153" target="_blank" title="Go to snippet source"></a><code class="language-kts">onDiagnosticMode { startTime, hint -&gt;
    // do some actions to go to diagnostic mode based on hint
    galilAssembly.diagnosticMode(startTime, hint)
}</code></pre></dd>
</dl>
<h3><a href="#operationsmode" name="operationsmode" class="anchor"><span class="anchor-link"></span></a>operationsMode</h3>
<p>This <code>operationsMode</code> DSL method returns an Assembly/HCD to Operations mode, the normal running mode. <code>operationsMode</code> can be called from anywhere in script. The following example shows a Sequencer sending the <code>operationsMode</code> command to a downstream &ldquo;Galil Assembly&rdquo; when it receives an <code>operationsMode</code> command.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L157-L160" target="_blank" title="Go to snippet source"></a><code class="language-kts">onOperationsMode {
    // do some actions to go to operations mode
    galilAssembly.operationsMode()
}</code></pre></dd>
</dl>
<h2><a href="#locking-and-unlocking-assemblies-and-hcds" name="locking-and-unlocking-assemblies-and-hcds" class="anchor"><span class="anchor-link"></span></a>Locking and Unlocking Assemblies and HCDs</h2>
<p>A Sequencer script can lock and unlock individual Assemblies and HCDs. When a Sequencer locks a component, it is the only component that can send commands to the component that will be accepted.</p>
<h3><a href="#lock" name="lock" class="anchor"><span class="anchor-link"></span></a>lock</h3>
<p>This Command Service DSL method locks an Assembly/HCD from a Sequencer script for the specified duration. When you lock an Assembly/HCD, the Sequencer sending the lock command is designated as the source, which is the only component that can send commands to the locked component while locked. This DSL returns a <code>LockingResponse</code> which can be <code>LockAcquired</code> in the successful scenario or <code>AcquiringLockFailed</code> in case of failure. This DSL also provides callbacks for <code>onLockAboutToExpire</code> and, <code>onLockExpired</code> where script writer can write custom logic. These callbacks are thread safe.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L29-L39" target="_blank" title="Go to snippet source"></a><code class="language-kts">galilAssembly.lock(
        leaseDuration = 20.seconds,
        onLockAboutToExpire = {
            // do something when lock is about to expire
            publishEvent(SystemEvent(&quot;ESW.test&quot;, &quot;TCS.lock.about.to.expire&quot;))
        },
        onLockExpired = {
            // do something when lock expired
            publishEvent(SystemEvent(&quot;ESW.test&quot;, &quot;TCS.lock.expired&quot;))
        }
)</code></pre></dd>
</dl>
<h3><a href="#unlock" name="unlock" class="anchor"><span class="anchor-link"></span></a>unlock</h3>
<p>This Command Service DSL method unlocks an Assembly/HCD from a Sequencer script. Only the Sequencer that locked the Assembly/HCD can unlock it. This DSL returns a <code>LockingResponse</code> which can be <code>LockReleased</code> or <code>LockAlreadyReleased</code> in the successful scenario or <code>ReleasingLockFailed</code> in case of failure.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts#L43" target="_blank" title="Go to snippet source"></a><code class="language-kts">galilAssembly.unlock()</code></pre></dd>
</dl>
<h2><a href="#source-code-for-examples" name="source-code-for-examples" class="anchor"><span class="anchor-link"></span></a>Source code for examples</h2>
<ul>
  <li><a href="https://github.com/tmtsoftware/esw/blob/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/CommandServiceDslExample.kts">Command Service Examples</a></li>
</ul>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/sequencer/scripts/dsl/services/command-service.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../../sequencer/scripts/dsl/services/config-service.html" title="Using the Configuration Service in Scripts" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Using the Configuration Service in Scripts
</span>
</div>
</a>
<a href="../../../../sequencer/scripts/dsl/services/sequencer-command-service.html" title="Sequencer Command Service" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Sequencer Command Service
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../../."}})</script>
<script type="text/javascript" src="../../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
