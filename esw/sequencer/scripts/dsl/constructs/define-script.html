<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../../assets/tmt_favicon.ico">
<title>Defining Script Â· TMT Executive Software (ESW)</title>
<link rel="stylesheet" href="../../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../../lib/prettify/prettify.css">
<script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Executive Software (ESW)
</span>
<span class="md-header-nav__topic">
Defining Script
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../../index.html" title="TMT Executive Software (ESW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../../../index.html" title="TMT Executive Software (ESW)">
TMT Executive Software (ESW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/esw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/esw
</div>
</a>

</div>
<ul>
  <li><a href="../../../../sequencer/scripts/scripts.html" class="page">Sequencer Scripts</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/script-constructs.html" class="page">Script DSL Constructs</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/csw-services.html" class="page">CSW Services DSL</a></li>
  </ul></li>
  <li><a href="../../../../sequencer/state-transition.html" class="page">Sequencer State Transition</a></li>
  <li><a href="../../../../apps/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../../../../apps/sequencerapp.html" class="page">sequencer-app</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#defining-script" class="header">Defining Script</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#regular-script" class="header">Regular Script</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#finite-state-machine-script-fsm-script-" class="header">Finite State Machine Script (FSM Script)</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#reusable-script" class="header">Reusable Script</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0-RC1
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#defining-script" class="header">Defining Script</a>
  <ul>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#regular-script" class="header">Regular Script</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#finite-state-machine-script-fsm-script-" class="header">Finite State Machine Script (FSM Script)</a></li>
    <li><a href="../../../../sequencer/scripts/dsl/constructs/define-script.html#reusable-script" class="header">Reusable Script</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#defining-script" name="defining-script" class="anchor"><span class="anchor-link"></span></a>Defining Script</h1>
<p>There are 3 variations of Sequencer Scripts. These variations are based the way the Script gets executed. The variations are:</p>
<ul>
  <li>Regular Script</li>
  <li>Finite State Machine Script (FSM Script)</li>
  <li>Reusable Script</li>
</ul>
<h2><a href="#regular-script" name="regular-script" class="anchor"><span class="anchor-link"></span></a>Regular Script</h2>
<p>Regular script is like a collection of <a href="handlers.html">script handlers</a> which executes the handlers of requested action or command. To define a regular script, a function named <code>script</code> needs to be invoked with a <em>block</em> which contains the logic of the script. The below example shows way to declare the script.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L15-L31" target="_blank" title="Go to snippet source"></a><code class="language-kts">import esw.ocs.dsl.core.script

script {
    // place to add Sequencer Script logic
}</code></pre></dd>
</dl>
<p>The logic can be divided into 2 parts:</p>
<ul>
  <li>Top-level statements (initialisation logic) : Executed while loading (initialising) the script.</li>
  <li>Script Handlers: Executed when a command to execute a particular handler is received.</li>
</ul>
<p><a href="handlers.html">Script handlers</a> are defined to process Sequence of Commands or to perform actions like Going online or offline, starting Diagnostic mode etc. Documentation of handlers can be found <a href="handlers.html">here</a>. Handlers will be executed whenever there is need to execute Sequence or to perform any action on Sequencer.</p>
<p>Everything except Script Handlers are considered as Top-level statements and will be executed while loading the script. This is the <strong>place to declare the Script specific variables</strong> and tasks to be executed at initialisation of the Script.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L35-L64" target="_blank" title="Go to snippet source"></a><code class="language-kts">script {
    info(&quot;Loading DarkNight script&quot;)

    val tromboneTemperatureAlarm =
            Key.AlarmKey(Prefix(NFIRAOS, &quot;trombone&quot;), &quot;tromboneMotorTemperatureAlarm&quot;)

    loopAsync(1.seconds) {
        setSeverity(tromboneTemperatureAlarm, getSeverity())
    }

    onSetup(&quot;basic-setup&quot;) { command -&gt;

        val intKey = intKey(&quot;angle&quot;)
        val angle = command.parameter(intKey).head()!!

        info(&quot;moving motor by : $angle&quot;)
        moveMotor(angle)
        info(&quot;motor moved to required position&quot;)
    }

    onObserve(&quot;start-observation&quot;) {
        info(&quot;opening the primary shutter to start observation&quot;)

        val openingStatusKey = stringKey(&quot;status&quot;).set(&quot;open&quot;)
        publishEvent(ObserveEvent(&quot;IRIS.primary_shutter&quot;, &quot;current-status&quot;, openingStatusKey))

        openPrimaryShutter()
    }

}</code></pre></dd>
</dl>
<p>The example mainly demos:</p>
<ul>
  <li>Top-level statements like declaring Script specific variable ( <em>tromboneTemperatureAlarm</em> ) , use of <a href="../script-constructs.html">Script Constructs</a> ( <em>loopAsync</em> ) and use of <a href="../csw-services.html">Csw Services</a> ( <em>info</em> - <a href="../services/logging-service.html">Logging Service</a>, <em>setSeverity</em> - <a href="../services/alarm-service.html">Alarm Service</a>)</li>
  <li>Defining <a href="handlers.html">Script Handlers</a> like <em>onSetup</em> , <em>onObserve</em> using <a href="../script-constructs.html">Csw Services</a>.</li>
</ul>
<h2><a href="#finite-state-machine-script-fsm-script-" name="finite-state-machine-script-fsm-script-" class="anchor"><span class="anchor-link"></span></a>Finite State Machine Script (FSM Script)</h2>
<p>FSM script is a way of writing Sequencer Script as <a href="https://en.wikipedia.org/wiki/Finite-state_machine" title="Finite State Machines (FSM)">Finite State Machines (FSM)</a>, where execution of Script Handler is dependent on the Current State of the Sequencer Script. </p>
<p>To define FSM Script a function <code>FSMScript</code> needs to be called with the <em>initial state</em> to start script with, and the block containing Script logic. The block contains initialisation logic and different states. </p>
<p>In FSM Script, Script handlers can be defined in two scopes :</p>
<ul>
  <li>Default scope - top-level scope of the Script</li>
  <li>State scope - scope of a specific state.</li>
</ul>
<p>The below code shows how to declare FSM Script and States. It also shows the scopes where handlers can be added.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L9-L85" target="_blank" title="Go to snippet source"></a><code class="language-kts">import esw.ocs.dsl.core.FsmScript

FsmScript(&quot;INIT&quot;) {

    // Default scope
    // place for Script variable declarations and initialisation statements

    state(&quot;INIT&quot;) { params -&gt;
        // Scope of INIT state
        // handlers of INTI state
    }

    state(&quot;IN-PROGRESS&quot;) {
        // Scope of IN-PROGRESS state
        // handlers of IN-PROGRESS state
    }

}</code></pre></dd>
</dl>
<p>Initialisation of the Script takes place by executing the top-level statements, and then executing the <em>initial state</em>. The <strong>top-level scope is the place to declare variables</strong> which can be used in Script. </p>
<p>While defining handlers there is restriction about <a href="handlers.html#command-handlers">Command handlers</a> that they can only be tied to State scope. Other <a href="handlers.html">Script handlers</a> except the Command handlers can be tied both scopes of FSM script.</p>
<p>To execute any action, corresponding handlers in current State scope will be executed first and then handlers in Default scope will be executed. In case of a Command Sequence, if the current state does not handle Command which is being executed, the Sequence will be completed with Error with reason <code>UnhandledCommandException</code>.</p>
<p>For state transition, <code>become</code> needs to called from the current state with <em>next state</em>. It will start evaluating the next state, and will execute further actions on the next state. If the <em>next state</em> is not defined in Script, then an exception will be thrown saying <em>No state declaration found for state</em>.</p>
<p>It is also possible to pass Params from current state to the next state by passing them as last argument to the <em>become</em> function. The passed Params will be available as a function parameter while defining any State.</p>
<p>In below example, <code>[[ 1 ]]</code> shows use of <code>become</code> to change state. where <code>[[ 2 ]]</code> shows how to pass Params while changing state. The ON state shows how to consumes the Params.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L95-L109" target="_blank" title="Go to snippet source"></a><code class="language-kts">state(&quot;ON&quot;) { params -&gt;

    onSetup(&quot;turn-off&quot;) {
        turnOffLight()
        become(&quot;OFF&quot;)                           // [[ 1 ]]
    }
}

state(&quot;OFF&quot;) {

    onSetup(&quot;turn-on&quot;) { command -&gt;
        turnOnLight()
        become(&quot;ON&quot;, command.params)           // [[ 2 ]]
    }
}</code></pre></dd>
</dl>
<p>The State scope can have top-level statements and Script handlers. The State&rsquo;s top-level statements will be executed when state transition happens. So invoking <em>become</em> will initialise the next state which includes calling the top-level statements. The State top-level can be used to declare variables limited to State scope which will last till state transition. After that, state will be cleared and next time it will be initialised again to default values. </p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L116-L136" target="_blank" title="Go to snippet source"></a><code class="language-kts">state(&quot;SETTING-UP&quot;) { params -&gt;

    val initialPos = params[intKey(&quot;current-position&quot;)].get().head()
    var moved = false

    onSetup(&quot;move&quot;) { command -&gt;
        val angle = command.params[intKey(&quot;angle&quot;)].get().head()
        moveBy(angle)
        moved = true

        info(&quot;moved from : $initialPos by angle : $angle&quot;)

        become(&quot;READY&quot;)
    }

    onGoOffline {
        stopSetup()
        info(&quot;Going in offline mode&quot;)
    }

}</code></pre></dd>
</dl>
<p>In the example, <code>initialPos</code> and <code>moved</code> demos declaring State scoped variables. Whenever state transition happens to some other state and back to SETTING-UP state, these variables will be reinitialised to its default values as defined in code. <em>Transition to self will not reinitialise variables</em>. </p>
<h2><a href="#reusable-script" name="reusable-script" class="anchor"><span class="anchor-link"></span></a>Reusable Script</h2>
<p>Reusable Scripts make it possible to write the <strong>common logic which needs to shared across multiple scripts</strong>. This can be used to create small building blocks for building Sequencer Scripts.</p>
<p>They are same as the <a href="define-script.html#regular-script">Regular Script</a> except they cannot be directly loaded into a Sequence Component, and can only be loaded into other Sequencer Scripts.</p>
<p>The common logic consists of Script handlers and the top-level statements(initialisation logic). The top-level statements will be executed while loading the script. Script handlers will be added to the corresponding handlers of the script loading it.</p>
<p>Following code declares a Reusable Script with Observe Command Handler.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L12-L154" target="_blank" title="Go to snippet source"></a><code class="language-kts">import esw.ocs.dsl.core.reusableScript

val startObservationScript = reusableScript {
    onObserve(&quot;start-observation&quot;) {
        info(&quot;opening the primary shutter to start observation&quot;)

        val openingStatusKey = stringKey(&quot;status&quot;).set(&quot;open&quot;)
        publishEvent(ObserveEvent(&quot;IRIS.primary_shutter&quot;, &quot;current-status&quot;, openingStatusKey))

        openPrimaryShutter()
    }

}</code></pre></dd>
</dl>
<h3><a href="#loading-in-regular-script" name="loading-in-regular-script" class="anchor"><span class="anchor-link"></span></a>Loading in Regular Script</h3>
<p>To use Reusable Scripts, the Regular script needs to call function called <code>loadScript</code> with the instance of Reusable Script. Calling <em>loadScript</em> will initialise the Reusable Script and then combine handlers of both scripts.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L158-L162" target="_blank" title="Go to snippet source"></a><code class="language-kts">script {

    loadScripts(startObservationScript)

}</code></pre></dd>
</dl>
<h3><a href="#loading-in-fsm-script" name="loading-in-fsm-script" class="anchor"><span class="anchor-link"></span></a>Loading in FSM Script</h3>
<p>A Reusable Script cannot be directly imported at top-level of FSM script. It can only be imported in a particular State of the FSM script. Loaded script is limited to that particular State. Below example loading script into a State.</p>
<dl>
  <dt>Kotlin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/esw/tree/master/examples/src/main/kotlin/esw/ocs/scripts/examples/paradox/DefineScriptExample.kts#L169-L173" target="_blank" title="Go to snippet source"></a><code class="language-kts">state(&quot;INIT&quot;) { params -&gt;

    loadScripts(startObservationScript)

}</code></pre></dd>
</dl>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw/tree/master/docs/src/main/sequencer/scripts/dsl/constructs/define-script.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0-RC1
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../../sequencer/scripts/dsl/script-constructs.html" title="Script DSL Constructs" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Script DSL Constructs
</span>
</div>
</a>
<a href="../../../../sequencer/scripts/dsl/constructs/handlers.html" title="Script Handlers" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Script Handlers
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../../."}})</script>
<script type="text/javascript" src="../../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
