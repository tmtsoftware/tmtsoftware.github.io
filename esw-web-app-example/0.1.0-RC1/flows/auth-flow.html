<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Adding Authentication Â· ESW Web Application Tutorial</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="ESW Web Application Tutorial" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
ESW Web Application Tutorial
</span>
<span class="md-header-nav__topic">
Adding Authentication
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="ESW Web Application Tutorial" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="ESW Web Application Tutorial">
ESW Web Application Tutorial
</a>
</label>
<ul>
  <li><a href="../flows/base-flow.html" class="page">Creating a Web Application</a></li>
  <li><a href="../flows/auth-flow.html" class="active page">Adding Authentication</a></li>
  <li><a href="../flows/db-flow.html" class="page">Adding Database Persistence</a></li>
  <li><a href="../flows/docs-flow.html" class="page">Adding Paradox Documentation</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../flows/auth-flow.html#adding-authentication" class="header">Adding Authentication</a>
  <ul>
    <li><a href="../flows/auth-flow.html#add-a-protected-route-in-backend" class="header">Add a Protected Route in Backend</a></li>
    <li><a href="../flows/auth-flow.html#consume-a-protected-route-in-the-frontend" class="header">Consume a Protected Route in the Frontend</a></li>
    <li><a href="../flows/auth-flow.html#try-it-out-" class="header">Try It Out!</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0-RC1
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../flows/auth-flow.html#adding-authentication" class="header">Adding Authentication</a>
  <ul>
    <li><a href="../flows/auth-flow.html#add-a-protected-route-in-backend" class="header">Add a Protected Route in Backend</a></li>
    <li><a href="../flows/auth-flow.html#consume-a-protected-route-in-the-frontend" class="header">Consume a Protected Route in the Frontend</a></li>
    <li><a href="../flows/auth-flow.html#try-it-out-" class="header">Try It Out!</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#adding-authentication" name="adding-authentication" class="anchor"><span class="anchor-link"></span></a>Adding Authentication</h1>
<p>Like the User Interface Gateway, a web application backend is a boundary between the public side of the observatory software system and the authenticated, protected control system. Because of this, a web application developer must be conscious of and support the authentication and authorization of its users according to the observatory security approach. </p>
<p>It&rsquo;s okay to have unprotected routes that are read-only and can not cause any changes, but any route that can change the control system must be protected with the correct level of authorization. This flow describes how to integrate authentication and authorization through the use of CSW AAS Service.</p>
<h2><a href="#add-a-protected-route-in-backend" name="add-a-protected-route-in-backend" class="anchor"><span class="anchor-link"></span></a>Add a Protected Route in Backend</h2>
<p>To demonstrate authorization, we will need to create a &ldquo;protected&rdquo; route, that is, an endpoint that requires a valid authorization token to access.</p>
<h3><a href="#add-new-route-with-protection" name="add-new-route-with-protection" class="anchor"><span class="anchor-link"></span></a>Add new route with protection</h3>
<p>We will add a new route to our server which is protected. To access this route, the request should contain a token containing the role <code>esw-user</code>. We have set up some <a href="https://tmtsoftware.github.io/csw/apps/cswservices.html#predefined-users-">sample users</a> when we start <code>csw-services</code> with the Authentication and Authorization Service enabled, and we will use one of these users for our tutorial.</p><div class="callout note "><div class="callout-title">Note</div>
<p>In the text above, <code>esw-user</code> is not a login or individual name; it is a role in the AAS security model. During operations, AAS will be configured to give individuals or logins specific roles. For now, we have created a few logins that have the same role as their login names.</p></div>
<p>Add the route code below to <code>SampleRoute.scala</code> from the basic flow. Note the route requires the user to have the <code>esw-user</code> role to access the endpoint.</p>
<p>If you deleted the tilde (~) at the end of your route in the last tutorial, be sure to put it back, and then append the following:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/backend/src/main/scala/org/tmt/sample/http/SampleRoute.scala#L32-L40" target="_blank" title="Go to snippet source">source</a><code class="language-scala">path(&quot;securedRaDecValues&quot;) {
  post {
    securityDirectives.sPost(RealmRolePolicy(&quot;Esw-user&quot;)) { _ =&gt;
      entity(as[RaDecRequest]) { raDecRequest =&gt;
        complete(raDecService.raDecToString(raDecRequest))
      }
    }
  }
}</code></pre></dd>
</dl>
<h2><a href="#consume-a-protected-route-in-the-frontend" name="consume-a-protected-route-in-the-frontend" class="anchor"><span class="anchor-link"></span></a>Consume a Protected Route in the Frontend</h2>
<p>Now, we will create a component in our frontend UI that uses our protected route.</p>
<h3><a href="#add-secured-post" name="add-secured-post" class="anchor"><span class="anchor-link"></span></a>Add secured Post</h3>
<p>Add the following method in <code>api.ts</code>, which sends a request to our <code>/securedRaValues</code> backend route.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/utils/api.ts#L20-L33" target="_blank" title="Go to snippet source">source</a><code class="language-ts">export const securedPostRaDecValues = async (
  baseUrl: string,
  raDecRequest: RaDecRequest,
  token: string
): Promise&lt;RaDecResponse | undefined&gt; =&gt;
  (
    await post&lt;RaDecRequest, RaDecResponse&gt;(
      baseUrl + &#39;securedRaDecValues&#39;,
      raDecRequest,
      {
        Authorization: `Bearer ${token}`
      }
    )
  ).parsedBody</code></pre></dd>
</dl>
<p>Note that this method requires an AAS authorization token, which is then passed to the server with the request.</p>
<h3><a href="#create-a-react-component-to-consume-our-secured-route" name="create-a-react-component-to-consume-our-secured-route" class="anchor"><span class="anchor-link"></span></a>Create a React component to consume our secured route</h3>
<p>In the <code>pages</code> folder, create a file named <code>SecuredRaDecInput.tsx</code>. Then create a <code>SecuredRaDecInput</code> React component with the following form.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/components/pages/SecuredRaDecInput.tsx#L11-L70" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">export const SecuredRaDecInput = (): JSX.Element =&gt; {
  return (
    &lt;Form
      onFinish={onFinish}
      style={{ padding: &#39;1rem&#39; }}
      wrapperCol={{
        span: 1
      }}&gt;
      &lt;Form.Item label=&#39;RaInDecimals (secured)&#39; name=&#39;raInDecimals&#39;&gt;
        &lt;Input role=&#39;RaInDecimals&#39; style={{ marginLeft: &#39;0.5rem&#39; }} /&gt;
      &lt;/Form.Item&gt;
      &lt;Form.Item label=&#39;DecInDecimals (secured)&#39; name=&#39;decInDecimals&#39;&gt;
        &lt;Input role=&#39;DecInDecimals&#39; /&gt;
      &lt;/Form.Item&gt;
      &lt;Form.Item&gt;
        &lt;Button type=&#39;primary&#39; htmlType=&#39;submit&#39; role=&#39;Submit&#39;&gt;
          Submit
        &lt;/Button&gt;
      &lt;/Form.Item&gt;
    &lt;/Form&gt;
  )
}</code></pre></dd>
</dl>
<h3><a href="#use-secured-post-in-our-component" name="use-secured-post-in-our-component" class="anchor"><span class="anchor-link"></span></a>Use secured Post in our component</h3>
<p>Again, a reference to the Location Service is obtained via a context named <code>LocationServiceProvider</code>. Since this component requires authorization, we use another context to get a reference to the authorization system.</p>
<p>Add the following as first lines inside the <code>SecuredRaDecInput</code> component.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/components/pages/SecuredRaDecInput.tsx#L11-L14" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">export const SecuredRaDecInput = (): JSX.Element =&gt; {
  const locationService = useLocationService()
  const { auth } = useAuth()</code></pre></dd>
</dl>
<p>The <code>useAuth</code> method is a hook provided in <code>hooks/useAuth.tsx</code> that accesses the context. Like <code>LocationServiceProvider</code>, the <code>AuthContextProvider</code> context is made available to the component during construction in <code>App.tsx</code>.</p>
<p>Now, add an <code>onFinish</code> handler above the return statement, similar to our non-secured component. Note that this time we will obtain the token from the authorization context and pass that to our API method.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/components/pages/SecuredRaDecInput.tsx#L18-L46" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">const onFinish = async (values: RaDecRequest) =&gt; {
  const backendUrl = await getBackendUrl(locationService)
  const valueInDecimal = {
    raInDecimals: Number(values.raInDecimals),
    decInDecimals: Number(values.decInDecimals)
  }

  if (backendUrl) {
    const token = auth?.token()
    if (!token) {
      errorMessage(&#39;Failed to greet user: Unauthenticated request&#39;)
    } else {
      const response = await securedPostRaDecValues(
        backendUrl,
        valueInDecimal,
        token
      )
      if (response?.formattedRa &amp;&amp; response?.formattedDec) {
        console.log(response.formattedRa)
        console.log(response.formattedDec)
      } else {
        console.error(response)
        throw new Error(
          &#39;Invalid response, formattedRa or formattedDec field is missing&#39;
        )
      }
    }
  }
}</code></pre></dd>
</dl>
<p>Don&rsquo;t forget to add the necessary imports!</p>
<h3><a href="#connect-our-new-component" name="connect-our-new-component" class="anchor"><span class="anchor-link"></span></a>Connect our new component</h3>
<p>Next, we will add the protected route in <code>Routes.tsx</code> within the <code>&lt;Switch&gt;</code> block, before the catch-all <code>*</code> route.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/routes/Routes.tsx#L15" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">&lt;ProtectedRoute path=&#39;/securedRaDec&#39; component={SecuredRaDecInput} /&gt;</code></pre></dd>
</dl>
<p>Add an action for our new route in <code>MenuBar.tsx</code> below the previously added RaDec <code>Menu.Item</code></p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/components/menu/MenuBar.tsx#L18-L32" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">&lt;Menu mode=&#39;horizontal&#39;&gt;
  &lt;Menu.Item key=&#39;raDec&#39;&gt;
    &lt;Link to=&#39;/&#39;&gt;RaDec&lt;/Link&gt;
  &lt;/Menu.Item&gt;
  &lt;Menu.Item key=&#39;securedRaDec&#39;&gt;
    &lt;Link to=&#39;/securedRaDec&#39;&gt;SecuredRaDec&lt;/Link&gt;
  &lt;/Menu.Item&gt;
&lt;/Menu&gt;</code></pre></dd>
</dl>
<h3><a href="#add-login-logout-functionality" name="add-login-logout-functionality" class="anchor"><span class="anchor-link"></span></a>Add Login &amp; Logout functionality</h3>
<p>To get the authorization token the user needs to log in. To provide login and logout capabilities, we will make use of the generated <code>Login</code> and <code>Logout</code> components.</p>
<p>Add menu item actions for logging in and logging out in <code>MenuBar.tsx</code> below the previously added SecuredRaDec <code>Menu.Item</code> The menu item will change depending on whether the user is logged in or not to show protected functionality.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/components/menu/MenuBar.tsx#L24-L28" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">&lt;Menu.Item key=&#39;securedRaDec&#39;&gt;
  &lt;Link to=&#39;/securedRaDec&#39;&gt;SecuredRaDec&lt;/Link&gt;
&lt;/Menu.Item&gt;
{isAuthenticated ? &lt;Logout logout={logout} /&gt; : &lt;Login login={login} /&gt;}</code></pre></dd>
</dl>
<p>Note the authorization hook is used again here to get a handle to the authorization store.</p>
<dl>
  <dt>Typescript</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/frontend/src/components/menu/MenuBar.tsx#L9-L11" target="_blank" title="Go to snippet source">source</a><code class="language-tsx">export const MenuBar = (): JSX.Element =&gt; {
  const { auth, login, logout } = useAuth()
  const isAuthenticated = auth?.isAuthenticated() ?? false</code></pre></dd>
</dl>
<h2><a href="#try-it-out-" name="try-it-out-" class="anchor"><span class="anchor-link"></span></a>Try It Out!</h2>
<p>Compile the backend and restart it. Then run the UI as before and try it out.</p>
<p>Notice the menu bar shows a &ldquo;Login&rdquo; item, since we haven&rsquo;t logged in</p>
<p><img src="webAppMenuLogin.png" alt="Menu Bar with Login" /></p>
<p>Clicking on the &ldquo;Login&rdquo; (or &ldquo;SecuredRaDec&rdquo;) menu item will take you to the login page. Be sure to log in with the<code>esw-user1</code> user with the password <code>esw-user1</code>. </p>
<p>You may note the &ldquo;Login&rdquo; menu item has changed to &ldquo;Logout&rdquo;. </p>
<p><img src="webAppMenuLogout.png" alt="Menu Bar with Logout" /></p>
<p>Once logged in, you will be able to use the SecuredRaDec form. The behavior is the same as the non-secured version, but it gives you the idea of how pages and routes can be protected. </p>
<p><strong>Nice Work!</strong></p>
</div>
<div>
<a href="https://github.com/tmtsoftware/esw-web-app-example/tree/master/docs/src/main/flows/auth-flow.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0-RC1
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../flows/base-flow.html" title="Creating a Web Application" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Creating a Web Application
</span>
</div>
</a>
<a href="../flows/db-flow.html" title="Adding Database Persistence" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Adding Database Persistence
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
