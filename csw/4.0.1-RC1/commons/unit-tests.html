<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Adding Unit Tests Â· TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Adding Unit Tests
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../commons/unit-tests.html" class="active page">Adding Unit Tests</a></li>
  <li><a href="../commons/params.html" class="page">Params</a>
  <ul>
    <li><a href="../params/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../params/units.html" class="page">Units</a></li>
    <li><a href="../params/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../params/commands.html" class="page">Commands</a></li>
    <li><a href="../params/events.html" class="page">Events</a></li>
    <li><a href="../params/states.html" class="page">State Variables</a></li>
    <li><a href="../params/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/logging_aggregator.html" class="page">Logging Aggregator</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="page">Event Service</a></li>
    <li><a href="../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../services/time.html" class="page">Time Service</a></li>
    <li><a href="../services/database.html" class="page">Database Service</a></li>
    <li><a href="../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
    <li><a href="../services/sequencer-command-service.html" class="page">Sequencer Command Service</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/csinstallation.html" class="page">Coursier Installation</a></li>
    <li><a href="../apps/cswservices.html" class="page">csw-services</a></li>
    <li><a href="../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/deployment.html" class="page">Deployment</a>
  <ul>
    <li><a href="../deployment/env-vars.html" class="page">Environment variables</a></li>
    <li><a href="../deployment/network-topology.html" class="page">Network Topology</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
  <li><a href="../migration_guide/migration-guides.html" class="page">Migration Guides</a>
  <ul>
    <li><a href="../migration_guide/migration_guide_1.0.0_to_2.0.0/migration-guide-1.0.0-to-2.0.0.html" class="page">Migration Guide from 1.0.0 to 2.0.0</a></li>
    <li><a href="../migration_guide/migration_guide_2.0_to_3.0/migration-guide-2.0-to-3.0.html" class="page">Migration Guide from 2.0 to 3.0</a></li>
    <li><a href="../migration_guide/migration_guide_3.0.0_to_4.0.0/migration-guide-3.0.0-to-4.0.0.html" class="page">Migration Guide from 3.0.0 to 4.0.0</a></li>
  </ul></li>
  <li><a href="../commons/contract.html" class="page">CSW Service contract</a></li>
  <li><a href="../technical/technical.html" class="page">Technical Design Documents</a>
  <ul>
    <li><a href="../technical/framework/framework.html" class="page">Framework</a></li>
    <li><a href="../technical/command/command.html" class="page">Command</a></li>
    <li><a href="../technical/params/params.html" class="page">Params</a></li>
    <li><a href="../technical/units/adding-unit.html" class="page">Adding a new unit</a></li>
    <li><a href="../technical/location/location.html" class="page">Location Service</a></li>
    <li><a href="../technical/configuration/configuration.html" class="page">Configuration Service</a></li>
    <li><a href="../technical/logging/logging.html" class="page">Logging Service</a></li>
    <li><a href="../technical/event/event.html" class="page">Event Service</a></li>
    <li><a href="../technical/alarm/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../technical/time/time.html" class="page">Time Service</a></li>
    <li><a href="../technical/database/database.html" class="page">Database Service</a></li>
    <li><a href="../technical/aas/aas.html" class="page">Authentication and Authorization Service</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../commons/unit-tests.html#adding-unit-tests" class="header">Adding Unit Tests</a>
  <ul>
    <li><a href="../commons/unit-tests.html#csw-test-kit" class="header">CSW Test Kit</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 4.0.1-RC1
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../commons/unit-tests.html#adding-unit-tests" class="header">Adding Unit Tests</a>
  <ul>
    <li><a href="../commons/unit-tests.html#csw-test-kit" class="header">CSW Test Kit</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#adding-unit-tests" name="adding-unit-tests" class="anchor"><span class="anchor-link"></span></a>Adding Unit Tests</h1>
<p>Unit testing is a fundamental part of programming, and essential component of the TMT quality assurance policy. TMT CSW extensively uses unit testing for both Scala and Java code, using ScalaTest for the former, and primarily JUnit for the latter (TestNG is used in one instance for the Event Service). While this guide will not attempt to educate the reader on how to use these popular packages, it will serve to show some examples of how tests can be created for component code and demonstrate some tools provided by CSW to simplify and enable integration of TMT components and other software with CSW and its services.</p>
<h2><a href="#csw-test-kit" name="csw-test-kit" class="anchor"><span class="anchor-link"></span></a>CSW Test Kit</h2>
<p>CSW provides a set of tools for use by developers called the CSW Test Kit. This allows the developer to start CSW services within the testing environment, so that they can be accessed by the components and/or applications being tested, as well as the testing fixtures themselves. It also provides simple methods to start components or a set of components within a container, as well as an ActorContext to be used if other Actors are needed to be created in the tests.</p>
<p>More information about testing with CSW and the CSW Test Kit can be found <a href="testing.html">here</a>.</p>
<h3><a href="#" name="" class="anchor"><span class="anchor-link"></span></a><em>Tutorial: Writing unit tests for our components</em></h3>
<p>In this part of the tutorial, we will write a few unit tests for our components. These tests are in no way meant to be comprehensive, but hopefully, they show enough to get you started.</p>
<p>The giter8 template provides the required directory structure, and skeletons for tests of the HCD and Assembly in both Java and Scala. It also provides some Component Configuration (ComponentInfo) files for running each of the HCD and Assembly in standalone mode for both languages. They are there for convenience, but may not be required depending your deployment and testing strategy. We will be using them in our tutorial.</p>
<p>We will first look at the tests for the Assembly. As described on the <a href="testing.html">Testing Manual page</a>, the Scala version overrides the CSW-provided superclass <code>csw.testkit.scaladsl.ScalaTestFrameworkTestKit</code> to get access to the services it needs. By passing in the needed services in the constructor, those services are started in the superclass&rsquo;s <code>beforeAll</code> method. In the Java version, we must create an instance of <code>csw.testkit.javadsl.FrameworkTestKitJunitResource</code> to get access to and start our services, with the services we want to start passed into the constructor of this object.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/sample/SampleTest.scala#L20-L21" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class SampleTest extends ScalaTestFrameworkTestKit(AlarmServer, EventServer) with AnyFunSuiteLike {
  import frameworkTestKit._</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/sample/JSampleTest.java#L24-L27" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class JSampleTest extends JUnitSuite {
    @ClassRule
    public static final FrameworkTestKitJunitResource testKit =
            new FrameworkTestKitJunitResource(Arrays.asList(JCSWService.AlarmServer, JCSWService.EventServer));</code></pre></dd>
</dl>
<p>For our tests, we will want to run the Assembly first. We will do this in the <code>beforeAll</code> method in Scala, and in a method with a <code>@BeforeClass</code> annotation in Java, so that it is run only once, before any of the tests are run. The Component Configuration files use are the one provided by the giter8 template. Note that for Scala, we must call the superclass&rsquo;s <code>beforeAll</code> method to ensure the services are run.</p><div class="callout note "><div class="callout-title">Note</div>
<p>This code has been provided as part of the giter8 template.</p></div>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/sample/SampleTest.scala#L25-L28" target="_blank" title="Go to snippet source">source</a><code class="language-scala">override def beforeAll(): Unit = {
  super.beforeAll()
  spawnStandalone(com.typesafe.config.ConfigFactory.load(&quot;SampleStandalone.conf&quot;))
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/sample/JSampleTest.java#L31-L34" target="_blank" title="Go to snippet source">source</a><code class="language-java">@BeforeClass
public static void setup() {
    testKit.spawnStandalone(com.typesafe.config.ConfigFactory.load(&quot;JSampleStandalone.conf&quot;));
}</code></pre></dd>
</dl>
<p>Next, let&rsquo;s add a test. We will add a simple test that uses the Location Service to make sure the Assembly is running and resolve the registration information for it. </p><div class="callout note "><div class="callout-title">Note</div>
<p>This test has been provided as part of the giter8 template as an example.</p></div>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/sample/SampleTest.scala#L32-L38" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import scala.concurrent.duration._
test(&quot;Assembly should be locatable using Location Service&quot;) {
  val connection   = AkkaConnection(ComponentId(Prefix(CSW, &quot;sample&quot;), ComponentType.Assembly))
  val akkaLocation = Await.result(locationService.resolve(connection, 10.seconds), 10.seconds).get

  akkaLocation.connection shouldBe connection
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/sample/JSampleTest.java#L38-L45" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Test
public void testAssemblyShouldBeLocatableUsingLocationService() throws ExecutionException, InterruptedException {
    AkkaConnection connection = new AkkaConnection(new ComponentId(Prefix.apply(JSubsystem.CSW, &quot;sample&quot;), JComponentType.Assembly));
    ILocationService locationService = testKit.jLocationService();
    AkkaLocation location = locationService.resolve(connection, Duration.ofSeconds(10)).get().orElseThrow();

    Assert.assertEquals(location.connection(), connection);
}</code></pre></dd>
</dl>
<p>You can try running the test either using sbt (<code>sbt test</code> from the project root directory) or directly in the IDE. If you are using IntelliJ, you can run the test by right-clicking on the file in the project explorer and clicking on <code>Run &#39;SampleTest&#39;</code> or <code>Run &#39;JSampleTest&#39;</code>. You can also right-click in the class body or the specific test body, if you want to run a single test.</p>
<p>The Assembly we have written does not have much of a public API, so we&rsquo;ll turn to the HCD now, which has a few additional things we can test, including the publishing of Events and the handling of commands.</p>
<p>First, we will set up the test fixtures similarly as we did for the Assembly, and add a similar test to show the component registers itself with the Location Service on startup.</p><div class="callout note "><div class="callout-title">Note</div>
<p>This also has been provided in the giter8 template.</p></div>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/samplehcd/SampleHcdTest.scala#L24-L38" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class SampleHcdTest extends ScalaTestFrameworkTestKit(AlarmServer, EventServer) with AnyFunSuiteLike with BeforeAndAfterEach {
  import frameworkTestKit._

  override def beforeAll(): Unit = {
    super.beforeAll()
    spawnStandalone(com.typesafe.config.ConfigFactory.load(&quot;SampleHcdStandalone.conf&quot;))
  }

  import scala.concurrent.duration._
  test(&quot;HCD should be locatable using Location Service&quot;) {
    val connection   = AkkaConnection(ComponentId(Prefix(&quot;CSW.samplehcd&quot;), ComponentType.HCD))
    val akkaLocation = Await.result(locationService.resolve(connection, 10.seconds), 10.seconds).get

    akkaLocation.connection shouldBe connection
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/samplehcd/JSampleHcdTest.java#L46-L65" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class JSampleHcdTest extends JUnitSuite {

    @ClassRule
    public static final FrameworkTestKitJunitResource testKit =
            new FrameworkTestKitJunitResource(Arrays.asList(JCSWService.AlarmServer, JCSWService.EventServer));


    @BeforeClass
    public static void setup() {
        testKit.spawnStandalone(com.typesafe.config.ConfigFactory.load(&quot;JSampleHcdStandalone.conf&quot;));
    }

    @Test
    public void testHCDShouldBeLocatableUsingLocationService() throws ExecutionException, InterruptedException {
        AkkaConnection connection = new AkkaConnection(new ComponentId(Prefix.apply(JSubsystem.CSW, &quot;samplehcd&quot;), JComponentType.HCD));
        ILocationService locationService = testKit.jLocationService();
        AkkaLocation location = locationService.resolve(connection, Duration.ofSeconds(10)).get().orElseThrow();

        Assert.assertEquals(connection, location.connection());
    }</code></pre></dd>
</dl>
<p>Now let&rsquo;s add a test to verify our component is publishing. We will set up a test subscriber to the <code>counterEvent</code> Events published by the HCD. Since we cannot guarantee the order in which the tests are run, we cannot be certain how long the component has been running when this specific test is run. Therefore, checking the contents of the Events received is tricky. We will wait a bit at the start of the test to ensure we don&rsquo;t get a InvalidEvent, which would be returned if we start our subscription before the HCD publishes any Events. Then, after setting up the subscription, we wait 5 seconds to allow the HCD to publish two additional Events plus the one we receive when the subscription starts. We will look at the counter value of the first <code>counterEvent</code> to determine what the set of counter values we expect to get in our subscription.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/samplehcd/SampleHcdTest.scala#L42-L80" target="_blank" title="Go to snippet source">source</a><code class="language-scala">test(&quot;should be able to subscribe to HCD events&quot;) {
  val counterEventKey = EventKey(Prefix(&quot;CSW.samplehcd&quot;), EventName(&quot;HcdCounter&quot;))
  val hcdCounterKey   = KeyType.IntKey.make(&quot;counter&quot;)

  val subscriber = eventService.defaultSubscriber

  // wait for a bit to ensure HCD has started and published an event
  Thread.sleep(2000)

  val subscriptionEventList = mutable.ListBuffer[Event]()
  subscriber.subscribeCallback(Set(counterEventKey), { ev =&gt; subscriptionEventList.append(ev) })

  // Sleep for 5 seconds, to allow HCD to publish events
  Thread.sleep(5000)

  // Q. Why expected count is either 3 or 4?
  // A. Total sleep = 7 seconds (2 + 5), subscriber listens for all the events between 2-7 seconds
  //  1)  If HCD publish starts at 1st second
  //      then events published at 1, 3, 5, 7, 9 etc. seconds
  //      In this case, subscriber will receive events at 2(initial), 3, 5, 7, i.e. total 4 events
  //  2)  If HCD publish starts at 1.5th seconds
  //      then events published at 1.5, 3.5, 5.5, 7.5, 9.5 etc. seconds
  //      In this case, subscriber will receive events at 2(initial), 3.5, 5.5, i.e. total 3 events
  val recEventsCount = subscriptionEventList.toList.size
  recEventsCount should (be(3) or be(4))

  // extract counter values to a List for comparison
  val counterList = subscriptionEventList.toList.map {
    case sysEv: SystemEvent if sysEv.contains(hcdCounterKey) =&gt; sysEv(hcdCounterKey).head
    case _                                                   =&gt; -1
  }

  // we don&#39;t know exactly how long HCD has been running when this test runs,
  // so we don&#39;t know what the first value will be,
  // but we know we should get three consecutive numbers
  val expectedCounterList = (0 to 2).toList.map(_ + counterList.head)

  counterList shouldBe expectedCounterList
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/samplehcd/JSampleHcdTest.java#L69-L121" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Test
public void testShouldBeAbleToSubscribeToHCDEvents() throws InterruptedException, ExecutionException {
    EventKey counterEventKey = new EventKey(Prefix.apply(&quot;csw.samplehcd&quot;), new EventName(&quot;HcdCounter&quot;));
    Key&lt;Integer&gt; hcdCounterKey = JKeyType.IntKey().make(&quot;counter&quot;, JUnits.NoUnits);
    IEventService eventService = testKit.jEventService();
    IEventSubscriber subscriber = eventService.defaultSubscriber();

    // wait for a bit to ensure HCD has started and published an event
    Thread.sleep(3000);

    ArrayList&lt;Event&gt; subscriptionEventList = new ArrayList&lt;&gt;();
    IEventSubscription subscription = subscriber.subscribeCallback(Set.of(counterEventKey), event -&gt; {
        // discard invalid event
        if (!event.isInvalid()) {
            subscriptionEventList.add(event);
        }
    });
    subscription.ready().get();

    // Sleep for 5 seconds, to allow HCD to publish events
    Thread.sleep(5000);

    // Q. Why expected count is either 3 or 4?
    // A. Total sleep = 7 seconds (2 + 5), subscriber listens for all the events between 2-7 seconds
    //  1)  If HCD publish starts at 1st second
    //      then events published at 1, 3, 5, 7, 9 etc. seconds
    //      In this case, subscriber will receive events at 2(initial), 3, 5, 7, i.e. total 4 events
    //  2)  If HCD publish starts at 1.5th seconds
    //      then events published at 1.5, 3.5, 5.5, 7.5, 9.5 etc. seconds
    //      In this case, subscriber will receive events at 2(initial), 3.5, 5.5, i.e. total 3 events
    int recEventsCount = subscriptionEventList.size();
    Assert.assertTrue(&quot;expected:&lt;3&gt; or &lt;4&gt; but was:&lt;&quot; + recEventsCount + &quot;&gt;&quot;, recEventsCount == 3 || recEventsCount == 4);

    // extract counter values to a List for comparison
    List&lt;Integer&gt; counterList = subscriptionEventList.stream()
            .map(ev -&gt; {
                SystemEvent sysEv = ((SystemEvent) ev);
                if (sysEv.contains(hcdCounterKey)) {
                    return sysEv.parameter(hcdCounterKey).head();
                } else {
                    return -1;
                }
            })
            .collect(Collectors.toList());

    // we don&#39;t know exactly how long HCD has been running when this test runs,
    // so we don&#39;t know what the first value will be,
    // but we know we should get three consecutive numbers
    int counter0 = counterList.get(0);
    List&lt;Integer&gt; expectedCounterList = Arrays.asList(counter0, counter0 + 1, counter0 + 2);

    Assert.assertEquals(expectedCounterList, counterList);
}</code></pre></dd>
</dl>
<p>Next, we&rsquo;ll add a test for command handling in the HCD. The HCD supports a &ldquo;sleep&rdquo; command, which sleeps some amount of seconds as specified in the command payload, and then returns a <code>CommandResponse.Completed</code>. We will specify a sleep of 5 seconds, and then check that we get the expected response. Note that the obtaining a <code>CommandService</code> reference in Java requires an Akka Typed Actor System, so our code will create one using the Actor System provided by the Test Kit. In Scala, <code>import frameworkTestkit._</code> brings in implicit Actor System in scope, hence you do not need to create one in your test.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/samplehcd/SampleHcdTest.scala#L84-L102" target="_blank" title="Go to snippet source">source</a><code class="language-scala">test(&quot;should be able to send sleep command to HCD&quot;) {
  import scala.concurrent.duration._
  implicit val sleepCommandTimeout: Timeout = Timeout(10000.millis)

  // Construct Setup command
  val sleepTimeKey: Key[Long]         = KeyType.LongKey.make(&quot;SleepTime&quot;)
  val sleepTimeParam: Parameter[Long] = sleepTimeKey.set(5000).withUnits(Units.millisecond)
  val setupCommand = Setup(Prefix(&quot;csw.move&quot;), CommandName(&quot;sleep&quot;), Some(ObsId(&quot;2020A-001-123&quot;))).add(sleepTimeParam)

  val connection = AkkaConnection(ComponentId(Prefix(CSW, &quot;samplehcd&quot;), ComponentType.HCD))

  val akkaLocation = Await.result(locationService.resolve(connection, 10.seconds), 10.seconds).get

  val hcd = CommandServiceFactory.make(akkaLocation)
  // submit command and handle response
  val responseF = hcd.submitAndWait(setupCommand)

  Await.result(responseF, 10000.millis) shouldBe a[Completed]
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/samplehcd/JSampleHcdTest.java#L125-L147" target="_blank" title="Go to snippet source">source</a><code class="language-java">private final ActorSystem&lt;SpawnProtocol.Command&gt; typedActorSystem = testKit.actorSystem();

// DEOPSCSW-39: examples of Location Service
@Test
public void testShouldBeAbleToSendSleepCommandToHCD() throws ExecutionException, InterruptedException, TimeoutException {

    // Construct Setup command
    Key&lt;Long&gt; sleepTimeKey = JKeyType.LongKey().make(&quot;SleepTime&quot;, JUnits.millisecond);
    Parameter&lt;Long&gt; sleepTimeParam = sleepTimeKey.set(1000L);

    Setup setupCommand = new Setup(Prefix.apply(JSubsystem.CSW, &quot;move&quot;), new CommandName((&quot;sleep&quot;)), Optional.of(ObsId.apply(&quot;2020A-001-123&quot;))).add(sleepTimeParam);

    Timeout commandResponseTimeout = new Timeout(5, TimeUnit.SECONDS);

    AkkaConnection connection = new AkkaConnection(new ComponentId(Prefix.apply(JSubsystem.CSW, &quot;samplehcd&quot;), JComponentType.HCD));
    ILocationService locationService = testKit.jLocationService();
    AkkaLocation location = locationService.resolve(connection, Duration.ofSeconds(5)).get().orElseThrow();

    ICommandService hcd = CommandServiceFactory.jMake(location, typedActorSystem);

    CommandResponse.SubmitResponse result = hcd.submitAndWait(setupCommand, commandResponseTimeout).get(5, TimeUnit.SECONDS);
    Assert.assertTrue(result instanceof CommandResponse.Completed);
}</code></pre></dd>
</dl>
<p>Finally, we will show an example of tests that check that exceptions are thrown when expected. We will do this by using the &ldquo;sleep&rdquo; command, but failing to wait long enough for the sleep to complete. This causes a <code>TimeoutException</code> in Scala, and an <code>ExecutionException</code> in Java, and our tests check to see that these types are in fact thrown.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/samplehcd/SampleHcdTest.scala#L106-L126" target="_blank" title="Go to snippet source">source</a><code class="language-scala">test(&quot;should get timeout exception if submit timeout is too small&quot;) {
  import scala.concurrent.duration._
  implicit val sleepCommandTimeout: Timeout = Timeout(1000.millis)

  // Construct Setup command
  val sleepTimeKey: Key[Long]         = KeyType.LongKey.make(&quot;SleepTime&quot;)
  val sleepTimeParam: Parameter[Long] = sleepTimeKey.set(5000).withUnits(Units.millisecond)
  val setupCommand = Setup(Prefix(&quot;csw.move&quot;), CommandName(&quot;sleep&quot;), Some(ObsId(&quot;2020A-001-123&quot;))).add(sleepTimeParam)

  val connection = AkkaConnection(ComponentId(Prefix(CSW, &quot;samplehcd&quot;), ComponentType.HCD))

  val akkaLocation = Await.result(locationService.resolve(connection, 10.seconds), 10.seconds).get

  val hcd = CommandServiceFactory.make(akkaLocation)

  // submit command and handle response
  intercept[java.util.concurrent.TimeoutException] {
    val responseF = hcd.submitAndWait(setupCommand)
    Await.result(responseF, 10000.millis) shouldBe a[Completed]
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/java/org/tmt/csw/samplehcd/JSampleHcdTest.java#L151-L170" target="_blank" title="Go to snippet source">source</a><code class="language-java"><br/>@Test
public void testShouldGetExecutionExceptionIfSubmitTimeoutIsTooSmall() throws ExecutionException, InterruptedException {

    // Construct Setup command
    Key&lt;Long&gt; sleepTimeKey = JKeyType.LongKey().make(&quot;SleepTime&quot;, JUnits.millisecond);
    Parameter&lt;Long&gt; sleepTimeParam = sleepTimeKey.set(5000L);

    Setup setupCommand = new Setup(Prefix.apply(JSubsystem.CSW, &quot;move&quot;), new CommandName(&quot;sleep&quot;), Optional.of(ObsId.apply(&quot;2020A-001-123&quot;))).add(sleepTimeParam);

    Timeout commandResponseTimeout = new Timeout(1, TimeUnit.SECONDS);

    AkkaConnection connection = new AkkaConnection(new ComponentId(Prefix.apply(JSubsystem.CSW, &quot;samplehcd&quot;), JComponentType.HCD));
    ILocationService locationService = testKit.jLocationService();
    AkkaLocation location = locationService.resolve(connection, Duration.ofSeconds(10)).get().orElseThrow();

    ICommandService hcd = CommandServiceFactory.jMake(location, typedActorSystem);

    Assert.assertThrows(ExecutionException.class, () -&gt; hcd.submitAndWait(setupCommand, commandResponseTimeout).get());
}</code></pre></dd>
</dl>
<h3><a href="#other-ways-to-spawn-assembly-and-hcd-in-the-standalone-mode-using-csw-test-kit" name="other-ways-to-spawn-assembly-and-hcd-in-the-standalone-mode-using-csw-test-kit" class="anchor"><span class="anchor-link"></span></a>Other ways to spawn Assembly and HCD in the standalone mode using CSW Test Kit</h3>
<p>Spawning a HCD</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/samplehcd/SampleHcdTest.scala#L131" target="_blank" title="Go to snippet source">source</a><code class="language-scala">spawnHCD(Prefix(&quot;TCS.sampleHcd&quot;), (ctx, cswCtx) =&gt; new SampleHcdHandlers(ctx, cswCtx))</code></pre></dd>
</dl>
<p>Spawning an Assembly</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/sample/SampleTest.scala#L44" target="_blank" title="Go to snippet source">source</a><code class="language-scala">spawnAssembly(Prefix(&quot;TCS.sampleAssembly&quot;), (ctx, cswCtx) =&gt; new SampleHandlers(ctx, cswCtx))</code></pre></dd>
</dl>
<h3><a href="#spawning-a-component-using-defaultcomponenthandlers" name="spawning-a-component-using-defaultcomponenthandlers" class="anchor"><span class="anchor-link"></span></a>Spawning a Component using DefaultComponentHandlers</h3>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/test/scala/org/tmt/csw/sample/SampleTest.scala#L55-L70" target="_blank" title="Go to snippet source">source</a><code class="language-scala">spawnAssembly(
  Prefix(&quot;TCS.defaultAssembly&quot;),
  (ctx, cswCtx) =&gt;
    new DefaultComponentHandlers(ctx, cswCtx) {
      override def onSubmit(runId: Id, controlCommand: ControlCommand): CommandResponse.SubmitResponse = {
        controlCommand.commandName.name match {
          case &quot;move&quot; =&gt;
            cswCtx.timeServiceScheduler.scheduleOnce(UTCTime(UTCTime.now().value.plusSeconds(5))) {
              cswCtx.commandResponseManager.updateCommand(Completed(runId))
            }
            Started(runId)
          case _ =&gt; Completed(runId)
        }
      }
    }
)</code></pre></dd>
</dl>
<p>Full source at GitHub</p>
<ul>
  <li><a href="https://github.com/tmtsoftware/csw/blob/v4.0.1-RC1/examples/src/test/scala/org/tmt/csw/sample/SampleTest.scala">For Assembly Scala</a></li>
  <li><a href="https://github.com/tmtsoftware/csw/blob/v4.0.1-RC1/examples/src/test/scala/org/tmt/csw/samplehcd/SampleHcdTest.scala">For HCD Scala</a></li>
  <li><a href="https://github.com/tmtsoftware/csw/blob/v4.0.1-RC1/examples/src/test/java/org/tmt/csw/sample/JSampleTest.java">Java</a></li>
</ul>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/commons/unit-tests.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
4.0.1-RC1
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../commons/using-alarms.html" title="Using Alarms" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Using Alarms
</span>
</div>
</a>
<a href="../commons/params.html" title="Params" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Params
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
