<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>Using Alarms Â· TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Using Alarms
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../commons/using-alarms.html" class="active page">Using Alarms</a></li>
  <li><a href="../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../messages/units.html" class="page">Units</a></li>
    <li><a href="../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../messages/events.html" class="page">Events</a></li>
    <li><a href="../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="page">Event Service</a></li>
    <li><a href="../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../services/time.html" class="page">Time Service</a></li>
    <li><a href="../services/database.html" class="page">Database Service</a></li>
    <li><a href="../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../apps/cswadminserver.html" class="page">csw-admin-server</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../commons/using-alarms.html#using-alarms" class="header">Using Alarms</a>
  <ul>
    <li><a href="../commons/using-alarms.html#" class="header"><em>Tutorial: Using alarms in a component</em></a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../commons/using-alarms.html#using-alarms" class="header">Using Alarms</a>
  <ul>
    <li><a href="../commons/using-alarms.html#" class="header"><em>Tutorial: Using alarms in a component</em></a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#using-alarms" name="using-alarms" class="anchor"><span class="anchor-link"></span></a>Using Alarms</h1>
<p>Alarms are used to indicate when some condition has arisen that warrants operator intervention. In order to ensure the integrity of alarms, components are required to broadcast the state of each alarm periodically. When situations occur in which a component is unable to determine and/or broadcast the alarm state, the alarm severity is automatically set to <code>Disconnected</code> after some period of time. This is brought to the operator&rsquo;s attention and the operator can then take appropriate action. This means even when situations are normal, the component must continue to publish each alarm with an <code>Okay</code> severity; otherwise, the alarm severity is automatically marked as <code>Disconnected</code>, prompting the operator to investigate.</p>
<p>The CSW Alarm Service provides two APIs: a &ldquo;Client API&rdquo; used by a component, and an &ldquo;Admin API&rdquo; used to manage the Alarm Store and for operator use (typically via HCMS user interfaces). The Client API consists of a single method call, <code>setSeverity</code>. The Admin API includes methods to set up the Alarm Store, get alarm severities and health of components or subsystems, acknowledge alarms, reset latched alarms, and other operator tasks. </p>
<p>The Admin API can be exercised using the command line tool provided with CSW: <code>csw-alarm-cli</code>. See the <a href="../apps/cswalarmcli.html">reference manual</a> for more info.</p>
<p>More details about the Alarm Service are found in the <a href="../services/alarm.html">Alarm Service manual</a>.</p>
<h4><a href="#" name="" class="anchor"><span class="anchor-link"></span></a><em>Tutorial: Using alarms in a component</em></h4>
<p>We will use our sample Assembly to monitor the counter event it is subscribed to, published by our sample HCD. Our alarm is based on the value of the counter, with the normal (<code>Okay</code>) range of 0 to 10, <code>Warning</code> range of 11 to 15, <code>Major</code> range of 16 to 20, and any other value generating a <code>Critical</code> alarm severity.</p>
<p>First, the Alarm Store must be initialized with our alarm using the CLI tool <code>csw-alarm-cli</code>. A configuration file must be written that describes every alarm that will be used in the system. For TMT operations, this configuration will be generated from the ICD-DB models. For our tutorial, we will use a configuration with only the alarm we will be using. </p>
<dl>
  <dt>alarms.conf
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/resources/sample-alarms.conf" target="_blank" title="Go to snippet source"></a><code class="language-conf">alarms: [
  {
    subsystem = NFIRAOS
    component = sampleAssembly
    name = counterTooHighAlarm
    description = &quot;Warns when counter value is too high&quot;
    location = &quot;enclosure&quot;
    alarmType = Absolute
    supportedSeverities = [Warning, Major, Critical]
    probableCause = &quot;Sample HCD has run for too long&quot;
    operatorResponse = &quot;Restart HCD&quot;
    isAutoAcknowledgeable = false
    isLatchable = false
    activationStatus = Active
  }
]</code></pre></dd>
</dl>
<p>For our tutorial, let&rsquo;s save this file to disk in our resources folder in the <code>sample-deploy</code> module (<code>sample-deploy/src/main/resources/alarms.conf</code>).</p>
<p>Now, we will use the CLI tool. Find it in the <code>bin</code> directory of the CSW application package available with the <a href="https://github.com/tmtsoftware/csw/releases">release</a> as <code>csw-alarm-cli</code>.</p>
<p>Use the <code>init</code> command to initialize the Alarm Store (this assumes csw-services is running, which sets up the Redis store for alarms).</p>
<pre><code>csw-alarm-cli init $PROJECTDIR/sample-deploy/src/main/resources/alarms.conf --local
</code></pre>
<p>where <code>$PROJECTDIR</code> is the root directory of your sample project. The <code>--local</code> flag indicates the configuration file is obtains from disk; omitting it would attempt to find the file in the Configuration Service, as would be done during operations.</p>
<p>Now we will add code to our assembly to publish an alarm severity on every counter event. Let&rsquo;s create some logic to take the counter as an argument and generate an alarm:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlersAlarm.scala#L131-L149" target="_blank" title="Go to snippet source"></a><code class="language-scala">private val safeRange  = 0 to 10
private val warnRange  = 11 to 15
private val majorRange = 16 to 20
private def getCounterSeverity(counter: Int) = counter match {
  case x if safeRange contains x  =&gt; AlarmSeverity.Okay
  case x if warnRange contains x  =&gt; AlarmSeverity.Warning
  case x if majorRange contains x =&gt; AlarmSeverity.Major
  case _                          =&gt; AlarmSeverity.Critical
}

private val counterAlarmKey = AlarmKey(NFIRAOS, componentInfo.name, &quot;CounterTooHighAlarm&quot;)
private def setCounterAlarm(counter: Int) = {
  // fire alarm according to counter value
  val severity = getCounterSeverity(counter)
  alarmService.setSeverity(counterAlarmKey, severity).onComplete {
    case Success(value) =&gt; log.info(s&quot;Severity for alarm ${counterAlarmKey.name} set to &quot; + severity.toString)
    case Failure(ex)    =&gt; log.error(s&quot;Error setting severity for alarm ${counterAlarmKey.name}: ${ex.getMessage}&quot;)
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlersAlarm.java#L193-L215" target="_blank" title="Go to snippet source"></a><code class="language-java">private AlarmSeverity getCounterSeverity(int counter) {
    if (counter &gt;= 0 &amp;&amp; counter &lt;= 10) {
        return JAlarmSeverity.Okay;
    } else if (counter &gt;= 11 &amp;&amp; counter &lt;= 15) {
        return JAlarmSeverity.Warning;
    } else if (counter &gt;= 16 &amp;&amp; counter &lt;= 20) {
        return JAlarmSeverity.Major;
    }
    return JAlarmSeverity.Critical;
}

private void setCounterAlarm(int counter) {
    AlarmKey counterAlarmKey = new AlarmKey(NFIRAOS, cswCtx.componentInfo().name(), &quot;CounterTooHighAlarm&quot;);
    AlarmSeverity severity = getCounterSeverity(counter);
    cswCtx.alarmService().setSeverity(counterAlarmKey, severity)
            .whenComplete((d, ex) -&gt; {
                if (ex != null) {
                    log.error(&quot;Error setting severity for alarm &quot;+ counterAlarmKey.name() + &quot;: &quot; + ex.getMessage());
                } else {
                    log.info(&quot;Severity for alarm &quot; + counterAlarmKey.name() + &quot; set to &quot; + severity.toString());
                }
            });
}</code></pre></dd>
</dl>
<p>This code determines the severity of the alarm based on the rules we established above:</p>
<ul>
  <li><code>Okay</code>: 0-10</li>
  <li><code>Warning</code>: 11-15</li>
  <li><code>Major</code>: 16-20</li>
  <li><code>Critical</code>: any other value</li>
</ul>
<p>Now, all we have to do is call this whenever we receive a counter event. We add a call to the <code>setCounterAlarm</code> method in the <code>processEvent</code> method:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlersAlarm.scala#L114-L127" target="_blank" title="Go to snippet source"></a><code class="language-scala">private def processEvent(event: Event): Unit = {
  log.info(s&quot;Event received: ${event.eventKey}&quot;)
  event match {
    case e: SystemEvent =&gt;
      e.eventKey match {
        case `counterEventKey` =&gt;
          val counter = e(hcdCounterKey).head
          log.info(s&quot;Counter = $counter&quot;)
          setCounterAlarm(counter)
        case _ =&gt; log.warn(&quot;Unexpected event received.&quot;)
      }
    case e: ObserveEvent =&gt; log.warn(&quot;Unexpected ObserveEvent received.&quot;) // not expected
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlersAlarm.java#L164-L179" target="_blank" title="Go to snippet source"></a><code class="language-java">private void processEvent(Event event) {
    log.info(&quot;Event received: &quot;+ event.eventKey());
    if (event instanceof SystemEvent) {
        SystemEvent sysEvent = (SystemEvent)event;
        if (event.eventKey().equals(counterEventKey)) {
            int counter = sysEvent.parameter(hcdCounterKey).head();
            log.info(&quot;Counter = &quot; + counter);
            setCounterAlarm(counter);
        } else {
            log.warn(&quot;Unexpected event received.&quot;);
        }
    } else {
        // ObserveEvent, not expected
        log.warn(&quot;Unexpected ObserveEvent received.&quot;);
    }
}</code></pre></dd>
</dl>
<p>To see the effect, let&rsquo;s use the CLI to set up a subscription to the alarm. Note the alarm key is composed of the subsystem (<code>nfiraos</code>), component name (<code>SampleAssembly</code> for Scala, <code>JSampleAssembly</code> for Java), and the alarm name (<code>counterTooHighAlarm</code>).</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre><code>csw-alarm-cli severity subscribe --subsystem NFIRAOS --component SampleAssembly --name counterTooHighAlarm
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre><code>csw-alarm-cli severity subscribe --subsystem NFIRAOS --component JSampleAssembly --name counterTooHighAlarm
</code></pre></dd>
</dl>
<p>Note that the alarm severity is currently <code>Disconnected</code>. This is the appropriate state, since we are not running the components. Now, run the Assembly and HCD, and you will see the severity of our alarm updated in the CLI as the severity changes.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/commons/using-alarms.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../commons/multiple-components.html" title="Multiple Components" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Multiple Components
</span>
</div>
</a>
<a href="../commons/unit-tests.html" title="Adding Unit Tests" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Adding Unit Tests
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
