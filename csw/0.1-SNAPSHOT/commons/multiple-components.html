<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>Multiple Components Â· TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Multiple Components
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="active page">Multiple Components</a></li>
  <li><a href="../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../messages/units.html" class="page">Units</a></li>
    <li><a href="../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../messages/events.html" class="page">Events</a></li>
    <li><a href="../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="page">Event Service</a></li>
    <li><a href="../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../services/time.html" class="page">Time Service</a></li>
    <li><a href="../services/database.html" class="page">Database Service</a></li>
    <li><a href="../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../apps/cswadminserver.html" class="page">csw-admin-server</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../commons/multiple-components.html#multiple-components" class="header">Multiple Components</a>
  <ul>
    <li><a href="../commons/multiple-components.html#creating-an-assembly" class="header">Creating an Assembly</a></li>
    <li><a href="../commons/multiple-components.html#component-configuration-componentinfo-" class="header">Component Configuration (ComponentInfo)</a></li>
    <li><a href="../commons/multiple-components.html#tracking-dependencies" class="header">Tracking Dependencies</a></li>
    <li><a href="../commons/multiple-components.html#onlocationtrackingevent-handler" class="header">onLocationTrackingEvent Handler</a></li>
    <li><a href="../commons/multiple-components.html#trackconnection" class="header">trackConnection</a></li>
    <li><a href="../commons/multiple-components.html#sending-commands" class="header">Sending Commands</a></li>
    <li><a href="../commons/multiple-components.html#tracking-long-running-commands" class="header">Tracking Long Running Commands</a></li>
    <li><a href="../commons/multiple-components.html#matchers" class="header">Matchers</a></li>
    <li><a href="../commons/multiple-components.html#pubsub-connection" class="header">PubSub Connection</a></li>
    <li><a href="../commons/multiple-components.html#subscribing-to-events" class="header">Subscribing to Events</a></li>
    <li><a href="../commons/multiple-components.html#deploying-and-running-components" class="header">Deploying and Running Components</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../commons/multiple-components.html#multiple-components" class="header">Multiple Components</a>
  <ul>
    <li><a href="../commons/multiple-components.html#creating-an-assembly" class="header">Creating an Assembly</a></li>
    <li><a href="../commons/multiple-components.html#component-configuration-componentinfo-" class="header">Component Configuration (ComponentInfo)</a></li>
    <li><a href="../commons/multiple-components.html#tracking-dependencies" class="header">Tracking Dependencies</a></li>
    <li><a href="../commons/multiple-components.html#onlocationtrackingevent-handler" class="header">onLocationTrackingEvent Handler</a></li>
    <li><a href="../commons/multiple-components.html#trackconnection" class="header">trackConnection</a></li>
    <li><a href="../commons/multiple-components.html#sending-commands" class="header">Sending Commands</a></li>
    <li><a href="../commons/multiple-components.html#tracking-long-running-commands" class="header">Tracking Long Running Commands</a></li>
    <li><a href="../commons/multiple-components.html#matchers" class="header">Matchers</a></li>
    <li><a href="../commons/multiple-components.html#pubsub-connection" class="header">PubSub Connection</a></li>
    <li><a href="../commons/multiple-components.html#subscribing-to-events" class="header">Subscribing to Events</a></li>
    <li><a href="../commons/multiple-components.html#deploying-and-running-components" class="header">Deploying and Running Components</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#multiple-components" name="multiple-components" class="anchor"><span class="anchor-link"></span></a>Multiple Components</h1>
<p>In this part of the tutorial, we will demonstrate functionality involving multiple components.<br/>We will do this by creating an Assembly, demonstrating how to deploy start the Assembly and an HCD in a container, and having them communicate with each other.</p>
<h2><a href="#creating-an-assembly" name="creating-an-assembly" class="anchor"><span class="anchor-link"></span></a>Creating an Assembly</h2>
<p>Similar to the HCD in the previous page, to create an assembly, the component developer needs to implement the <code>ComponentHandlers</code>. More details about implementing ComponentHandlers can be found <a href="create-component.html#handlers">here</a>. </p>
<h4><a href="#" name="" class="anchor"><span class="anchor-link"></span></a><em>Tutorial: Developing an Assembly</em></h4>
<p>If using the giter8 template with the default parameters, our <code>ComponentHandlers</code> class will be the <code>SampleAssemblyHandlers</code> class (<code>JSampleAssemblyHandlers</code> in Java), and the factory will be <code>SampleAssemblyBehaviorFactory</code> (<code>JSampleAssemblyBehaviorFactory</code> in Java).</p>
<p>Like we did for the HCD, let&rsquo;s add some log messages for the <code>initialize</code> and <code>onShutdown</code> hooks, but not the <code>onTrackingLocationEvent</code> hook. We&rsquo;ll cover that in more detail later.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlers.scala#L127-L137" target="_blank" title="Go to snippet source"></a><code class="language-scala">private var maybeEventSubscription: Option[EventSubscription] = None
override def initialize(): Future[Unit] = {
  log.info(&quot;In Assembly initialize&quot;)
  maybeEventSubscription = Some(subscribeToHcd())
  Future.unit
}

override def onShutdown(): Future[Unit] = {
  log.info(&quot;Assembly is shutting down.&quot;)
  Future.unit
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlers.java#L156-L168" target="_blank" title="Go to snippet source"></a><code class="language-java">private Optional&lt;IEventSubscription&gt; maybeEventSubscription = Optional.empty();
@Override
public CompletableFuture&lt;Void&gt; jInitialize() {
    return CompletableFuture.runAsync(() -&gt; {
        log.info(&quot;In Assembly initialize&quot;);
        maybeEventSubscription = Optional.of(subscribeToHcd());
    });
}

@Override
public CompletableFuture&lt;Void&gt; jOnShutdown() {
    return CompletableFuture.runAsync(() -&gt; log.info(&quot;Assembly is shutting down.&quot;));
}</code></pre></dd>
</dl>
<p>Once again, ignore the code about setting up the subscription. This will be covered later when we discuss subscribing to events.</p>
<h2><a href="#component-configuration-componentinfo-" name="component-configuration-componentinfo-" class="anchor"><span class="anchor-link"></span></a>Component Configuration (ComponentInfo)</h2>
<p>Also similar to the HCD, we will need to create a ComponentInfo file for the Assembly. The following shows an example of ComponentInfo file for an Assembly:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre><code>name = &quot;SampleAssembly&quot;
componentType = assembly
behaviorFactoryClassName = &quot;org.tmt.nfiraos.sampleassembly.SampleAssemblyBehaviorFactory&quot;
prefix = &quot;nfiraos.sample&quot;
locationServiceUsage = RegisterAndTrackServices
connections = [
  {
    name: &quot;SampleHcd&quot;
    componentType: hcd
    connectionType: akka
  }
]
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre><code>name = &quot;JSampleAssembly&quot;
componentType = assembly
behaviorFactoryClassName = &quot;org.tmt.nfiraos.sampleassembly.JSampleAssemblyBehaviorFactory&quot;
prefix = &quot;nfiraos.sample&quot;
locationServiceUsage = RegisterAndTrackServices
connections = [
  {
    name: &quot;JSampleHcd&quot;
    componentType: hcd
    connectionType: akka
  }
]
</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>There is a section for listing connections. These are the connections that the component will automatically track, and can be other components or services. When available, it may make sense to track things like the Event Service. These connections can also be specified for HCDs, but of course, they should not have any component dependencies.</p></div>
<p>The above shows a configuration file for running in standalone mode. If we want to run both the assembly and HCD in a container, the file would look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/resources/SampleContainer.conf" target="_blank" title="Go to snippet source"></a><code class="language-conf">name = &quot;SampleContainer&quot;
components: [
  {
    name = &quot;SampleAssembly&quot;
    componentType = assembly
    behaviorFactoryClassName = &quot;org.tmt.nfiraos.sampleassembly.SampleAssemblyBehaviorFactory&quot;
    prefix = &quot;nfiraos.sample&quot;
    locationServiceUsage = RegisterAndTrackServices
    connections = [
      {
        name: &quot;SampleHcd&quot;
        componentType: hcd
        connectionType: akka
      }
    ]
  },
  {
    name = &quot;SampleHcd&quot;
    componentType = hcd
    behaviorFactoryClassName = &quot;org.tmt.nfiraos.samplehcd.SampleHcdBehaviorFactory&quot;
    prefix = &quot;nfiraos.samplehcd&quot;
    locationServiceUsage = RegisterOnly
  }
]</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/resources/JSampleContainer.conf" target="_blank" title="Go to snippet source"></a><code class="language-conf">name = &quot;JSampleContainer&quot;
components: [
  {
    name = &quot;JSampleAssembly&quot;
    componentType = assembly
    behaviorFactoryClassName = &quot;org.tmt.nfiraos.sampleassembly.JSampleAssemblyBehaviorFactory&quot;
    prefix = &quot;nfiraos.sample&quot;
    locationServiceUsage = RegisterAndTrackServices
    connections = [
      {
        name: &quot;JSampleHcd&quot;
        componentType: hcd
        connectionType: akka
      }
    ]
  },
  {
    name = &quot;JSampleHcd&quot;
    componentType = hcd
    behaviorFactoryClassName = &quot;org.tmt.nfiraos.samplehcd.JSampleHcdBehaviorFactory&quot;
    prefix = &quot;nfiraos.samplehcd&quot;
    locationServiceUsage = RegisterOnly
  }
]</code></pre></dd>
</dl>
<p>More details about each configuration and its significance can be found <a href="create-component.html#component-configuration-componentinfo-">here</a>.</p>
<p>Another sample container configuration file can be found <a href="https://github.com/tmtsoftware/csw/tree/master/csw-benchmark/src/main/resources/container.conf">here</a>. </p>
<h2><a href="#tracking-dependencies" name="tracking-dependencies" class="anchor"><span class="anchor-link"></span></a>Tracking Dependencies</h2>
<p>The connections that are defined in the configuration file for an assembly will be tracked by the <code>csw-framework</code>. For each connection the following details are configured:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre><code>{
name: &quot;SampleHcd&quot;
componentType: hcd
connectionType: akka
}
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre><code>{
name: &quot;JSampleHcd&quot;
componentType: hcd
connectionType: akka
}
</code></pre></dd>
</dl>
<p>The name of the component, the type(hcd, service, etc) and the connection(akka, http, tcp) will be used to create a <code>Connection</code> object. The Connection object will be then used to track the location of a component using location service.</p>
<p>The <code>Location</code> object has one of the following types:</p>
<ul>
  <li>AkkaLocation: Contains the remote address of the actorRef. The actorRef will be the Supervisor actor of a component.</li>
  <li>HttpLocation: Holds the HTTP URI of the web server, e.g. Configuration Service</li>
  <li>TcpLocation: Represents a TCP URI of the server, e.g. Event Service</li>
</ul>
<p>More details about tracking a component using the location service can be found <a href="../services/location.html#tracking-and-subscribing">here</a>.</p>
<h2><a href="#onlocationtrackingevent-handler" name="onlocationtrackingevent-handler" class="anchor"><span class="anchor-link"></span></a>onLocationTrackingEvent Handler</h2>
<p>For all the tracked connections, whenever a location is changed, added, or removed, one of the following events is generated:</p>
<ul>
  <li>LocationUpdated: a location was added or changed</li>
  <li>LocationRemoved: a location is no longer available on the network</li>
</ul>
<p>Whenever such an event is generated, the Top level actor will call the <code>onLocationTrackingEvent</code> hook of <code>ComponentHandlers</code> with the event(LocationUpdated or LocationRemoved) as parameter of the hook.</p>
<p>More details about tracking connections can be found <a href="../framework/tracking-connections.html">here</a>.</p>
<h4><a href="#" name="" class="anchor"><span class="anchor-link"></span></a><em>Tutorial: Developing an Assembly</em></h4>
<p>For our sample component, we will set it up so that when the HCD is found by the location service, we will immediately send a command to it. We will do this by using the location to obtain a <code>CommandService</code> reference (see <a href="multiple-components.html#sending-commands">below</a>) to the HCD, and then pass this reference to a worker actor to send and monitor the command (we will get more into this command actor later), so that we don&rsquo;t block our Assembly from receiving messages. If we are notified that the HCD is removed, log a message. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlers.scala#L141-L149" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def onLocationTrackingEvent(trackingEvent: TrackingEvent): Unit = {
  log.debug(s&quot;onLocationTrackingEvent called: $trackingEvent&quot;)
  trackingEvent match {
    case LocationUpdated(location) =&gt;
      val hcd = CommandServiceFactory.make(location.asInstanceOf[AkkaLocation])(ctx.system)
      commandSender ! SendCommand(hcd)
    case LocationRemoved(_) =&gt; log.info(&quot;HCD no longer available&quot;)
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlers.java#L172-L183" target="_blank" title="Go to snippet source"></a><code class="language-java">@Override
public void onLocationTrackingEvent(TrackingEvent trackingEvent) {
    log.debug(() -&gt; &quot;onLocationTrackingEvent called: &quot; + trackingEvent.toString());
    if (trackingEvent instanceof LocationUpdated) {
        LocationUpdated updated = (LocationUpdated) trackingEvent;
        Location location = updated.location();
        ICommandService hcd = CommandServiceFactory.jMake((AkkaLocation) (location), actorContext.getSystem());
        commandSender.tell(new SendCommand(hcd));
    } else if (trackingEvent instanceof LocationRemoved) {
        log.info(&quot;HCD no longer available&quot;);
    }
}</code></pre></dd>
</dl>
<h2><a href="#trackconnection" name="trackconnection" class="anchor"><span class="anchor-link"></span></a>trackConnection</h2>
<p>If the component developer wants to track a connection that is not configured in its configuration file then it can use the <code>trackConnection</code> method provided by <code>csw-framework</code> in <code>ComponentHandlers</code>. The <code>trackConnection</code> method will take the <code>Connection</code> instance. Information on how to create a connection instance can be found <a href="../services/location.html#creating-components-connections-and-registrations">here</a>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Connections tracked by <code>csw-framework</code> (from a configuration file) or by a component developer using the <code>trackConnection</code> method both will be received in the <code>onLocationTrackingEvent</code> hook of <code>ComponentHandlers</code>. </p></div>
<h2><a href="#sending-commands" name="sending-commands" class="anchor"><span class="anchor-link"></span></a>Sending Commands</h2>
<p>From the location information obtained either by tracking dependencies or manually resolving a location, a <code>CommandService</code> instance can be created to provide a command interface to the component. The following snippet, not from our tutorial, shows how  to obtain a <code>CommandService</code> reference using by resolving a location using the Location Service.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/framework/components/assembly/AssemblyComponentHandlers.scala#L191-L201" target="_blank" title="Go to snippet source"></a><code class="language-scala">implicit val system: ActorSystem[Nothing] = ctx.system

val eventualCommandService: Future[CommandService] =
  cswCtx.locationService.resolve(hcdConnection.of[AkkaLocation], 5.seconds).map {
    case Some(hcdLocation: AkkaLocation) =&gt; CommandServiceFactory.make(hcdLocation)
    case _                               =&gt; throw HcdNotFoundException()
  }

eventualCommandService.foreach { commandService â
  hcd = commandService
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/framework/components/assembly/JAssemblyComponentHandlers.java#L329-L338" target="_blank" title="Go to snippet source"></a><code class="language-java">CompletableFuture&lt;Optional&lt;AkkaLocation&gt;&gt; resolvedHcdLocation = locationService.resolve(hcdConnection, Duration.ofSeconds(5));

CompletableFuture&lt;ICommandService&gt; eventualCommandService = resolvedHcdLocation.thenApply((Optional&lt;AkkaLocation&gt; hcdLocation) -&gt; {
    if (hcdLocation.isPresent())
        return CommandServiceFactory.jMake(hcdLocation.get(), ctx.getSystem());
    else
        throw new HcdNotFoundException();
});

eventualCommandService.thenAccept((jcommandService) -&gt; hcd = jcommandService);</code></pre></dd>
</dl>
<p>If a component wants to send a command to another component, it uses a <code>CommandService</code> instance. The creation of a<code>CommandService</code> instance and its usage can be found <a href="command.html#commandservice">here</a>.</p>
<h2><a href="#tracking-long-running-commands" name="tracking-long-running-commands" class="anchor"><span class="anchor-link"></span></a>Tracking Long Running Commands</h2>
<p>The <code>submit</code> method has been written so that it will return a Future response encapsulating a <code>SubmitResponse</code> type. If the Future completes, no matter whether the command has an immediate response or is long-running, is invalid, or encounters an error at any point, the Future completes with the final response. If there is an exception, which may occur if the <code>submit</code> times out, that must be handled explicity using Future exception handling (this can be done many ways; an example is given below).</p>
<h4><a href="#" name="" class="anchor"><span class="anchor-link"></span></a><em>Tutorial: Developing an Assembly</em></h4>
<p>We use our worker actor to submit the command to the HCD, and then subscribe to the HCD&rsquo;s <code>CommandResponseManager</code> for command completion.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlers.scala#L37-L76" target="_blank" title="Go to snippet source"></a><code class="language-scala">sealed trait WorkerCommand                  extends TMTSerializable
case class SendCommand(hcd: CommandService) extends WorkerCommand

private val commandSender =
  ctx.spawn(
    Behaviors.receiveMessage[WorkerCommand](msg =&gt; {
      msg match {
        case command: SendCommand =&gt;
          log.trace(s&quot;WorkerActor received SendCommand message.&quot;)
          handle(command.hcd)
        case _ =&gt; log.error(&quot;Unsupported message type&quot;)
      }
      Behaviors.same
    }),
    &quot;CommandSender&quot;
  )

import scala.concurrent.duration._
private implicit val sleepCommandTimeout: Timeout = Timeout(10000.millis)
def handle(hcd: CommandService): Unit = {

  // Construct Setup command
  val sleepTimeKey: Key[Long]         = KeyType.LongKey.make(&quot;SleepTime&quot;)
  val sleepTimeParam: Parameter[Long] = sleepTimeKey.set(5000).withUnits(Units.millisecond)
  val setupCommand                    = Setup(componentInfo.prefix, CommandName(&quot;sleep&quot;), Some(ObsId(&quot;2018A-001&quot;))).add(sleepTimeParam)

  // submit command and handle response
  hcd.submit(setupCommand).onComplete {
    case scala.util.Success(value) =&gt;
      value match {
        case _: CommandResponse.Locked =&gt; log.error(&quot;Sleep command failed: HCD is locked.&quot;)
        case inv: CommandResponse.Invalid =&gt;
          log.error(s&quot;Command is invalid: (${inv.issue.getClass.getSimpleName}): ${inv.issue.reason}&quot;)
        case x: CommandResponse.Error     =&gt; log.error(s&quot;Command Completed with error: ${x.message}&quot;)
        case _: CommandResponse.Completed =&gt; log.info(&quot;Command completed successfully&quot;)
        case _                            =&gt; log.error(&quot;Command failed&quot;)
      }
    case scala.util.Failure(ex) =&gt; log.error(s&quot;Exception occured when sending command: ${ex.getMessage}&quot;)
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlers.java#L60-L115" target="_blank" title="Go to snippet source"></a><code class="language-java">private interface WorkerCommand extends TMTSerializable {
}

private static final class SendCommand implements WorkerCommand {
    private final ICommandService hcd;

    private SendCommand(ICommandService hcd) {
        this.hcd = hcd;
    }
}

private ActorRef&lt;WorkerCommand&gt; createWorkerActor() {
    return actorContext.spawn(
            Behaviors.receiveMessage(msg -&gt; {
                if (msg instanceof SendCommand) {
                    SendCommand command = (SendCommand) msg;
                    log.trace(&quot;WorkerActor received SendCommand message.&quot;);
                    handle(command.hcd);
                } else {
                    log.error(&quot;Unsupported messsage type&quot;);
                }
                return Behaviors.same();
            }),
            &quot;CommandSender&quot;
    );
}

private void handle(ICommandService hcd) {

    // Construct Setup command
    Key&lt;Long&gt; sleepTimeKey = JKeyType.LongKey().make(&quot;SleepTime&quot;);
    Parameter&lt;Long&gt; sleepTimeParam = sleepTimeKey.set(5000L).withUnits(JUnits.millisecond);

    Setup setupCommand = new Setup(cswCtx.componentInfo().prefix(), new CommandName(&quot;sleep&quot;), Optional.of(new ObsId(&quot;2018A-001&quot;))).add(sleepTimeParam);

    Timeout commandResponseTimeout = new Timeout(10, TimeUnit.SECONDS);

    // Submit command and handle response
    hcd.submit(setupCommand, commandResponseTimeout)
            .exceptionally(ex -&gt; new CommandResponse.Error(setupCommand.runId(), &quot;Exception occurred when sending command: &quot; + ex.getMessage()))
            .thenAccept(commandResponse -&gt; {
                if (commandResponse instanceof CommandResponse.Locked) {
                    log.error(&quot;Sleed command failed: HCD is locked&quot;);
                } else if (commandResponse instanceof CommandResponse.Invalid) {
                    CommandResponse.Invalid inv = (CommandResponse.Invalid) commandResponse;
                    log.error(&quot;Sleep command invalid (&quot; + inv.issue().getClass().getSimpleName() + &quot;): &quot; + inv.issue().reason());
                } else if (commandResponse instanceof CommandResponse.Error) {
                    CommandResponse.Error x = (CommandResponse.Error) commandResponse;
                    log.error(() -&gt; &quot;Command Completed with error: &quot; + x.message());
                } else if (commandResponse instanceof CommandResponse.Completed) {
                    log.info(&quot;Command completed successfully&quot;);
                } else {
                    log.error(&quot;Command failed: &quot;);
                }
            });
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>If the component developer creates new set of messages for worker actor then it is mandatory that those messages extend <code>TMTSerializable</code> which will enable messages to serialize on wire.</p></div>
<h2><a href="#matchers" name="matchers" class="anchor"><span class="anchor-link"></span></a>Matchers</h2>
<p>When a component sends a command as <code>Oneway</code> to another component, it may be interested in knowing the receiver component&rsquo;s <code>CurrentState</code> and match it against a desired state. In order to do that, the component developer can use the <code>onewayAndMatch</code> method of <code>CommandService</code> or use <code>oneway</code> and then use a <code>Matcher</code> explicitly to match a desired state with current state.</p>
<p>More details on how to use <code>Matcher</code> can be found <a href="command.html#matching-state-for-command-completion">here</a>. </p>
<h2><a href="#pubsub-connection" name="pubsub-connection" class="anchor"><span class="anchor-link"></span></a>PubSub Connection</h2>
<p>A component might need to subscribe to the current state of any other component provided it knows the location of that component. In order to subscribe to current state, it may use the <code>subscribeCurrentState</code> method of the <code>CommandService</code>. More details about the usage of <code>subscribeCurrentState</code> can ber found <a href="command.html#subscribecurrentstate">here</a>.</p>
<p>If a component wants to publish its current state then it can use the <code>currentStatePublisher</code> provided by <code>csw-framework</code> in the <code>CswContext</code> object passed into <code>ComponentHandlers</code>. More details about the usage of <code>currentStatePublisher</code> can be found <a href="../framework/publishing-state.html">here</a>.</p>
<h2><a href="#subscribing-to-events" name="subscribing-to-events" class="anchor"><span class="anchor-link"></span></a>Subscribing to Events</h2>
<p>To subscribe to events, a subscriber is accessed done in a similar way to publishing. Typically a <code>defaultSubscriber</code> is obtained, but additional subscribers with their own connection can be created.</p>
<p>The subscribe API specifies a set of <code>Events</code> to subscribe to and then specifies how the events should be handled. This can be a callback, an Actor reference to receive the <code>Event</code> as a message, or as a stream to allow flow operations to be applied. </p>
<h4><a href="#" name="" class="anchor"><span class="anchor-link"></span></a><em>Tutorial: Developing an Assembly</em></h4>
<p>We will setup our subscription to the counter events generated by our HCD in the <code>subscribeToHCD</code> method. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlers.scala#L153-L178" target="_blank" title="Go to snippet source"></a><code class="language-scala">private val counterEventKey = EventKey(Prefix(&quot;nfiraos.samplehcd&quot;), EventName(&quot;HcdCounter&quot;))
private val hcdCounterKey   = KeyType.IntKey.make(&quot;counter&quot;)

private def processEvent(event: Event): Unit = {
  log.info(s&quot;Event received: ${event.eventKey}&quot;)
  event match {
    case e: SystemEvent =&gt;
      e.eventKey match {
        case `counterEventKey` =&gt;
          val counter = e(hcdCounterKey).head
          log.info(s&quot;Counter = $counter&quot;)
        case _ =&gt; log.warn(&quot;Unexpected event received.&quot;)
      }
    case e: ObserveEvent =&gt; log.warn(&quot;Unexpected ObserveEvent received.&quot;) // not expected
  }
}

private def subscribeToHcd(): EventSubscription = {
  log.info(&quot;Starting subscription.&quot;)
  eventService.defaultSubscriber.subscribeCallback(Set(counterEventKey), processEvent)
}

private def unsubscribeHcd(): Unit = {
  log.info(&quot;Stopping subscription.&quot;)
  maybeEventSubscription.foreach(_.unsubscribe())
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlers.java#L187-L214" target="_blank" title="Go to snippet source"></a><code class="language-java">private EventKey counterEventKey = new EventKey(new Prefix(&quot;nfiraos.samplehcd&quot;), new EventName(&quot;HcdCounter&quot;));
private Key&lt;Integer&gt; hcdCounterKey = JKeyType.IntKey().make(&quot;counter&quot;);

private void processEvent(Event event) {
    log.info(&quot;Event received: &quot;+ event.eventKey());
    if (event instanceof SystemEvent) {
        SystemEvent sysEvent = (SystemEvent)event;
        if (event.eventKey().equals(counterEventKey)) {
            int counter = sysEvent.parameter(hcdCounterKey).head();
            log.info(&quot;Counter = &quot; + counter);
        } else {
            log.warn(&quot;Unexpected event received.&quot;);
        }
    } else {
        // ObserveEvent, not expected
        log.warn(&quot;Unexpected ObserveEvent received.&quot;);
    }
}

private IEventSubscription subscribeToHcd() {
    log.info(&quot;Starting subscription.&quot;);
    return cswCtx.eventService().defaultSubscriber().subscribeCallback(Collections.singleton(counterEventKey), this::processEvent);
}

private void unsubscribeHcd() {
    log.info(&quot;Stopping subscription.&quot;);
    maybeEventSubscription.ifPresent(IEventSubscription::unsubscribe);
}</code></pre></dd>
</dl>
<p>We use the <code>subscribeCallback</code> method from the API and specify the method <code>processEvent</code> as our callback, in which we unpack the event and log the counter value. The subscribe methods in the API return a <code>EventSubscription</code> object, which can be used to stop the subscription, as demonstrated in the <code>unsubscribeHCD</code> method (which again, is not called in our tutorial).</p>
<p>Again, we return to our <code>initialize</code> method to show how subscription is started, and the reference to the subscription is stored for later use.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/org/tmt/nfiraos/sampleassembly/SampleAssemblyHandlers.scala#L127-L137" target="_blank" title="Go to snippet source"></a><code class="language-scala">private var maybeEventSubscription: Option[EventSubscription] = None
override def initialize(): Future[Unit] = {
  log.info(&quot;In Assembly initialize&quot;)
  maybeEventSubscription = Some(subscribeToHcd())
  Future.unit
}

override def onShutdown(): Future[Unit] = {
  log.info(&quot;Assembly is shutting down.&quot;)
  Future.unit
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/org/tmt/nfiraos/sampleassembly/JSampleAssemblyHandlers.java#L156-L168" target="_blank" title="Go to snippet source"></a><code class="language-java">private Optional&lt;IEventSubscription&gt; maybeEventSubscription = Optional.empty();
@Override
public CompletableFuture&lt;Void&gt; jInitialize() {
    return CompletableFuture.runAsync(() -&gt; {
        log.info(&quot;In Assembly initialize&quot;);
        maybeEventSubscription = Optional.of(subscribeToHcd());
    });
}

@Override
public CompletableFuture&lt;Void&gt; jOnShutdown() {
    return CompletableFuture.runAsync(() -&gt; log.info(&quot;Assembly is shutting down.&quot;));
}</code></pre></dd>
</dl>
<h2><a href="#deploying-and-running-components" name="deploying-and-running-components" class="anchor"><span class="anchor-link"></span></a>Deploying and Running Components</h2>
<h3><a href="#pre-requisite" name="pre-requisite" class="anchor"><span class="anchor-link"></span></a>Pre-requisite</h3>
<p>A project, for example with the name <code>sample-deploy</code>, contains applications (ContainerCmd and HostConfig coming from <code>csw-framework</code>) to run components. Make sure that the necessary dependencies are added in the <code>sample-deploy</code>.</p>
<h3><a href="#run" name="run" class="anchor"><span class="anchor-link"></span></a>Run</h3>
<p>To start the Assembly and HCD, <code>sbt runMain</code> can be used as with the HCD, but with slightly different options.<br/>Now, we do not want to run in standalone mode, and we need to make sure to pass the container configuration file.</p>
<p>Go to the project root directory and type <code>sbt &quot;&lt;deploy-module&gt;/runMain &lt;mainClass&gt; --local &lt;path-to-config-file&gt;&quot;</code>, where</p>
<ul>
  <li><code>&lt;deploy-module&gt;</code> is the name of the deployment module created by the template (<code>sample-deploy</code> if using defaults)</li>
  <li><code>&lt;mainClass&gt;</code> is the full class name of our ContainerCmd application, which the template names <code>&lt;package&gt;.&lt;name&gt;deploy.&lt;Name&gt;ContainerCmdApp</code>. If you accept the defaults for the template, it will be <code>org.tmt.nfiraos.sampledeploy.SampleContainerCmdApp</code>. If you are having problems determining the class name, use <code>sbt &lt;deploy-module&gt;/run</code> and it will prompt you the possibilities.</li>
  <li><code>&lt;path-to-config-file&gt;</code> is the filename, which can be an absolute path or relative to the directory of the deployment module. If using defaults, this would be <code>src/main/resources/SampleContainer.conf</code> for Scala, and <code>src/main/resources/JSampleContainer.conf</code> for Java.</li>
</ul>
<p>So if using the template defaults, the full command would be </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre><code>sbt &quot;sample-deploy/runMain org.tmt.nfiraos.sampledeploy.SampleContainerCmdApp --local src/main/resources/SampleContainer.conf&quot;
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre><code>sbt &quot;sample-deploy/runMain org.tmt.nfiraos.sampledeploy.SampleContainerCmdApp --local src/main/resources/JSampleContainer.conf&quot;
</code></pre></dd>
</dl>
<p>Like with the HCD, the <code>sbt stage</code> command can also be used to create binaries in the <code>target/universal/stage/bin</code> directories of the root project.</p>
<p>To run using the deployment packaging, follow the steps below:</p>
<ul>
  <li>Run <code>sbt sample-deploy/universal:packageBin</code>, this will create self contained zip in <code>sample-deploy/target/universal</code> directory.</li>
  <li>Unzip the generated zip file and enter into <code>bin</code> directory.</li>
  <li>You will see four scripts in the <code>bin</code> directory (two bash scripts and two windows scripts).</li>
  <li>If you want to start multiple containers on a host machine, follow this guide <a href="../apps/hostconfig.html#examples">here</a>.</li>
  <li>If you want to start multiple components in container mode or single component in standalone mode, follow this guide <a href="../framework/deploying-components.html">here</a>.</li>
  <li>Example to run container: <code>./sample-container-cmd-app --local ../../../../sample-deploy/src/main/resources/SampleContainer.conf</code></li>
  <li>Example to run host config: <code>./sample-host-config-app --local ../../../../sample-deploy/src/main/resources/SampleHostConfig.conf -s ./sample-container-cmd-app</code></li>
</ul><div class="callout note "><div class="callout-title">Note</div>
<p>This assumes you still have the CSW Services running using the <code>csw-services.sh</code> script as described in the <a href="create-component.html#starting-csw-services">Create a Component</a> tutorial page.</p></div>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/commons/multiple-components.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../commons/create-component.html" title="Creating a Component" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Creating a Component
</span>
</div>
</a>
<a href="../commons/using-alarms.html" title="Using Alarms" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Using Alarms
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
