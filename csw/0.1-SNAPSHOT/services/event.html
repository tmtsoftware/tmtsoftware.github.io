<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>Event Service Â· TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Event Service
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../messages/units.html" class="page">Units</a></li>
    <li><a href="../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../messages/events.html" class="page">Events</a></li>
    <li><a href="../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="active page">Event Service</a></li>
    <li><a href="../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../services/time.html" class="page">Time Service</a></li>
    <li><a href="../services/database.html" class="page">Database Service</a></li>
    <li><a href="../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../apps/cswadminserver.html" class="page">csw-admin-server</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../services/event.html#event-service" class="header">Event Service</a>
  <ul>
    <li><a href="../services/event.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../services/event.html#accessing-event-service" class="header">Accessing Event Service</a></li>
    <li><a href="../services/event.html#usage-of-eventpublisher" class="header">Usage of EventPublisher</a></li>
    <li><a href="../services/event.html#usage-of-eventsubscriber" class="header">Usage of EventSubscriber</a></li>
    <li><a href="../services/event.html#create-event-service" class="header">Create Event Service</a></li>
    <li><a href="../services/event.html#source-code-for-examples-of-creation" class="header">Source code for examples of creation</a></li>
    <li><a href="../services/event.html#source-code-for-examples-of-publishing" class="header">Source code for examples of publishing</a></li>
    <li><a href="../services/event.html#source-code-for-examples-of-subscribing" class="header">Source code for examples of subscribing</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../services/event.html#event-service" class="header">Event Service</a>
  <ul>
    <li><a href="../services/event.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../services/event.html#accessing-event-service" class="header">Accessing Event Service</a></li>
    <li><a href="../services/event.html#usage-of-eventpublisher" class="header">Usage of EventPublisher</a></li>
    <li><a href="../services/event.html#usage-of-eventsubscriber" class="header">Usage of EventSubscriber</a></li>
    <li><a href="../services/event.html#create-event-service" class="header">Create Event Service</a></li>
    <li><a href="../services/event.html#source-code-for-examples-of-creation" class="header">Source code for examples of creation</a></li>
    <li><a href="../services/event.html#source-code-for-examples-of-publishing" class="header">Source code for examples of publishing</a></li>
    <li><a href="../services/event.html#source-code-for-examples-of-subscribing" class="header">Source code for examples of subscribing</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#event-service" name="event-service" class="anchor"><span class="anchor-link"></span></a>Event Service</h1>
<p>The Event Service implements the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">publish/subscribe messaging paradigm</a> where one component publishes an event and all components that have subscribed receive the event. In CSW, the events published are described under the messages documentation <a href="../messages/events.html">here</a>. One advantage of this type of message system and Event Service also is that publishers and subscribers are decoupled. This decoupling of publishers and subscribers can allow for greater scalability and a more dynamic network topology. Publishers can publish regardless of whether there are subscribers, and subscribers can subscribe even if there are no publishers. The relationship between publishers and subscribers can be one-to-one, one-to-many, many to one, or even many-to-many. </p>
<p>Event Service is optimized for the high performance requirements of events as demands with varying rates, for ex. 100 Hz, 50 Hz etc., but can also be used with events that are published infrequently or when values change. In the TMT control system, events may be created as the output of a calculation by one component for the input to a calculation in one or more other components. Demand events often consist of events that are published at a specific rate.</p>
<p>The Event Service provides an API that allows events to be published and also allows clients to subscribe and unsubscribe to specific events and call developer code when events are received.</p>
<p>Event Service also stores the most recent published event for every unique event by prefix and name. This is useful for publishing components when an event contains state information that changes. Other components needing to check the state can do so without the overhead of subscribing. </p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>If you already have a dependency on <code>csw-framework</code> in your <code>build.sbt</code>, then you can skip this as <code>csw-framework</code> depends on <code>csw-event-client</code> Otherwise add below dependency in your <code>build.sbt</code></p>
<dl>
  <dt>sbt</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;com.github.tmtsoftware.csw&quot; %% &quot;csw-event-client&quot; % &quot;0.1-SNAPSHOT&quot;
</code></pre></dd>
</dl>
<h2><a href="#accessing-event-service" name="accessing-event-service" class="anchor"><span class="anchor-link"></span></a>Accessing Event Service</h2>
<p>When you create component handlers using <code>csw-framework</code> as explained <a href="../framework/creating-components.html">here</a>, you get a handle to <code>EventService</code> which is created by <code>csw-framework</code></p>
<p>Using <code>EventService</code> you can start publishing or subscribing to events. <code>EventService</code> is injected in component handlers via <code>csw-framwework</code> and provides the following features: </p>
<p><strong>Access to <code>defaultPublisher</code></strong>: Using <code>defaultPublisher</code> in <code>EventService</code>, you can publish a single event or a stream of demand events to Event Service. In most cases, you should use <code>defaultPublisher</code>, because you can then pass the instance of <code>EventService</code> in worker actors or different places in your code and call <code>eventService.defaultPublisher</code> to access publisher. Each <code>EventPublisher</code> has its own TCP connection to the Event Service. When you reuse the <code>defaultPublisher</code> instance of <code>EventPublisher</code>, all events published go through same TCP connection. </p>
<p><strong>Access to <code>defaultSubscriber</code></strong>: Using <code>defaultSubscriber</code>, you can subscribe to specific event keys. You can share <code>defaultSubscriber</code> in the same way as <code>defaultPublisher</code> by passing an instance of <code>EventService</code> to different parts of your code. Unlike <code>defaultPublisher</code>, each subscription with <code>defaultSubscriber.subscribe</code> creates a new TCP connection for just that subscription. This behavior is the same whether you use <code>defaultSubscriber</code> or <code>makeNewSubscriber</code> call on <code>EventService</code>.</p>
<p>Each <code>EventSubscriber</code> also has one TCP connection that is used to provide the latest event from the event server when subscribing and also for the explicit <code>get</code> calls. That means, with <code>defaultSubscriber</code>, you are sharing same connection for getting latest events and creating a new connection for each subscribe call. The underlying event server can handle many connections, but it is good to understand how connections are used and reused.</p>
<p><strong>Creating a new <code>Publisher</code> or <code>Subscriber</code></strong>: The <code>makeNewPublisher</code> API of Event Service can be used to create a new publisher which would internally create a new TCP connection to the Event Store. One of the use cases of this API could be to publish high frequency event streams in order to dedicate a separate connection to demanding streams without affecting the performance of all other low frequency (for ex. 1Hz, 20Hz etc.) event streams.</p>
<p>However, <code>makeNewSubscriber</code> API does not really have any specific use cases. Both <code>defaultSubscriber</code> and <code>makeNewSubscriber</code> APIs behave almost similar since the <code>subscribe</code> API of EventService itself creates a new connection for every subscription. Prefer using <code>defaultSubscriber</code> over <code>makeNewSubscriber</code>.</p>
<h2><a href="#usage-of-eventpublisher" name="usage-of-eventpublisher" class="anchor"><span class="anchor-link"></span></a>Usage of EventPublisher</h2>
<p>Below examples demonstrate the usage of multiple variations of publish API.</p>
<h3><a href="#for-single-event" name="for-single-event" class="anchor"><span class="anchor-link"></span></a>For Single Event</h3>
<p>This is the simplest API to publish a single event. It returns a Future which will complete successfully if the event is published or fail immediately with a <a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/api/exceptions/PublishFailure.html">PublishFailure</a> exception if the component cannot publish the event.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventPublishExamples.scala#L21-L25" target="_blank" title="Go to snippet source"></a><code class="language-scala">{
  val publisher = eventService.defaultPublisher
  val event     = SystemEvent(componentInfo.prefix, EventName(&quot;filter_wheel&quot;))
  publisher.publish(event)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventPublishExamples.java#L30-L31" target="_blank" title="Go to snippet source"></a><code class="language-java">Event event = new SystemEvent(componentInfo.prefix(), new EventName(&quot;filter_wheel&quot;));
eventService.defaultPublisher().publish(event);</code></pre></dd>
</dl>
<h3><a href="#with-generator" name="with-generator" class="anchor"><span class="anchor-link"></span></a>With Generator</h3>
<p>A generator is useful when component code needs to publish events with a specific frequency. The following example demonstrates the usage of publish API with event generator which will publish one event at each <code>interval</code>. <code>eventGenerator</code> is a function responsible for generating events. It can hold domain specific logic of generating new events based on certain conditions.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventPublishExamples.scala#L47-L59" target="_blank" title="Go to snippet source"></a><code class="language-scala">{
  val publisher        = eventService.defaultPublisher
  val baseEvent: Event = SystemEvent(componentInfo.prefix, EventName(&quot;filter_wheel&quot;))
  val interval         = 100.millis

  // this holds the logic for event generation, could be based on some computation or current state of HCD
  def eventGenerator(): Event = baseEvent match {
    case e: SystemEvent  â e.copy(eventId = Id(), eventTime = UTCTime.now())
    case e: ObserveEvent â e.copy(eventId = Id(), eventTime = UTCTime.now())
  }

  publisher.publish(eventGenerator(), interval)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventPublishExamples.java#L53-L62" target="_blank" title="Go to snippet source"></a><code class="language-java">private Cancellable startPublishingEvents(ComponentInfo componentInfo) {
    Event baseEvent = new SystemEvent(componentInfo.prefix(), new EventName(&quot;filter_wheel&quot;));
    return eventService.defaultPublisher().publish(() -&gt; eventGenerator(baseEvent), Duration.ofMillis(100));
}

// this holds the logic for event generation, could be based on some computation or current state of HCD
private Event eventGenerator(Event baseEvent) {
    // add logic here to create a new event and return the same
    return baseEvent;
}</code></pre></dd>
</dl>
<h3><a href="#with-event-stream" name="with-event-stream" class="anchor"><span class="anchor-link"></span></a>With Event Stream</h3>
<p>In order to publish a continuous stream of events, this stream-based API can also be used. If an infinite stream is provided, shutdown of the stream needs to be taken care by the users. (Note that streams discussed here are an Akka feature that is supported in event publisher and subscriber APIs. See <a href="https://doc.akka.io/docs/akka/current/stream/index.html?language=scala">Akka stream documentation.</a>)</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventPublishExamples.scala#L33-L41" target="_blank" title="Go to snippet source"></a><code class="language-scala">def onError(publishFailure: PublishFailure): Unit =
  log.error(s&quot;Publish failed for event: [${publishFailure.event}]&quot;, ex = publishFailure.cause)

val publisher = eventService.defaultPublisher
val eventStream: Source[Event, Future[Done]] = Source(1 to n)
  .map(id â makeEvent(id, componentInfo.prefix, EventName(&quot;filter_wheel&quot;)))
  .watchTermination()(Keep.right)

publisher.publish(eventStream, failure â onError(failure))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventPublishExamples.java#L43-L48" target="_blank" title="Go to snippet source"></a><code class="language-java">Source&lt;Event, CompletionStage&lt;Done&gt;&gt; eventStream = Source
        .range(1, n)
        .map(id -&gt; makeEvent(id, componentInfo.prefix(), new EventName(&quot;filter_wheel&quot;)))
        .watchTermination(Keep.right());

return eventService.defaultPublisher().&lt;CompletionStage&lt;Done&gt;&gt;publish(eventStream, failure -&gt; { /*do something*/ });</code></pre></dd>
</dl>
<p>This API also demonstrates the usage of onError callback which can be used to be alerted to and handle events that failed while being published. The <code>eventGenerator</code> API showed just above also demonstrates the use of the <code>onError</code> callback.</p>
<p>You can find complete list of APIs supported by <code>EventPublisher</code> and <code>IEventPublisher</code> with detailed description of each API here: </p>
<ul>
  <li><a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/api/scaladsl/EventPublisher.html">EventPublisher</a></li>
  <li><a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/java/?csw/event/api/javadsl/IEventPublisher.html">IEventPublisher</a></li>
</ul>
<h2><a href="#usage-of-eventsubscriber" name="usage-of-eventsubscriber" class="anchor"><span class="anchor-link"></span></a>Usage of EventSubscriber</h2>
<p>The EventSubscriber API has several options available that are useful in different situations. Examples below demonstrate the usage of multiple variations available in the subscribe API.</p>
<h3><a href="#with-callback" name="with-callback" class="anchor"><span class="anchor-link"></span></a>With Callback</h3>
<p>The example shown below takes a set of event keys to subscribe to and a callback function which will be called on each event received by the event stream. This is the simplest and most commonly used API. The example below uses an inline function, but that is not necessary. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala#L20-L27" target="_blank" title="Go to snippet source"></a><code class="language-scala">{
  val subscriber = eventService.defaultSubscriber

  subscriber.subscribeCallback(
    Set(EventKey(hcd.prefix, EventName(&quot;filter_wheel&quot;))),
    event â { /*do something*/ }
  )
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java#L40-L45" target="_blank" title="Go to snippet source"></a><code class="language-java"><br/>IEventSubscriber subscriber = eventService.defaultSubscriber();

EventKey filterWheelEventKey = new EventKey(hcdLocation.prefix(), new EventName(&quot;filter_wheel&quot;));
return subscriber.subscribeCallback(Collections.singleton(filterWheelEventKey), event -&gt; { /*do something*/ });
</code></pre></dd>
</dl>
<h3><a href="#with-asynchronous-callback" name="with-asynchronous-callback" class="anchor"><span class="anchor-link"></span></a>With Asynchronous Callback</h3>
<p>The above example will run into concurrency issues if the callback has an shared state or asynchronous behavior. To avoid that use the following API which will give the guarantee of ordered execution of these asynchronous callbacks. In this case, no further processing occurs until the Future completes.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala#L31-L39" target="_blank" title="Go to snippet source"></a><code class="language-scala">def subscribe(): EventSubscription = {
  val subscriber = eventService.defaultSubscriber
  subscriber.subscribeAsync(Set(EventKey(hcd.prefix, EventName(&quot;filter_wheel&quot;))), callback)
}

private def callback(event: Event): Future[String] = {
  /* do something */
  Future.successful(&quot;some value&quot;)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java#L50-L60" target="_blank" title="Go to snippet source"></a><code class="language-java">public IEventSubscription subscribe() {
    IEventSubscriber subscriber = eventService.defaultSubscriber();

    EventKey filterWheelEventKey = new EventKey(hcdLocation.prefix(), new EventName(&quot;filter_wheel&quot;));
    return subscriber.subscribeAsync(Collections.singleton(filterWheelEventKey), this::callback);
}

private CompletableFuture&lt;String&gt; callback(Event event) {
    /* do something */
    return CompletableFuture.completedFuture(&quot;some value&quot;);
}</code></pre></dd>
</dl>
<h3><a href="#with-actorref" name="with-actorref" class="anchor"><span class="anchor-link"></span></a>With ActorRef</h3>
<p>If there is a need to mutate state on receiving each event, then it is recommended to use this API and send a message to an actor. To use this API, you have to create an actor which takes event and then you can safely keep mutable state inside this actor. In the example shown below, <code>eventHandler</code> is the actorRef which accepts events. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala#L43-L59" target="_blank" title="Go to snippet source"></a><code class="language-scala">def subscribe(ctx: ActorContext[TopLevelActorMessage]): EventSubscription = {
  val subscriber                    = eventService.defaultSubscriber
  val eventHandler: ActorRef[Event] = ctx.spawnAnonymous(EventHandler.make())

  subscriber.subscribeActorRef(Set(EventKey(hcd.prefix, EventName(&quot;filter_wheel&quot;))), eventHandler)
}

object EventHandler {
  def make(): Behavior[Event] = Behaviors.setup(ctx â new EventHandler(ctx))
}

class EventHandler(ctx: ActorContext[Event]) extends AbstractBehavior[Event] {
  override def onMessage(msg: Event): Behavior[Event] = {
    // handle messages
    Behaviors.same
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java#L64-L91" target="_blank" title="Go to snippet source"></a><code class="language-java">public IEventSubscription subscribe(ActorContext&lt;TopLevelActorMessage&gt; ctx) {

    IEventSubscriber subscriber = eventService.defaultSubscriber();
    ActorRef&lt;Event&gt; eventHandler = ctx.spawnAnonymous(new JEventHandlerFactory().make());

    EventKey filterWheelEventKey = new EventKey(hcdLocation.prefix(), new EventName(&quot;filter_wheel&quot;));
    return subscriber.subscribeActorRef(Collections.singleton(filterWheelEventKey), eventHandler);
}

public class JEventHandlerFactory {
    public Behavior&lt;Event&gt; make() {
        return Behaviors.setup(JEventHandler::new);
    }
}

public class JEventHandler extends AbstractBehavior&lt;Event&gt; {
    private ActorContext&lt;Event&gt; ctx;

    JEventHandler(ActorContext&lt;Event&gt; context) {
        ctx = context;
    }

    @Override
    public Receive&lt;Event&gt; createReceive() {
        // handle messages
        return null;
    }
}</code></pre></dd>
</dl>
<h3><a href="#receive-event-stream" name="receive-event-stream" class="anchor"><span class="anchor-link"></span></a>Receive Event Stream</h3>
<p>This API takes a set of Event keys to subscribe to and returns a Source of events (see <a href="https://doc.akka.io/docs/akka/current/stream/index.html?language=scala">Akka stream documentation</a>). This API gives more control to the user to customize behavior of an event stream.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala#L64-L72" target="_blank" title="Go to snippet source"></a><code class="language-scala">{
  val subscriber = eventService.defaultSubscriber

  subscriber
    .subscribe(Set(EventKey(hcd.prefix, EventName(&quot;filter_wheel&quot;))))
    .to(Sink.foreach { event =&gt; /*do something*/
    })
    .run()
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java#L97-L102" target="_blank" title="Go to snippet source"></a><code class="language-java"><br/>IEventSubscriber subscriber = eventService.defaultSubscriber();

EventKey filterWheelEventKey = new EventKey(hcdLocation.prefix(), new EventName(&quot;filter_wheel&quot;));
return subscriber.subscribe(Collections.singleton(filterWheelEventKey)).to(Sink.foreach(event -&gt; { /*do something*/ })).run(mat);
</code></pre></dd>
</dl>
<h3><a href="#controlling-subscription-rate" name="controlling-subscription-rate" class="anchor"><span class="anchor-link"></span></a>Controlling Subscription Rate</h3>
<p>In all the examples shown above, events are received by the subscriber as soon as they are published. There will be scenarios where you would like to control the rate of events received by your code. For instance, slow subscribers can receive events at their own specified speed rather than being overloaded with events to catch up with the publisher&rsquo;s speed. </p>
<p>All the APIs in EventSubscriber can be provided with <code>interval</code> and <code>SubscriptionMode</code> to control the subscription rate. Following example demonstrates this with the subscribeCallback API. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala#L77-L86" target="_blank" title="Go to snippet source"></a><code class="language-scala">{
  val subscriber = eventService.defaultSubscriber

  subscriber.subscribeCallback(
    Set(EventKey(hcd.prefix, EventName(&quot;filter_wheel&quot;))),
    event â { /*do something*/ },
    1.seconds,
    SubscriptionModes.RateAdapterMode
  )
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java#L108-L113" target="_blank" title="Go to snippet source"></a><code class="language-java"><br/>IEventSubscriber subscriber = eventService.defaultSubscriber();

EventKey filterWheelEventKey = new EventKey(hcdLocation.prefix(), new EventName(&quot;filter_wheel&quot;));
return subscriber.subscribeCallback(Collections.singleton(filterWheelEventKey), event -&gt; { /* do something*/ }, Duration.ofMillis(1000), SubscriptionModes.jRateAdapterMode());
</code></pre></dd>
</dl>
<p>There are two types of Subscription modes:</p>
<ul>
  <li><code>RateAdapterMode</code> which ensures that an event is received exactly at each tick of the specified interval.</li>
  <li><code>RateLimiterMode</code> which ensures that events are received as they are published along with the guarantee that no more than one event is delivered within a given interval.</li>
</ul>
<p>Read more about Subscription Mode <a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/api/scaladsl/SubscriptionMode.html">here</a></p>
<h3><a href="#pattern-subscription" name="pattern-subscription" class="anchor"><span class="anchor-link"></span></a>Pattern Subscription</h3>
<p>The following example demonstrates the usage of pattern subscribe API with callback. Events with keys that match the specified pattern and belong to the given subsystem are received by the subscriber. The callback function provided is called on each event received.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala#L91-L94" target="_blank" title="Go to snippet source"></a><code class="language-scala">{
  val subscriber = eventService.defaultSubscriber
  subscriber.pSubscribeCallback(subsystem, &quot;*&quot;, event â { /*do something*/ })
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java#L120-L123" target="_blank" title="Go to snippet source"></a><code class="language-java"><br/>IEventSubscriber subscriber = eventService.defaultSubscriber();
subscriber.pSubscribeCallback(subsystem, &quot;*&quot;, event -&gt; { /* do something*/ });
</code></pre></dd>
</dl><div class="callout warning "><div class="callout-title">Warning</div>
<p>DO NOT include subsystem in the provided pattern. Final pattern generated will be provided pattern prepended with subsystem. For Ex. <code>pSubscribe(Subsytem.WFOS, *)</code> will subscribe to event keys matching pattern : <code>wfos.*</code></p></div><div class="callout warning "><div class="callout-title">Warning</div>
<p>The pattern-based subscribe API is provided because it is useful in testing, but <em>should not be used in production code</em>. The use of certain patterns and many pattern-based subscriptions can impact the overall-performance of the Event Service.</p></div>
<h3><a href="#event-subscription" name="event-subscription" class="anchor"><span class="anchor-link"></span></a>Event Subscription</h3>
<p>On subscription to event keys, you receive an <a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/api/scaladsl/EventSubscription.html">EventSubscription</a> which provides following APIs:</p>
<ul>
  <li>
  <p><code>unsubscribe</code>: On un-subscribing, the event stream is destroyed and the connection created to event server while subscription is released.</p></li>
  <li>
  <p><code>ready</code>: check if event subscription is successful or not. </p></li>
</ul>
<p>You can find complete list of API&rsquo;s supported by <code>EventSubscriber</code> and <code>IEventSubscriber</code> with detailed description of each API here: </p>
<ul>
  <li><a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/api/scaladsl/EventSubscriber.html">EventSubscriber</a></li>
  <li><a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/java/?csw/event/api/javadsl/IEventSubscriber.html">IEventSubscriber</a></li>
</ul>
<h2><a href="#create-event-service" name="create-event-service" class="anchor"><span class="anchor-link"></span></a>Create Event Service</h2>
<p>If you are not using csw-framework, you can create <a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/api/scaladsl/EventService.html">EventService</a> using <a href="https://tmtsoftware.github.io/csw/0.1-SNAPSHOT/api/scala/csw/event/EventServiceFactory.html">EventServiceFactory</a>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventServiceCreationExamples.scala#L21-L25" target="_blank" title="Go to snippet source"></a><code class="language-scala">// create event service using location service
val eventService1: EventService = new EventServiceFactory().make(locationService)

// create event service using host and port of event server.
val eventService2: EventService = new EventServiceFactory().make(&quot;localhost&quot;, 26379)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventServiceCreationExamples.java#L23-L27" target="_blank" title="Go to snippet source"></a><code class="language-java">// create event service using host and port of event server.
IEventService eventService1 = new EventServiceFactory().jMake(locationService, actorSystem);

// create event service using host and port of event server.
IEventService eventService2 = new EventServiceFactory().jMake(&quot;localhost&quot;, 26379, actorSystem);</code></pre></dd>
</dl>
<p>The provided implementation of Event Service is backed up by Redis. The above example demonstrates creation of Event Service with default Redis client options. You can optionally supply a RedisClient to the EventStore from outside which allows you to customize the behaviour of RedisClient used by Event Service, which in most often be required in test scope only. </p>
<p>RedisClient is an expensive resource. Reuse this instance as much as possible.</p>
<p>Note that it is the responsibility of consumer of this API to shutdown Redis Client when it is no longer in use.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventServiceCreationExamples.scala#L31-L40" target="_blank" title="Go to snippet source"></a><code class="language-scala"><br/>val clientOptions = ClientOptions.builder().disconnectedBehavior(DisconnectedBehavior.REJECT_COMMANDS).build
val redisClient   = RedisClient.create()
redisClient.setOptions(clientOptions)

// create event service using location service
val eventService1: EventService = new EventServiceFactory(RedisStore(redisClient)).make(locationService)

// create event service using host and port of event server.
val eventService2: EventService = new EventServiceFactory(RedisStore(redisClient)).make(&quot;localhost&quot;, 26379)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventServiceCreationExamples.java#L34-L43" target="_blank" title="Go to snippet source"></a><code class="language-java">ClientOptions clientOptions = ClientOptions.builder().disconnectedBehavior(ClientOptions.DisconnectedBehavior.REJECT_COMMANDS).build();
RedisClient redisClient   = RedisClient.create();
redisClient.setOptions(clientOptions);

EventStores.RedisStore redisStore = new EventStores.RedisStore(redisClient);
// create event service using location service
IEventService eventService1 = new EventServiceFactory(redisStore).jMake(locationService, actorSystem);

// create event service using host and port of event server.
IEventService eventService2 = new EventServiceFactory(redisStore).jMake(&quot;localhost&quot;, 26379, actorSystem);</code></pre></dd>
</dl>
<h2><a href="#source-code-for-examples-of-creation" name="source-code-for-examples-of-creation" class="anchor"><span class="anchor-link"></span></a>Source code for examples of creation</h2>
<ul>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventServiceCreationExamples.scala">Scala Example</a></li>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventServiceCreationExamples.java">Java Example</a></li>
</ul>
<h2><a href="#source-code-for-examples-of-publishing" name="source-code-for-examples-of-publishing" class="anchor"><span class="anchor-link"></span></a>Source code for examples of publishing</h2>
<ul>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventPublishExamples.scala">Scala Example</a></li>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventPublishExamples.java">Java Example</a></li>
</ul>
<h2><a href="#source-code-for-examples-of-subscribing" name="source-code-for-examples-of-subscribing" class="anchor"><span class="anchor-link"></span></a>Source code for examples of subscribing</h2>
<ul>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/event/EventSubscribeExamples.scala">Scala Example</a></li>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/event/JEventSubscribeExamples.java">Java Example</a></li>
</ul>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/services/event.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../services/logging.html" title="Logging Service" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Logging Service
</span>
</div>
</a>
<a href="../services/alarm.html" title="Alarm Service" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Alarm Service
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
