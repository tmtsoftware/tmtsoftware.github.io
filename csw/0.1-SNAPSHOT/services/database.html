<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>Database Service · TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Database Service
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../messages/units.html" class="page">Units</a></li>
    <li><a href="../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../messages/events.html" class="page">Events</a></li>
    <li><a href="../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="page">Event Service</a></li>
    <li><a href="../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../services/time.html" class="page">Time Service</a></li>
    <li><a href="../services/database.html" class="active page">Database Service</a></li>
    <li><a href="../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../apps/cswadminserver.html" class="page">csw-admin-server</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../services/database.html#database-service" class="header">Database Service</a>
  <ul>
    <li><a href="../services/database.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../services/database.html#accessing-database-service" class="header">Accessing Database Service</a></li>
    <li><a href="../services/database.html#using-dslcontext" class="header">Using DSLContext</a></li>
    <li><a href="../services/database.html#source-code-for-examples" class="header">Source code for examples</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../services/database.html#database-service" class="header">Database Service</a>
  <ul>
    <li><a href="../services/database.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../services/database.html#accessing-database-service" class="header">Accessing Database Service</a></li>
    <li><a href="../services/database.html#using-dslcontext" class="header">Using DSLContext</a></li>
    <li><a href="../services/database.html#source-code-for-examples" class="header">Source code for examples</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#database-service" name="database-service" class="anchor"><span class="anchor-link"></span></a>Database Service</h1>
<p>The Database Service is included in TMT Common Software for use by components that need the features of a relational database. CSW Database Service provides a TMT-standard relational database and connection library. Databases created by Database Service will be stored reliably at the site during operations.</p>
<p>The Database Service provides an API to manage database connections and access data in the TMT Software System. The service provides <code>PostgreSQL</code> as the underlying database server. It uses the <code>Jooq</code> library underneath to manage database access, connection pooling, etc.</p><div class="callout note "><div class="callout-title">Note</div>
<p><code>Jooq</code> is a Java library that provides a higher level API for accessing data i.e. DDL support, DML support, fetch, batch execution, prepared statements, safety against sql injection, connection pooling, etc. To know more about Jooq and its features, please refer to this <a href="https://www.jooq.org/learn/">link</a>.</p></div>
<p>Database Service requires <code>PostgreSQL</code> server to be running on a machine. To start the PostgreSQL server for development and testing purposes, refer to <a href="../commons/apps.html#starting-apps-for-development">Starting Apps for Development</a>.</p>
<p>Once the PostgreSQL is up and running, Database Service can be used to connect and access data. It is assumed that there will be more than one user types registered with PostgreSQL i.e. for read access, for write access, for admin access, etc.</p>
<!-- introduction to the service -->
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>To include the Database Service in a component, add this to your <code>build.sbt</code> file:</p>
<dl>
  <dt>sbt</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;com.github.tmtsoftware.csw&quot; %% &quot;csw-database&quot; % &quot;0.1-SNAPSHOT&quot;
</code></pre></dd>
</dl>
<h2><a href="#accessing-database-service" name="accessing-database-service" class="anchor"><span class="anchor-link"></span></a>Accessing Database Service</h2>
<p>Database Service is accessed differently than other CSW services in that it is not passed to a component through <code>CswContext/JCswContext</code> in the component&rsquo;s ComponentHandlers. To access Database Service, developers create a <code>DatabaseServiceFactory</code>. DatabaseServiceFactory can be created anywhere in the code using an <code>ActorSystem</code> and its creation is explained in next section. </p><div class="callout note "><div class="callout-title">Note</div>
<p>Creating a new DatabaseServiceFactory does not mean a new connection to PostgreSQL server will be created. Database connections are managed in a pool by the underlying Database Service implementation. Hence, creating multiple DatabaseServiceFactory per component can be considered pretty cheap and harmless. But it is also possible to save what is returned by DatabaseServiceFactory and pass it around your component.</p></div>
<h4><a href="#connect-with-read-access" name="connect-with-read-access" class="anchor"><span class="anchor-link"></span></a>Connect with Read Access</h4>
<p>Our access approach is that all components can read any Database Service database and clients that only need read access use the following factory method. But a writer will need a special username/password with write access as shown below.</p>
<p>By default while connecting to PostgreSQL, Database Service will provide read access for data. To achieve that, create an instance of <code>DatabaseServiceFactory</code> and use it as shown below:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L26-L30" target="_blank" title="Go to snippet source"></a><code class="language-scala">val dbFactory = new DatabaseServiceFactory(ctx.system)

dbFactory
  .makeDsl(locationService, &quot;postgres&quot;) // postgres is dbName
  .foreach((dsl: DSLContext) ⇒ this.dsl = dsl) // save returned dsl to a local variable</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L37-L41" target="_blank" title="Go to snippet source"></a><code class="language-java">dbFactory = new DatabaseServiceFactory(ctx.getSystem());

dbFactory
        .jMakeDsl(cswCtx.locationService(), &quot;postgres&quot;) // postgres is dbName
        .thenAccept((DSLContext dsl) -&gt; this.dsl = dsl);        // save the returned dsl to a local variable</code></pre></dd>
</dl>
<p>The underlying database server is registered with the Location Service. <code>makeDsl</code>/<code>jMakeDsl</code> takes <code>locationService</code> to locate the PostgreSQL server running and connect to it. It connects to the database by the provided <code>dbName</code>. It picks the database username and password for read access profile from TMT-standard environment variables called <code>dbReadUsername</code> for username and <code>dbReadPassword</code> for password, hence it is expected that developers will set these environment variables prior to using <code>DatabaseServiceFactory</code>. PostgreSQL should also be initialized with a read-only user and password that agrees with the values in the environment variables. This approach is used to keep from putting database login information in the source code. </p><div class="callout note "><div class="callout-title">Note</div>
<p>See the <a href="https://www.postgresql.org/docs/8.0/sql-createuser.html">PostgreSQL docs</a> or <a href="https://www.a2hosting.com/kb/developer-corner/postgresql/managing-postgresql-databases-and-users-from-the-command-line">this site</a> for help with creating users, passwords, and roles in PostgreSQL.</p>
<p>The <a href="https://www.postgresql.org/docs/current/app-psql.html">psql interactive CLI client</a> is provided with PostgreSQL. It can be used to connect to PostgreSQL and create users (as well as many other maintenance commands). If Database Service is started with csw-services.sh, the database server is started on port <em>5432</em>.</p>
<p>Eventually, all TMT user logins will all have these environment variables set with the agreed upon read-only user and password. </p></div>
<p><code>makeDsl</code>/<code>jMakeDsl</code> returns a <code>Jooq</code> type <code>DSLContext</code>. DSLContext provides the mechanism to access the data stored in PostgreSQL using the selected JDBC driver underneath. The usage of DSLContext in component development will be explained in later sections. </p><div class="callout note "><div class="callout-title">Hint</div>
<ul>
  <li>Any exception encountered while connecting to PostgreSQL server will be wrapped in <code>DatabaseException</code>.</li>
</ul></div>
<h4><a href="#connect-with-write-access" name="connect-with-write-access" class="anchor"><span class="anchor-link"></span></a>Connect with Write Access</h4>
<p>In order to connect to PostgreSQL for write access (or any other access other than read), use the <code>DatabaseServiceFactory</code> as shown below with different environment variables: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L34-L36" target="_blank" title="Go to snippet source"></a><code class="language-scala">dbFactory
  .makeDsl(locationService, &quot;postgres&quot;, &quot;dbWriteUsername&quot;, &quot;dbWritePassword&quot;)
  .foreach((dsl: DSLContext) ⇒ this.dsl = dsl) // save returned dsl to a local variable</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L45-L47" target="_blank" title="Go to snippet source"></a><code class="language-java">dbFactory
        .jMakeDsl(cswCtx.locationService(), &quot;postgres&quot;, &quot;dbWriteUsername&quot;, &quot;dbWritePassword&quot;)
        .thenAccept((DSLContext dsl) -&gt; this.dsl = dsl);        // save the returned dsl to a local variable</code></pre></dd>
</dl>
<p>Here the username is picked from <code>dbWriteUsername</code> and password is picked from <code>dbWritePassword</code> environment variables. Hence, it is expected from developers to set environment variables prior to using this method with the user name and password to use for write access. </p>
<h4><a href="#connect-for-development-or-testing" name="connect-for-development-or-testing" class="anchor"><span class="anchor-link"></span></a>Connect for Development or Testing</h4>
<p>For development and testing purposes, all database connection properties can be provided from <code>application.conf</code> including username and password. This will not require setting any environment variables for credentials as described in previous sections. In order to do so, use the <code>DatabaseServiceFactory</code> as shown below:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L40-L42" target="_blank" title="Go to snippet source"></a><code class="language-scala">dbFactory
  .makeDsl()
  .foreach((dsl: DSLContext) ⇒ this.dsl = dsl) // save returned dsl to a local variable</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L51-L53" target="_blank" title="Go to snippet source"></a><code class="language-java">dbFactory
        .jMakeDsl()
        .thenAccept((DSLContext dsl) -&gt; this.dsl = dsl);        // save the returned dsl to a local variable</code></pre></dd>
</dl>
<p>The reference for providing database properties is shown below:</p>
<dl>
  <dt>reference.conf
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/csw-database/src/main/resources/reference.conf" target="_blank" title="Go to snippet source"></a><code class="language-conf">csw-database = {
  databaseDialect = POSTGRES_10
  hikari-datasource {
    dataSourceClassName = org.postgresql.ds.PGSimpleDataSource
//    dataSource {
      //  serverName = &lt;server_name&gt;
      //  portNumber = &lt;port_number&gt;
      //  databaseName = &lt;database_name&gt;
      //  user = &lt;username&gt;
      //  password = &lt;password&gt;
//    }

    // Below are the default properties of HikariCP
    //autoCommit = true
    //connectionTimeout = 30000 (30 seconds)
    //idleTimeout = 600000 (10 minutes)
    //maxLifetime = 600000 (10 minutes)
    //maximumPoolSize = 10
    //minimumIdle = 10 (same as max pool size)
  }
}</code></pre></dd>
</dl>
<p>In order to override any property shown above, it needs to be defined in <code>application.conf</code> for e.g. a sample application.conf can look as follows:</p>
<pre><code>csw-database.hikari-datasource.dataSource {
  serverName = localhost
  portNumber = 5432
  databaseName = postgres
  user = postgres
  password = postgres
}
</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>By default CSW configures <code>HikariCP</code> connection pool for managing connections with PostgreSQL server. To know more about <code>HikariCP</code> please refer this <a href="http://brettwooldridge.github.io/HikariCP/">link</a>. </p></div>
<h2><a href="#using-dslcontext" name="using-dslcontext" class="anchor"><span class="anchor-link"></span></a>Using DSLContext</h2>
<p>Once the DSLContext is returned from <code>makeDsl/jMakeDsl</code>, it can be used to provide plain SQL to Database Service and get it executed on the PostgreSQL server.</p>
<p>The following sections show examples of most typical SQL use cases.</p>
<h4><a href="#create" name="create" class="anchor"><span class="anchor-link"></span></a>Create</h4>
<p>To create a table, use the DSLContext as follows:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L49-L53" target="_blank" title="Go to snippet source"></a><code class="language-scala">val createQuery: Query = dsl.query(&quot;CREATE TABLE films (id SERIAL PRIMARY KEY, Name VARCHAR (10) NOT NULL)&quot;)

import csw.database.scaladsl.JooqExtentions.RichQuery
val createResultF: Future[Integer] = createQuery.executeAsyncScala()
createResultF.foreach(result ⇒ println(s&quot;Films table created with $result&quot;))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L77-L79" target="_blank" title="Go to snippet source"></a><code class="language-java">Query createQuery = dsl.query(&quot;CREATE TABLE films (id SERIAL PRIMARY KEY, Name VARCHAR (10) NOT NULL)&quot;);
CompletionStage&lt;Integer&gt; createResultF = createQuery.executeAsync();
createResultF.thenAccept(result -&gt; System.out.println(&quot;Films table created with &quot; + result));</code></pre></dd>
</dl>
<h4><a href="#insert" name="insert" class="anchor"><span class="anchor-link"></span></a>Insert</h4>
<p>To insert data in batch, use the DSLContext as follows:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L57-L66" target="_blank" title="Go to snippet source"></a><code class="language-scala">val movie_2 = &quot;movie_2&quot;

val queries = dsl.queries(
  dsl.query(&quot;INSERT INTO films(name) VALUES (?)&quot;, &quot;movie_1&quot;),
  dsl.query(&quot;INSERT INTO films(id, name) VALUES (?, ?)&quot;, &quot;2&quot;, movie_2)
)

import csw.database.scaladsl.JooqExtentions.RichQueries
val batchResultF: Future[List[Int]] = queries.executeBatchAsync()
batchResultF.foreach(results ⇒ println(s&quot;executed queries [$queries] with results [$results]&quot;))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L83-L92" target="_blank" title="Go to snippet source"></a><code class="language-java">String movie_2 = &quot;movie_2&quot;;

Queries queries = dsl.queries(
        dsl.query(&quot;INSERT INTO films(name) VALUES (?)&quot;, &quot;movie_1&quot;),
        dsl.query(&quot;INSERT INTO films(id, name) VALUES (?, ?)&quot;, 2, movie_2)
);

CompletableFuture&lt;int[]&gt; batchResultF = JooqHelper.executeBatch(queries);
batchResultF.thenAccept(results -&gt;
        System.out.println(&quot;executed queries [&quot; + queries + &quot;] with results [&quot; + Arrays.toString(results) + &quot;]&quot;));</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<ul>
  <li>The insert statements above gets mapped to prepared statements underneath at JDBC layer and values like <code>movie_1</code>,  <code>movie_2</code> and <code>2</code> from the example are bound to the dynamic parameters of these generated prepared statements.</li>
  <li>As prepared statements provide safety against SQL injection, it is recommended to use prepared statements instead of static  SQL statements whenever there is a need to dynamically bind values.</li>
  <li>In the above example, two insert statements are batched together and sent to PostgreSQL server in a single call.  <code>executeBatchAsync/executeBatch</code> maps to batch statements underneath at JDBC layer.</li>
</ul></div>
<h4><a href="#select" name="select" class="anchor"><span class="anchor-link"></span></a>Select</h4>
<p>To select data from table, use the DSLContext as follows:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L70-L78" target="_blank" title="Go to snippet source"></a><code class="language-scala">// domain model
case class Films(id: Int, name: String) // variable name and type should be same as column&#39;s name and type in database

// fetch data from table and map it to Films class
val selectQuery = dsl.resultQuery(&quot;SELECT id, name FROM films WHERE id = ?&quot;, &quot;1&quot;)

import csw.database.scaladsl.JooqExtentions.RichResultQuery
val selectResultF: Future[List[Films]] = selectQuery.fetchAsyncScala[Films]
selectResultF.foreach(names ⇒ s&quot;Fetched names of films $names&quot;)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L96-L105" target="_blank" title="Go to snippet source"></a><code class="language-java">// domain model
class Films {
    private Integer id;  // variable name (id) and type (Integer) should be same as column&#39;s name and type in database
    private String name; // variable name (name) and type (String) should be same as column&#39;s name and type in database
};

// fetch data from table and map it to Films class
ResultQuery&lt;Record&gt; selectQuery = dsl.resultQuery(&quot;SELECT id, name FROM films WHERE id = ?&quot;, 1);
CompletableFuture&lt;List&lt;Films&gt;&gt; selectResultF = JooqHelper.fetchAsync(selectQuery, Films.class);
selectResultF.thenAccept(names -&gt; System.out.println(&quot;Fetched names of films &quot; + names));</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>Make sure that variable name and type of Films class is same as column&rsquo;s name and type in database. This is necessary for successful mapping of table fields to domain model class.</p></div>
<h4><a href="#stored-function" name="stored-function" class="anchor"><span class="anchor-link"></span></a>Stored Function</h4>
<p>To create a stored function, use the DSLContext as follows:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala#L82-L94" target="_blank" title="Go to snippet source"></a><code class="language-scala">val functionQuery = dsl
  .query(
    &quot;&quot;&quot;
    |CREATE FUNCTION inc(val integer) RETURNS integer AS $$
    |BEGIN
    |RETURN val + 1;
    |END; $$
    |LANGUAGE PLPGSQL;
    &quot;&quot;&quot;.stripMargin
  )

val functionResultF: Future[Integer] = functionQuery.executeAsyncScala()
functionResultF.foreach(result ⇒ println(s&quot;Function inc created with $result&quot;))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java#L109-L116" target="_blank" title="Go to snippet source"></a><code class="language-java">Query functionQuery = dsl.query(&quot;CREATE FUNCTION inc(val integer) RETURNS integer AS $$\n&quot; +
        &quot;BEGIN\n&quot; +
        &quot;RETURN val + 1;\n&quot; +
        &quot;END; $$\n&quot; +
        &quot;LANGUAGE PLPGSQL;&quot;);

CompletionStage&lt;Integer&gt; functionResultF = functionQuery.executeAsync();
functionResultF.thenAccept(result -&gt; System.out.println(&quot;Function inc created with  &quot; + result));</code></pre></dd>
</dl>
<p>Similarly, any SQL queries can be written with the help of DSLContext including stored procedures.</p><div class="callout note "><div class="callout-title">Note</div>
<p>If there is a syntax error in SQL queries the <code>Future/CompletableFuture</code> returned will fail with <code>CompletionException</code> and <code>CompletionStage</code> will fail with <code>ExecutionException</code>. But both <code>CompletionException</code> and <code>ExecutionException</code> will have Jooq&rsquo;s <code>DataAccessException</code> underneath as cause. </p></div>
<p>These examples are just a start. Any SQL statement can be created and executed using the DSLContext.</p>
<h2><a href="#source-code-for-examples" name="source-code-for-examples" class="anchor"><span class="anchor-link"></span></a>Source code for examples</h2>
<ul>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/database/AssemblyComponentHandlers.scala">Scala Example</a></li>
  <li><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/database/JAssemblyComponentHandlers.java">Java Example</a></li>
</ul>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/services/database.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../services/time.html" title="Time Service" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Time Service
</span>
</div>
</a>
<a href="../services/aas.html" title="Authentication and Authorization Service (AAS)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Authentication and Authorization Service (AAS)
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
