<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../assets/tmt_favicon.ico">
<title>Installed Auth Adapter (csw-aas-installed) Â· TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../lib/prettify/prettify.css">
<script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Installed Auth Adapter (csw-aas-installed)
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
  <li><a href="../../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../../messages/units.html" class="page">Units</a></li>
    <li><a href="../../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../../messages/events.html" class="page">Events</a></li>
    <li><a href="../../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../../services/location.html" class="page">Location Service</a></li>
    <li><a href="../../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../../services/event.html" class="page">Event Service</a></li>
    <li><a href="../../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../../services/time.html" class="page">Time Service</a></li>
    <li><a href="../../services/database.html" class="page">Database Service</a></li>
    <li><a href="../../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
  </ul></li>
  <li><a href="../../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../../apps/cswadminserver.html" class="page">csw-admin-server</a></li>
    <li><a href="../../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../services/aas/csw-aas-installed.html#installed-auth-adapter-csw-aas-installed-" class="header">Installed Auth Adapter (csw-aas-installed)</a>
  <ul>
    <li><a href="../../services/aas/csw-aas-installed.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#prerequisites" class="header">Prerequisites</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#application-configurations" class="header">Application Configurations</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#building-a-cli-application" class="header">Building a CLI Application</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#source-code-for-above-examples" class="header">Source code for above examples</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../services/aas/csw-aas-installed.html#installed-auth-adapter-csw-aas-installed-" class="header">Installed Auth Adapter (csw-aas-installed)</a>
  <ul>
    <li><a href="../../services/aas/csw-aas-installed.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#prerequisites" class="header">Prerequisites</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#application-configurations" class="header">Application Configurations</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#building-a-cli-application" class="header">Building a CLI Application</a></li>
    <li><a href="../../services/aas/csw-aas-installed.html#source-code-for-above-examples" class="header">Source code for above examples</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#installed-auth-adapter-csw-aas-installed-" name="installed-auth-adapter-csw-aas-installed-" class="anchor"><span class="anchor-link"></span></a>Installed Auth Adapter (csw-aas-installed)</h1>
<p>csw-aas-installed is the adapter you will use if you want to build an that executes on user&rsquo;s machine &amp; talks to auth-protected web service application. Examples of such applications could be a CLI app that is installed on end users machine.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>To use the Akka HTTP Adapter (csw-aas-installed), add this to your <code>build.sbt</code> file:</p>
<dl>
  <dt>sbt</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;com.github.tmtsoftware.csw&quot; %% &quot;csw-aas-installed&quot; % &quot;0.1-SNAPSHOT&quot;
</code></pre></dd>
</dl>
<h2><a href="#prerequisites" name="prerequisites" class="anchor"><span class="anchor-link"></span></a>Prerequisites</h2>
<p>To run a client app that is installed on user&rsquo;s machine, which needs to talk to a protected http server, we need</p>
<ul>
  <li>location service running</li>
  <li>Keycloak instance running and registered with location service</li>
  <li>protected http server running</li>
</ul>
<p>All of these can be running on different machines. To start location service &amp; keycloak server on a local machine, you make make use of csw-services.sh script.</p>
<h2><a href="#application-configurations" name="application-configurations" class="anchor"><span class="anchor-link"></span></a>Application Configurations</h2>
<p>All auth related configurations go inside <code>auth-config</code> block. There are two configurations applicable for a public cli client application i.e. <code>realm</code> &amp; <code>client-id</code>.</p>
<p><code>realm</code> has a default value of <code>TMT</code> if not specified. Ideally all apps in TMT should not have to override this, however it might be useful to override this while testing your app.</p>
<p><code>client-id</code> is a mandatory configuration which specifies the client id of the app as per registration in keycloak.</p>
<pre class="prettyprint"><code class="language-hocon">auth-config {
  realm = TMT # DEFAULT
  client-id = demo-cli # REQUIRED
}
</code></pre>
<h2><a href="#building-a-cli-application" name="building-a-cli-application" class="anchor"><span class="anchor-link"></span></a>Building a CLI Application</h2>
<p>Let&rsquo;s say that we have an existing akka-http application which has some open and some protected routes and we want to build a CLI client which accesses these routes.</p>
<p>This is what the routes look like:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/SampleRoutes.scala#L29-L43" target="_blank" title="Go to snippet source"></a><code class="language-scala">var data: Set[String] = Set.empty

val routes: Route =
  pathPrefix(&quot;data&quot;) {
    get { // un-protected route for reading data
      pathEndOrSingleSlash { // e.g HTTP GET http://localhost:7000/data
        complete(data)
      }
    } ~ sPost(RealmRolePolicy(&quot;admin&quot;)) { // only users with &#39;admin&#39; role is allowed for this route
      parameter(&quot;value&quot;) { value =&gt; // e.g POST GET localhost:7000/data?value=abc
        data = data + value
        complete(StatusCodes.OK)
      }
    }
  }</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>To know more about how to create secure web apis, please go through <a href="csw-aas-http.html">Akka HTTP Adapter - csw-aas-http</a></p></div>
<p>We will create a CLI application that has following commands:</p>
<table>
  <thead>
    <tr>
      <th align="left">command </th>
      <th align="left">description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="left">login </td>
      <td align="left">performs user authentication </td>
    </tr>
    <tr>
      <td align="left">logout </td>
      <td align="left">logs user out </td>
    </tr>
    <tr>
      <td align="left">read </td>
      <td align="left">reads data from server </td>
    </tr>
    <tr>
      <td align="left">write {content} </td>
      <td align="left">writes data to server </td>
    </tr>
  </tbody>
</table>
<p>Let&rsquo;s begin with <code>Main.scala</code></p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/Main.scala#L10-L25" target="_blank" title="Go to snippet source"></a><code class="language-scala">object Main extends App {

  LocationServerStatus.requireUpLocally()

  implicit val actorSystem: ActorSystem = ActorSystem()

  val adapter: InstalledAppAuthAdapter = AdapterFactory.makeAdapter

  val command: Option[AppCommand] = CommandFactory.makeCommand(adapter, args)

  try {
    command.foreach(_.run())
  } finally {
    actorSystem.terminate()
  }
}</code></pre></dd>
</dl>
<p>The statement <code>LocationServerStatus.requireUpLocally()</code> ensures that location service is up and running before proceeding further. If location service is not running, it will throw an exception and exit the application.</p><div class="callout note "><div class="callout-title">Note</div>
<p>In a real application, you would ideally want to use <code>LocationServerStatus.requireUp</code> which takes <code>locationHost: String</code> parameter instead of looking for location service on localhost. </p></div>
<p>Next, we will instantiate <code>InstalledAppAuthAdapter</code>. There is a factory already available to create the required instance. We will create a small factory on top this factory to keep our Main.scala clean.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/AdapterFactory.scala#L16-L24" target="_blank" title="Go to snippet source"></a><code class="language-scala">object AdapterFactory {
  def makeAdapter(implicit actorSystem: ActorSystem): InstalledAppAuthAdapter = {
    implicit val ec: ExecutionContextExecutor = actorSystem.dispatcher
    implicit val mat: Materializer            = ActorMaterializer()
    val locationService: LocationService      = HttpLocationServiceFactory.makeLocalClient(actorSystem, mat)
    val authStore                             = new FileAuthStore(Paths.get(&quot;/tmp/demo-cli/auth&quot;))
    InstalledAppAuthAdapterFactory.make(locationService, authStore)
  }
}</code></pre></dd>
</dl>
<p>Note the the internal factory overload we have used, requires two parameters, i.e. location service &amp; authStore. It needs location service to resolve keycloak server. FileAuthStore is just a storage for tokens for it to save access tokens &amp; refresh tokens in file system. </p><div class="callout warning "><div class="callout-title">Warning</div>
<p>In this case we have configured it to store all tokens in &ldquo;/tmp/demo-cli/auth&rdquo; directory but ideally you want this location to be somewhere in user&rsquo;s home directory. This will ensure that different users don&rsquo;t have access to each other&rsquo;s tokens.</p></div>
<p>Coming back to Main.scala, now we need to find out which command user wants to execute. To parse user input arguments, we will create a small utility.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/commands/CommandFactory.scala#L7-L20" target="_blank" title="Go to snippet source"></a><code class="language-scala">object CommandFactory {
  def makeCommand(adapter: InstalledAppAuthAdapter,
                  args: Array[String])(implicit actorSystem: ActorSystem): Option[AppCommand] = {
    args match {
      case Array(&quot;login&quot;)          =&gt; Some(new LoginCommand(adapter))
      case Array(&quot;logout&quot;)         =&gt; Some(new LogoutCommand(adapter))
      case Array(&quot;read&quot;)           =&gt; Some(new ReadCommand)
      case Array(&quot;write&quot;, content) =&gt; Some(new WriteCommand(adapter, content))
      case _ =&gt;
        println(&quot;invalid or no command\nvalid commands are: login, logout, read &amp; write&quot;)
        None
    }
  }
}</code></pre></dd>
</dl>
<p>All of these commands extend from a simple trait - <code>AppCommand</code></p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/commands/AppCommand.scala#L4-L6" target="_blank" title="Go to snippet source"></a><code class="language-scala">trait AppCommand {
  def run(): Unit
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>We could have used a command line parser library here to parse the command names and options/arguments, but since our requirements are simple and this is a demonstration, we will keep things simple. However, we strongly recommend that you use one of the existing libraries. CSW makes extensive use of <a href="https://github.com/scopt/scopt">scopt</a>. There are other libraries which are equally good and easy to use</p></div>
<p>Let&rsquo;s go through each command one by one </p>
<h3><a href="#login" name="login" class="anchor"><span class="anchor-link"></span></a>Login</h3>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/commands/LoginCommand.scala#L6-L11" target="_blank" title="Go to snippet source"></a><code class="language-scala">class LoginCommand(val installedAppAuthAdapter: InstalledAppAuthAdapter) extends AppCommand {
  override def run(): Unit = {
    installedAppAuthAdapter.login()
    println(&quot;SUCCESS : Logged in successfully&quot;)
  }
}</code></pre></dd>
</dl>
<p>Here the constructor takes InstalledAppAuthAdapter as a parameter and in the run method, it calls <code>installedAppAuthAdapter.login()</code>. This method, opens a browser and redirects user to TMT login screen (served by keycloak). In the background, it starts an http server on a random port. Once the user submits correct credentials on the login screen, keycloak redirects user to <code>http://localhost:[RandomPort]</code> with the access and refresh tokens in query string. The InstalledAppAuthAdapter will then save these token in file system using FileAuthStore. After this, InstalledAppAuthAdapter will shut down the local server since it&rsquo;s purpose is served. Now, user can close the browser.</p>
<p>If you want to develop an CLI app that is not dependent on browser, you can call <code>loginCommandLine()</code> method instead of <code>login()</code>. This will prompt credentials in CLI instead of opening a browser.</p><div class="callout note "><div class="callout-title">Note</div>
<p>It may be tempting to use the <code>loginCommandLine()</code> method, however a browser is generally more user-friendly since it can store cookies &amp; remember passwords.</p></div>
<h3><a href="#logout" name="logout" class="anchor"><span class="anchor-link"></span></a>Logout</h3>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/commands/LogoutCommand.scala#L6-L11" target="_blank" title="Go to snippet source"></a><code class="language-scala">class LogoutCommand(val installedAppAuthAdapter: InstalledAppAuthAdapter) extends AppCommand {
  override def run(): Unit = {
    installedAppAuthAdapter.logout()
    println(&quot;SUCCESS : Logged out successfully&quot;)
  }
}</code></pre></dd>
</dl>
<p>The structure here is very similar to login command. <code>installedAppAuthAdapter.logout()</code> clears all the tokens from file system via <code>FileAuthStore</code>.</p>
<h3><a href="#read" name="read" class="anchor"><span class="anchor-link"></span></a>Read</h3>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/commands/ReadCommand.scala#L14-L20" target="_blank" title="Go to snippet source"></a><code class="language-scala">class ReadCommand(implicit val actorSystem: ActorSystem) extends AppCommand {
  override def run(): Unit = {
    val url      = &quot;http://localhost:7000/data&quot;
    val response = Await.result(Http().singleRequest(HttpRequest(uri = Uri(url))), 2.seconds)
    println(convertToString(response.entity))
  }
}</code></pre></dd>
</dl>
<p>Since in the akka-http routes, the get route is not protected by any authentication or authorization, read command simply sends a get request and prints the response.</p>
<h3><a href="#write" name="write" class="anchor"><span class="anchor-link"></span></a>Write</h3>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed/commands/WriteCommand.scala#L12-L44" target="_blank" title="Go to snippet source"></a><code class="language-scala">class WriteCommand(val installedAppAuthAdapter: InstalledAppAuthAdapter, value: String)(implicit val actorSystem: ActorSystem)
    extends AppCommand {
  override def run(): Unit = {

    installedAppAuthAdapter.getAccessTokenString() match {
      case Some(token) =&gt;
        val bearerToken = headers.OAuth2BearerToken(token)
        val url         = s&quot;http://localhost:7000/data?value=$value&quot;
        val response =
          Await.result(
            Http().singleRequest(
              HttpRequest(
                method = HttpMethods.POST,
                uri = Uri(url),
                headers = List(headers.Authorization(bearerToken))
              )
            ),
            2.seconds
          )

        response.status match {
          case StatusCodes.OK           =&gt; println(&quot;Success&quot;)
          case StatusCodes.Unauthorized =&gt; println(&quot;Authentication failed&quot;)
          case StatusCodes.Forbidden    =&gt; println(&quot;Permission denied&quot;)
          case code                     =&gt; println(s&quot;Unrecognised error: http status code = ${code.value}&quot;)
        }

      case None =&gt;
        println(&quot;you need to login before executing this command&quot;)
        System.exit(1)
    }
  }
}</code></pre></dd>
</dl>
<p>Write command constructor takes InstalledAppAuthAdapter &amp; a string value. This string value is expected from the CLI input. Since in the akka-http routes, the post route is protected by a realm role policy, we need to pass bearer token in the request header. </p>
<p><code>installedAppAuthAdapter.getAccessTokenString()</code> returns <code>Option[String]</code> if it is None, it means that user has not logged in and so we display an error message stating the same. If it returns a token string, we pass it in the header.</p>
<p>If the response status code is 200, it means authentication and authorization were successful. In this case authorization required that the user had <code>admin</code> role. </p>
<p>If the response is 401, it indicates that there was something wrong with the token. It could indicate that token is expired or does not have valid signature. <code>InstalledAppAuthAdapter</code> ensures that you don&rsquo;t send a request with an expired token. If the access token is expired, it refreshes the access token with the help of a <code>refresh</code> token. If the refresh token is also expired, it returns <code>None</code> which means that user has to log in again.</p>
<p>If the response is 403, it indicates that token was valid but the token is not authorized to perform certain action. In this case if the token belonged to a user who does not have <code>admin</code> role, server will return 403.</p>
<h2><a href="#source-code-for-above-examples" name="source-code-for-above-examples" class="anchor"><span class="anchor-link"></span></a>Source code for above examples</h2>
<p><a href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/scala/example/auth/installed">Example</a></p>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/services/aas/csw-aas-installed.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../services/aas/csw-aas-js.html" title="Javascript Adapter (csw-aas-js)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Javascript Adapter (csw-aas-js)
</span>
</div>
</a>
<a href="../../commons/apps.html" title="Applications" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Applications
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../."}})</script>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
