<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>Managing Command State · TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Managing Command State
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../messages/units.html" class="page">Units</a></li>
    <li><a href="../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../messages/events.html" class="page">Events</a></li>
    <li><a href="../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="active page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="page">Event Service</a></li>
    <li><a href="../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../services/time.html" class="page">Time Service</a></li>
    <li><a href="../services/database.html" class="page">Database Service</a></li>
    <li><a href="../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../apps/cswadminserver.html" class="page">csw-admin-server</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../framework/managing-command-state.html#managing-command-state" class="header">Managing Command State</a>
  <ul>
    <li><a href="../framework/managing-command-state.html#updating-a-long-running-command" class="header">Updating a Long-running Command</a></li>
    <li><a href="../framework/managing-command-state.html#using-the-crm-with-subcommands" class="header">Using the CRM with Subcommands</a></li>
    <li><a href="../framework/managing-command-state.html#addsubcommand" class="header">addSubCommand</a></li>
    <li><a href="../framework/managing-command-state.html#updatesubcommand" class="header">updateSubCommand</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../framework/managing-command-state.html#managing-command-state" class="header">Managing Command State</a>
  <ul>
    <li><a href="../framework/managing-command-state.html#updating-a-long-running-command" class="header">Updating a Long-running Command</a></li>
    <li><a href="../framework/managing-command-state.html#using-the-crm-with-subcommands" class="header">Using the CRM with Subcommands</a></li>
    <li><a href="../framework/managing-command-state.html#addsubcommand" class="header">addSubCommand</a></li>
    <li><a href="../framework/managing-command-state.html#updatesubcommand" class="header">updateSubCommand</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#managing-command-state" name="managing-command-state" class="anchor"><span class="anchor-link"></span></a>Managing Command State</h1>
<p>A component has access to <code>commandResponseManager</code> which is used to manage the state of commands during its execution. On receiving a command as a part of <code>onSubmit</code> and if the command is accepted by the component, the framework adds the command to an internal CommandResponseManager (CRM). The framework also uses the <code>SubmitResponse</code> returned by the <code>onSubmit</code> handler to update the CommandResponseManager. In many cases, this is adequate and no other information is required to handle completion information.</p>
<p>The CommandResponseManager can provide additional support in the following scenarios. These scenarios require the developer to update the CRM.</p>
<ol>
  <li>The command received in <code>onSubmit</code> returns <code>Started</code> indicating a long-running command that requires notification of completion at a later time.</li>
  <li>To process an <code>onSubmit</code> that starts long-running actions, the component needs to send one or more commands to other components that may also take time to complete.</li>
</ol>
<h2><a href="#updating-a-long-running-command" name="updating-a-long-running-command" class="anchor"><span class="anchor-link"></span></a>Updating a Long-running Command</h2>
<p>In the first scenario, the developer has a long-running command and does not start any sub-commands or does not with to use the CRM to help manage subcommands. In this case, once the actions are completed, <code>addOrUpdateCommand</code> is used to notify the CRM that the actions are complete. This will cause the original sender to be notified of completion using the <code>SubmitResponse</code> passed to <code>addOrUpdateCommand</code>.</p>
<h3><a href="#addorupdatecommand" name="addorupdatecommand" class="anchor"><span class="anchor-link"></span></a>addOrUpdateCommand</h3>
<p><code>AddOrUpdateCommand</code> is used to add a new command or update the status of an existing command. The following example simulates a worker that takes some time to complete. The <code>onSubmit</code> handler returns <code>Started</code> and later the actions complete with <code>Completed</code>, which completes the command. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/csw-framework/src/test/scala/csw/common/components/command/McsHcdComponentHandlers.scala#L37-L43" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def onSubmit(controlCommand: ControlCommand): SubmitResponse = {
  controlCommand.commandName match {
    case `longRunning` ⇒
      ctx.scheduleOnce(5.seconds,
                       commandResponseManager.commandResponseManagerActor,
                       AddOrUpdateCommand(Completed(controlCommand.runId)))
      Started(controlCommand.runId)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/csw-framework/src/test/java/csw/framework/javadsl/components/JSampleComponentHandlers.java#L137-L152" target="_blank" title="Go to snippet source"></a><code class="language-java">private CommandResponse.SubmitResponse crmAddOrUpdate(Setup setup) {
    // This simulates some worker task doing something that finishes after onSubmit returns
    Runnable task = new Runnable() {
        @Override
        public void run() {
            commandResponseManager.addOrUpdateCommand(new CommandResponse.Completed(setup.runId()));
        }
    };

    // Wait a bit and then set CRM to Completed
    ExecutorService executor = Executors.newSingleThreadScheduledExecutor();
    ((ScheduledExecutorService) executor).schedule(task, 1, TimeUnit.SECONDS);

    // Return Started from onSubmit
    return new CommandResponse.Started(setup.runId());
}</code></pre></dd>
</dl>
<h2><a href="#using-the-crm-with-subcommands" name="using-the-crm-with-subcommands" class="anchor"><span class="anchor-link"></span></a>Using the CRM with Subcommands</h2>
<p>If while processing a received command, the component needs to create and send commands to other components (e.g, an Assembly sending commands to one or more HCDs) it can use the CRM to help manage responses from the sub-commands.</p>
<p>A received command that requires one or more sub-commands must first associate the sub-commands with the received command using the <code>addSubCommand</code> CRM method. When the sub-commands complete, <code>updateSubCommand</code> is used to update the status of sub-commands. </p>
<p>The status of original command can then be derived from the status of the sub-commands and when all the sub-commands have completed either successfully or not, the original command will complete and a response returned to the original command sender.</p>
<h2><a href="#addsubcommand" name="addsubcommand" class="anchor"><span class="anchor-link"></span></a>addSubCommand</h2>
<p>Use <code>addSubCommand</code> to associate sub-commands with a received command.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/csw-framework/src/test/scala/csw/common/components/command/McsAssemblyComponentHandlers.scala#L66-L74" target="_blank" title="Go to snippet source"></a><code class="language-scala">// When receiving the command, onSubmit adds three subCommands
shortSetup = Setup(prefix, shortRunning, controlCommand.maybeObsId)
commandResponseManager.addSubCommand(runId, shortSetup.runId)

mediumSetup = Setup(prefix, mediumRunning, controlCommand.maybeObsId)
commandResponseManager.addSubCommand(runId, mediumSetup.runId)

longSetup = Setup(prefix, longRunning, controlCommand.maybeObsId)
commandResponseManager.addSubCommand(runId, longSetup.runId)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/framework/components/assembly/JAssemblyComponentHandlers.java#L182-L188" target="_blank" title="Go to snippet source"></a><code class="language-java">Prefix prefix1 = new Prefix(&quot;wfos.red.detector&quot;);
Setup subCommand1 = new Setup(prefix1, new CommandName(&quot;sub-command-1&quot;), sc.jMaybeObsId());
commandResponseManager.addSubCommand(sc.runId(), subCommand1.runId());

Prefix prefix2 = new Prefix(&quot;wfos.blue.detector&quot;);
Setup subCommand2 = new Setup(prefix2, new CommandName(&quot;sub-command-2&quot;), sc.jMaybeObsId());
commandResponseManager.addSubCommand(sc.runId(), subCommand2.runId());</code></pre></dd>
</dl>
<h2><a href="#updatesubcommand" name="updatesubcommand" class="anchor"><span class="anchor-link"></span></a>updateSubCommand</h2>
<p>Use <code>updateSubCommand</code> to update the CRM with the <code>SubmitResponse</code> of the sub-commands. This can trigger the delivery of the status of the original/parent command when status of all the sub-commands have been updated. A <code>SubmitResponse</code> indicating failure such as <code>Cancelled</code> or <code>Error</code> in any one of the sub-commands results in the error status of the parent command. Status of any other sub-commands wil not be considered in this case.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/csw-framework/src/test/scala/csw/common/components/command/McsAssemblyComponentHandlers.scala#L127-L144" target="_blank" title="Go to snippet source"></a><code class="language-scala">// An original command is split into sub-commands and sent to a component.
// The current state publishing is not relevant to the updateSubCommand usage.
case _: Completed ⇒
  controlCommand.runId match {
    case id if id == shortSetup.runId ⇒
      currentStatePublisher
        .publish(CurrentState(shortSetup.source, StateName(&quot;testStateName&quot;), Set(choiceKey.set(shortCmdCompleted))))
      // As the commands get completed, the results are updated in the commandResponseManager
      commandResponseManager.updateSubCommand(Completed(id))
    case id if id == mediumSetup.runId ⇒
      currentStatePublisher
        .publish(CurrentState(mediumSetup.source, StateName(&quot;testStateName&quot;), Set(choiceKey.set(mediumCmdCompleted))))
      commandResponseManager.updateSubCommand(Completed(id))
    case id if id == longSetup.runId ⇒
      currentStatePublisher
        .publish(CurrentState(longSetup.source, StateName(&quot;testStateName&quot;), Set(choiceKey.set(longCmdCompleted))))
      commandResponseManager.updateSubCommand(Completed(id))
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tmtsoftware/csw/tree/master/examples/src/main/java/example/framework/components/assembly/JAssemblyComponentHandlers.java#L208-L219" target="_blank" title="Go to snippet source"></a><code class="language-java">// An original command is split into sub-commands and sent to a component.
// The result from submitting the sub-commands is used to update the CRM
ICommandService componentCommandService = runningHcds.get(componentInfo.getConnections().get(0)).get();
componentCommandService.submit(subCommand2, Timeout.durationToTimeout(FiniteDuration.apply(5, TimeUnit.SECONDS)))
        .thenAccept(commandResponse -&gt; {
            if (commandResponse instanceof CommandResponse.Completed) {
                // As the commands get completed, the results are updated in the commandResponseManager
                commandResponseManager.updateSubCommand(commandResponse);
            } else {
                // do something
            }
        });</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>It may be the case that the component wants to avoid automatic inference of a command based on the result of the sub-commands. It should refrain from updating the status of the sub-commands in this case and update the status of the parent command directly as required.</p></div>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/framework/managing-command-state.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../framework/handling-lifecycle.html" title="Component Handlers" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Component Handlers
</span>
</div>
</a>
<a href="../framework/tracking-connections.html" title="Tracking Connections" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Tracking Connections
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
