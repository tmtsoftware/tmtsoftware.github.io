<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../assets/images/favicon.png">
<title>Alarm Service Â· TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../lib/prettify/prettify.css">
<script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Alarm Service
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../index.html" title="TMT Common Software (CSW)" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<ul>
  <li><a href="../../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../../commons/using-alarms.html" class="page">Using Alarms</a></li>
  <li><a href="../../commons/unit-tests.html" class="page">Adding Unit Tests</a></li>
  <li><a href="../../commons/params.html" class="page">Params</a>
  <ul>
    <li><a href="../../params/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../../params/units.html" class="page">Units</a></li>
    <li><a href="../../params/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../../params/commands.html" class="page">Commands</a></li>
    <li><a href="../../params/events.html" class="page">Events</a></li>
    <li><a href="../../params/states.html" class="page">State Variables</a></li>
    <li><a href="../../params/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../../commons/logging_aggregator.html" class="page">Logging Aggregator</a></li>
  <li><a href="../../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../../services/location.html" class="page">Location Service</a></li>
    <li><a href="../../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../../services/event.html" class="page">Event Service</a></li>
    <li><a href="../../services/alarm.html" class="page">Alarm Service</a></li>
    <li><a href="../../services/time.html" class="page">Time Service</a></li>
    <li><a href="../../services/database.html" class="page">Database Service</a></li>
    <li><a href="../../services/aas.html" class="page">Authentication and Authorization Service (AAS)</a></li>
    <li><a href="../../services/sequencer-command-service.html" class="page">Sequencer Command Service</a></li>
  </ul></li>
  <li><a href="../../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../../apps/csinstallation.html" class="page">Coursier Installation</a></li>
    <li><a href="../../apps/cswservices.html" class="page">csw-services</a></li>
    <li><a href="../../apps/cswlocationserver.html" class="page">csw-location-server</a></li>
    <li><a href="../../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../../apps/cswconfigcli.html" class="page">csw-config-cli</a></li>
    <li><a href="../../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../../apps/cswalarmcli.html" class="page">csw-alarm-cli</a></li>
    <li><a href="../../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../../commons/deployment.html" class="page">Deployment</a>
  <ul>
    <li><a href="../../deployment/env-vars.html" class="page">Environment variables</a></li>
    <li><a href="../../deployment/network-topology.html" class="page">Network Topology</a></li>
  </ul></li>
  <li><a href="../../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../../commons/manuals.html" class="page">Manuals</a></li>
  <li><a href="../../migration_guide/migration-guides.html" class="page">Migration Guides</a>
  <ul>
    <li><a href="../../migration_guide/migration_guide_1.0.0_to_2.0.0/migration-guide-1.0.0-to-2.0.0.html" class="page">Migration Guide from 1.0.0 to 2.0.0</a></li>
  </ul></li>
  <li><a href="../../commons/contract.html" class="page">CSW Service contract</a></li>
  <li><a href="../../technical/technical.html" class="page">Technical Design Documents</a>
  <ul>
    <li><a href="../../technical/framework/framework.html" class="page">Framework</a></li>
    <li><a href="../../technical/command/command.html" class="page">Command</a></li>
    <li><a href="../../technical/params/params.html" class="page">Params</a></li>
    <li><a href="../../technical/location/location.html" class="page">Location Service</a></li>
    <li><a href="../../technical/configuration/configuration.html" class="page">Configuration Service</a></li>
    <li><a href="../../technical/logging/logging.html" class="page">Logging Service</a></li>
    <li><a href="../../technical/event/event.html" class="page">Event Service</a></li>
    <li><a href="../../technical/alarm/alarm.html" class="active page">Alarm Service</a></li>
    <li><a href="../../technical/time/time.html" class="page">Time Service</a></li>
    <li><a href="../../technical/database/database.html" class="page">Database Service</a></li>
    <li><a href="../../technical/aas/aas.html" class="page">Authentication and Authorization Service</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../technical/alarm/alarm.html#alarm-service" class="header">Alarm Service</a>
  <ul>
    <li><a href="../../technical/alarm/alarm.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../technical/alarm/alarm.html#technology" class="header">Technology</a></li>
    <li><a href="../../technical/alarm/alarm.html#severities" class="header">Severities</a></li>
    <li><a href="../../technical/alarm/alarm.html#health" class="header">Health</a></li>
    <li><a href="../../technical/alarm/alarm.html#severity-health-aggregations" class="header">Severity &amp; Health Aggregations</a></li>
    <li><a href="../../technical/alarm/alarm.html#redis-storage" class="header">Redis Storage</a></li>
    <li><a href="../../technical/alarm/alarm.html#alarm-disconnection" class="header">Alarm Disconnection</a></li>
    <li><a href="../../technical/alarm/alarm.html#severity-latching" class="header">Severity Latching</a></li>
    <li><a href="../../technical/alarm/alarm.html#shelving-alarms" class="header">Shelving Alarms</a></li>
    <li><a href="../../technical/alarm/alarm.html#acknowledging-alarms" class="header">Acknowledging Alarms</a></li>
    <li><a href="../../technical/alarm/alarm.html#api-and-implementation-structure" class="header">API and Implementation Structure</a></li>
    <li><a href="../../technical/alarm/alarm.html#architecture" class="header">Architecture</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 3.0.0-RC4
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../technical/alarm/alarm.html#alarm-service" class="header">Alarm Service</a>
  <ul>
    <li><a href="../../technical/alarm/alarm.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../technical/alarm/alarm.html#technology" class="header">Technology</a></li>
    <li><a href="../../technical/alarm/alarm.html#severities" class="header">Severities</a></li>
    <li><a href="../../technical/alarm/alarm.html#health" class="header">Health</a></li>
    <li><a href="../../technical/alarm/alarm.html#severity-health-aggregations" class="header">Severity &amp; Health Aggregations</a></li>
    <li><a href="../../technical/alarm/alarm.html#redis-storage" class="header">Redis Storage</a></li>
    <li><a href="../../technical/alarm/alarm.html#alarm-disconnection" class="header">Alarm Disconnection</a></li>
    <li><a href="../../technical/alarm/alarm.html#severity-latching" class="header">Severity Latching</a></li>
    <li><a href="../../technical/alarm/alarm.html#shelving-alarms" class="header">Shelving Alarms</a></li>
    <li><a href="../../technical/alarm/alarm.html#acknowledging-alarms" class="header">Acknowledging Alarms</a></li>
    <li><a href="../../technical/alarm/alarm.html#api-and-implementation-structure" class="header">API and Implementation Structure</a></li>
    <li><a href="../../technical/alarm/alarm.html#architecture" class="header">Architecture</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#alarm-service" name="alarm-service" class="anchor"><span class="anchor-link"></span></a>Alarm Service</h1>
<h2><a href="#introduction" name="introduction" class="anchor"><span class="anchor-link"></span></a>Introduction</h2>
<p>Alarm Service in TMT software is used by components to raise alarms. Alarms are used exclusively to notify the operator of conditions that require operator intervention. Each alarms includes a severity that must be one of the supported severities such as Warning, Critical, etc. The Alarm Service also provides mechanisms to monitor the health of all components and subsystems in TMT.</p>
<h2><a href="#technology" name="technology" class="anchor"><span class="anchor-link"></span></a>Technology</h2>
<p>Alarm Service uses <a href="https://redis.io/">Redis</a> for persistence. Redis provides <a href="https://redis.io/topics/notifications">Keyspace Notifications</a> which allows clients to subscribe to Pub/Sub channels in order to receive events affecting the Redis data set in some way.</p>
<p><img src="alarm-layers.png" alt="Alarm Dependencies" /></p>
<p>We have created a layer i.e. &ldquo;Romaine&rdquo; which converts redis events into an <a href="https://doc.akka.io/docs/akka/current/stream/index.html">akka stream</a>. Romaine internally uses a java redis library called <a href="https://lettuce.io/">Lettuce</a>.</p>
<h2><a href="#severities" name="severities" class="anchor"><span class="anchor-link"></span></a>Severities</h2>
<p>An alarm can have one of the following severities at a given time</p>
<table>
  <thead>
    <tr>
      <th align="right">Severity Name </th>
      <th align="center">Severity Level </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="right"><code>Okay</code> </td>
      <td align="center">0 </td>
    </tr>
    <tr>
      <td align="right"><code>Warning</code> </td>
      <td align="center">1 </td>
    </tr>
    <tr>
      <td align="right"><code>Major</code> </td>
      <td align="center">2 </td>
    </tr>
    <tr>
      <td align="right"><code>Indeterminate</code> </td>
      <td align="center">3 </td>
    </tr>
    <tr>
      <td align="right"><code>Disconnected</code> </td>
      <td align="center">4 </td>
    </tr>
    <tr>
      <td align="right"><code>Critical</code> </td>
      <td align="center">5 </td>
    </tr>
  </tbody>
</table>
<p>Severity can be for a single alarm or aggregated for a component or subsystem.</p>
<h2><a href="#health" name="health" class="anchor"><span class="anchor-link"></span></a>Health</h2>
<p>Health is a higher level abstraction created on top of severities. One or more alarms can be combined to calculate one of the following healths at a given time.</p>
<ul>
  <li><code>Good</code></li>
  <li><code>Ill</code></li>
  <li><code>Bad</code></li>
</ul>
<p>Health is calculated based on severity. The current mapping between health and severities is shown in the figure below. Health can be for aggregated for a component, subsystem, or the entire TMT system.</p>
<p><img src="alarm-health.png" alt="alarm-health" /></p>
<h2><a href="#severity-health-aggregations" name="severity-health-aggregations" class="anchor"><span class="anchor-link"></span></a>Severity &amp; Health Aggregations</h2>
<p>A severity can be associated with an alarm, a component or a sub-system.</p>
<p>Unlike alarms, which has a direct association with severity, components and sub-systems don&rsquo;t have a direct association with severities. They have aggregated severities based on severities of their children.</p>
<p><img src="alarm-hierarchy.png" alt="alarm-hierarchy" /></p>
<p>A components aggregated severity is equal to severity of its child alarm with &ldquo;maximum&rdquo; severity. Similarly, a sub-system&rsquo;s aggregated severity is determined by its child component with maximum severity.</p>
<p>Health aggregation works on top of severity aggregation. A components aggregated health is calculated by first calculating its aggregated severity and then mapping it to health. Sub-System health aggregation works in the same way.</p>
<h2><a href="#redis-storage" name="redis-storage" class="anchor"><span class="anchor-link"></span></a>Redis Storage</h2>
<p><img src="redis-keys.png" alt="redis-keys" /></p>
<h3><a href="#metadata" name="metadata" class="anchor"><span class="anchor-link"></span></a>Metadata</h3>
<p>Metadata of an alarm is static information about an alarm such as name, description, subsystem, component, etc. This information is not changed during runtime. Since the metadata is static, entire metadata of an alarm is stored against a single redis key in json format for easy retrieval. The static information is contained in a configuration file and loaded when Alarm Service starts up. The key name is formed with pattern: <code>metadata-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code> e.g. <code>metadata-nfiraos-trombone-tromboneaxislowlimitalarm</code>.</p>
<p>The sample JSON below, shows structure of typical alarm metadata from the configuration file</p>
<pre class="prettyprint"><code class="language-json">{
   &quot;subsystem&quot;:&quot;tcs&quot;,
   &quot;component&quot;:&quot;corrections&quot;,
   &quot;name&quot;:&quot;outOfRangeOffload&quot;,
   &quot;description&quot;:&quot;Another system has sent an out of range offload that has caused the system to go into a bad state!&quot;,
   &quot;location&quot;:&quot;Computer Room&quot;,
   &quot;alarmType&quot;:&quot;absolute&quot;,
   &quot;supportedSeverities&quot;:[
      &quot;warning&quot;,
      &quot;major&quot;,
      &quot;indeterminate&quot;,
      &quot;okay&quot;
   ],
   &quot;probableCause&quot;:&quot;Bad software in NFIRAOS or WFOS&quot;,
   &quot;operatorResponse&quot;:&quot;Reset the software system and hope&quot;,
   &quot;isAutoAcknowledgeable&quot;:false,
   &quot;isLatchable&quot;:true,
   &quot;activationStatus&quot;:&quot;active&quot;
}
</code></pre>
<h3><a href="#acknowledgement-status" name="acknowledgement-status" class="anchor"><span class="anchor-link"></span></a>Acknowledgement Status</h3>
<p>Indicates Acknowledgement status of an alarm. The key name is formed with pattern <code>ackstatus-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code>. e.g. ackstatus-nfiraos-enclosure-temphighalarm</p>
<p>Possible values of this key are: </p>
<ul>
  <li><code>acknowledged</code></li>
  <li><code>unacknowledged</code></li>
</ul>
<h3><a href="#severity" name="severity" class="anchor"><span class="anchor-link"></span></a>Severity</h3>
<p>Indicates the current severity of an alarm. The key name is formed with pattern <code>severity-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code>.<br/>e.g. <code>severity-nfiraos-trombone-tromboneaxislowlimitalarm</code></p>
<p>This key can contain one of the following values at a given time -</p>
<ul>
  <li><code>okay</code></li>
  <li><code>warning</code></li>
  <li><code>major</code></li>
  <li><code>indeterminate</code></li>
  <li><code>critical</code></li>
</ul>
<p>If the value is not present, it is considered to have <code>disconnected</code> severity.</p>
<h3><a href="#latched-severity" name="latched-severity" class="anchor"><span class="anchor-link"></span></a>Latched Severity</h3>
<p>Indicates the severity on which the current alarm is latched. A latched severity is the max severity of an alarm since last reset operation. The key name is formed with pattern <code>latchedseverity-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code>. e.g. <code>latchedseverity-tcs-tcspk-cpuexceededalarm</code></p>
<p>Possible values of this key are: </p>
<ul>
  <li><code>okay</code></li>
  <li><code>warning</code></li>
  <li><code>major</code></li>
  <li><code>indeterminate</code></li>
  <li><code>critical</code></li>
  <li><code>disconnected</code></li>
</ul>
<h3><a href="#shelve-status" name="shelve-status" class="anchor"><span class="anchor-link"></span></a>Shelve Status</h3>
<p>Indicates shelved status of an alarm. The key name is formed with pattern <code>shelvestatus-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code>. e.g. <code>shelvestatus-nfiraos-trombone-tromboneaxislowlimitalarm</code></p>
<p>This key can have one of the following values</p>
<ul>
  <li><code>shelved</code></li>
  <li><code>unshelved</code></li>
</ul>
<p>If no value is present, it is inferred as <code>unshelved</code></p>
<h3><a href="#alarm-time" name="alarm-time" class="anchor"><span class="anchor-link"></span></a>Alarm Time</h3>
<p>Indicates the time of the last severity change of an alarm. The key name is formed with pattern <code>alarmtime-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code>. e.g. <code>alarmtime-nfiraos-beamsplitter-splitterlimitalarm</code></p>
<p>The value is stored in the format: <code>2019-04-03T11:09:28.404143Z</code></p>
<h3><a href="#initializing" name="initializing" class="anchor"><span class="anchor-link"></span></a>Initializing</h3>
<p>Indicates whether alarm is initializing or its initialization is finished. It contains a boolean value either <code>true</code> or <code>false</code></p>
<p>The key name is formed with pattern <code>initializing-[SUBSYSTEM_NAME]-[COMPONENT_NAME]-[ALARM_NAME]</code>. e.g. <code>initializing-lgsf-tcspkinactive-cpuidlealarm</code></p>
<h2><a href="#alarm-disconnection" name="alarm-disconnection" class="anchor"><span class="anchor-link"></span></a>Alarm Disconnection</h2>
<p>All the severities except <code>Disconnected</code>, need to be set explicitly. <code>Disconnected</code> is a special severity in the sense that it can never be set by a component explicitly and is always inferred when there is no severity value has been set. Alarm service uses <a href="https://en.wikipedia.org/wiki/Heartbeat_(computing)">Heartbeat pattern</a>.</p>
<p>Whenever a component calls <code>SetSeverity</code>, severity get stored in redis for that alarm with certain <em>TTL</em>. This TTL is configurable. For our example, let&rsquo;s assume it is 5 seconds. A TTL of 5 second means that if another call to <code>SetSeverity</code> is not made <strong>within</strong> 5 seconds, the current severity will get deleted from redis. Absence of severity is inferred as &ldquo;Disconnected&rdquo; severity. </p>
<p><img src="alarm-disconnection.gif" alt="alarm-disconnection" /></p>
<p>So to avoid disconnection of an alarm, the component will need to ensure that a <code>SetSeverity</code> call (aka heartbeat) is made with appropriate severity at-least once in every 5 seconds.</p>
<p><img src="alarm-heartbeat.gif" alt="alarm-heartbeat" /></p><div class="callout note "><div class="callout-title">Note</div>
<p>Actual TLL depends on <code>refresh-interval</code> &amp; <code>max-missed-refresh-counts</code> configurations. For example, if <code>refresh-interval</code> is set to <code>3s</code> (3 seconds) and <code>max-missed-refresh-counts</code> is set to 2, alarm will get disconnected after 6 seconds (3 * 2)</p></div>
<p>Using the heartbeat pattern allows us to detect dead or disconnected components automatically without polling them at regular intervals.</p>
<h2><a href="#severity-latching" name="severity-latching" class="anchor"><span class="anchor-link"></span></a>Severity Latching</h2>
<p><a href="alarm.html#metadata">Alarm metadata</a> JSON has a boolean attribute called &ldquo;isLatchable&rdquo;. This determines the latching behaviour of an alarm. If an alarm is latchable, its latched severity <em>sticks</em> to the last highest severity reached until the alarm is reset. Reset operation is provided the <a href="alarm.html#api-and-implementation-structure">admin api</a> of alarm service.</p>
<p><img src="alarm-latchable-behavior-with-reset.gif" alt="latched-alarm-behaviour" /></p>
<p>For, alarms which are not latchable, latched severity will always be equal to severity.</p>
<p>Setting severity and latched severity both is done by <code>SetSeverity</code> api. As described in previous sections, when a component dies, it can&rsquo;t call <code>SetSeverity</code> and the severity key in redis, expires. However the &ldquo;Latched Severity&rdquo; is still not updated; which is a problem. To solve this problem, the future Alarm Server subscribes to all severity changes (using akka stream api of alarm service) and whenever it detects a key has expired, it updates its respective &ldquo;latchedSeverity&rdquo; value in Redis to <code>disconnected</code>.</p>
<h2><a href="#shelving-alarms" name="shelving-alarms" class="anchor"><span class="anchor-link"></span></a>Shelving Alarms</h2>
<p>Alarms can be shelved and un-shelved using the Alarm Service API. A shelved alarm will contribute to a subsystem&rsquo;s aggregate severity and health. An alarm can only be shelved for a predefined time. The time can be configured in Alarm Service configuration. For example: </p>
<pre class="prettyprint"><code class="language-hocon">shelve-timeout = &quot;8:00:00 AM&quot; // format -&gt; h:m:s a
</code></pre>
<p>When changing the shelve status to <code>shelved</code> it is set using <code>setex</code> operation of redis with an appropriate TTL so that it gets expired on next <code>shelve-timeout</code>. Once expired, it is inferred as <code>unshelved</code>.</p>
<p>Alarms can also be un-shelved explicitly before next <code>shelve-timeout</code> occurs. <code>unshelve</code> api sets <code>unshelved</code> value in redis explicitly without any TTL.</p>
<h2><a href="#acknowledging-alarms" name="acknowledging-alarms" class="anchor"><span class="anchor-link"></span></a>Acknowledging Alarms</h2>
<p>Alarms can be in either <code>acknowledged</code> or <code>unacknowledged</code> state. See <a href="alarm.html#acknowledgement-status">Acknowledgement Status</a> for more details. The state can be changed to <code>acknowledged</code> by simply using <code>acknowledge</code> api of alarm service. Apart from this api, setting severity can also change the Acknowledgement Status of an alarm.</p>
<p>Alarm can either be auto-acknowledgeable or not auto-acknowledgeable. This behavior is driven from <a href="alarm.html#metadata">alarm metadata</a>. When an alarm is not auto-acknowledgeable, whenever it&rsquo;s severity changes to anything except Okay, it&rsquo;s Acknowledgement Status becomes <code>acknowledged</code>. If it is changing from any severity to Okay, Acknowledgement Status remains same.</p>
<p>When the alarm is auto-acknowledgeable, whenever it&rsquo;s severity changes to Okay, it&rsquo;s Acknowledgement Status becomes <code>acknowledged</code>. If it changes to anything else, Acknowledgement Status remains same.</p>
<h2><a href="#api-and-implementation-structure" name="api-and-implementation-structure" class="anchor"><span class="anchor-link"></span></a>API and Implementation Structure</h2>
<p><img src="api-structure.png" alt="api-structure" /></p>
<p>The alarm functionality divided into two services <a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-api/src/main/scala/csw/alarm/api/scaladsl/AlarmService.scala">AlarmService</a> and <a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-api/src/main/scala/csw/alarm/api/scaladsl/AlarmAdminService.scala">AlarmAdminService</a></p>
<p><a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-api/src/main/scala/csw/alarm/api/scaladsl/AlarmService.scala">AlarmService</a> is meant for &ldquo;Components&rdquo; that can only set their current alarm severity and hence for components, Alarm Service only exposes one api i.e. <code>setSeverity</code></p>
<p><a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-api/src/main/scala/csw/alarm/api/scaladsl/AlarmAdminService.scala">AlarmAdminService</a> is meant for admin operations. </p>
<p>The Alarm Service implementation is further divided into four internal modules.</p>
<p><strong>1. <a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-client/src/main/scala/csw/alarm/client/internal/services/SeverityServiceModule.scala">SeverityServiceModule</a></strong></p>
<p><code>SeverityServiceModule</code> allows reading, subscribing and modifying severity of alarms and subsystems.</p>
<p><strong>2. <a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-client/src/main/scala/csw/alarm/client/internal/services/MetadataServiceModule.scala">MetadataServiceModule</a></strong></p>
<p><code>MetadataServiceModule</code> allows read-only access to alarm metadata. Initialisation of alarms is also performed using this module.</p>
<p><strong>3. <a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-client/src/main/scala/csw/alarm/client/internal/services/StatusServiceModule.scala">StatusServiceModule</a></strong></p>
<p><code>StatusServiceModule</code> allows read-write access to alarm status via operations such as getStatus, shelveAlarm, reset, acknowledge, unshelve, etc.</p>
<p>AlarmStatus is a logical entity which contains:</p>
<ul>
  <li><code>acknowledgementStatus</code></li>
  <li><code>latchedSeverity</code></li>
  <li><code>shelveStatus</code></li>
  <li><code>alarmTime</code></li>
  <li><code>initializing</code></li>
</ul>
<p><strong>4. <a href="https://github.com/tmtsoftware/csw/blob/v3.0.0-RC4/csw-alarm/csw-alarm-client/src/main/scala/csw/alarm/client/internal/services/HealthServiceModule.scala">HealthServiceModule</a></strong></p>
<p><code>HealthServiceModule</code> allows reading and subscribing to alarm and subsystem healths.</p><div class="callout note "><div class="callout-title">Note</div>
<p>These modules are interdependent on each other and use <a href="https://docs.scala-lang.org/tour/self-types.html">self-type</a> feature of scala</p></div>
<p><img src="class-diagram.png" alt="class-diagram" /></p>
<p><code>AlarmAdminService</code> is consumed from <a href="https://github.com/tmtsoftware/csw/tree/v3.0.0-RC4/csw-alarm/csw-alarm-cli">alarm cli</a> and Alarm Server. This API is also used by administrative clients such as the future Alarm Server.</p>
<p>The API doc for Alarm Service can be found <a href="https://tmtsoftware.github.io/csw/3.0.0-RC4/api/scala/csw/alarm/api/scaladsl/AlarmService.html" title="csw/alarm/api/scaladsl/AlarmService"><code>here</code></a> and <a href="https://tmtsoftware.github.io/csw/3.0.0-RC4/api/scala/csw/alarm/api/scaladsl/AlarmAdminService.html" title="csw/alarm/api/scaladsl/AlarmAdminService"><code>here</code></a>.</p>
<p>Detailed documentation about how to use these APIs is available <a href="../../services/alarm.html">here</a>.</p>
<h3><a href="#setting-severity-execution-workflow" name="setting-severity-execution-workflow" class="anchor"><span class="anchor-link"></span></a>Setting severity execution workflow</h3>
<p>The following diagram show execution sequence triggered when a component calls <code>setSeverityApi</code></p>
<p><img src="setSeverity-sequence.png" alt="setSeverity-sequence" /></p>
<h2><a href="#architecture" name="architecture" class="anchor"><span class="anchor-link"></span></a>Architecture</h2>
<p><img src="alarm-architecture.png" alt="architecture" /></p><div class="callout warning "><div class="callout-title">Important</div>
<p>At the time of writing this documentation, the Alarm Server does not exist. It will be developed in future as part of ESW.HCMS. Its description and scope of work is subjected to change</p></div>
<p>For alarms to function, it is necessary that the Alarm Service&rsquo;s Redis instance be registered with Location Service. Redis here is configured similar to other services in CSW. There is a master Redis instance and a slave Redis instance. They are configured in &ldquo;replication&rdquo; mode. There is a Sentinel instance who&rsquo;s responsibility it is to promote the slave as master when master goes down. It is important to note that when master goes down, the &ldquo;location&rdquo; of Alarm Service remains the same because the location of Alarm Service is the location of Sentinel and not of master or slave. The master and slave Redis instances are dedicated for alarm, however Sentinel is shared across CSW Redis-based services.</p>
<p>Once location is registered, components, alarm CLI &amp; Alarm Server can resolve Redis location and start interacting with it using the component alarm API &amp; alarm admin API. While the interaction of components with Alarm Service is limited to the <code>setSeverity</code> API, Alarm CLI can perform all admin operations as discussed <a href="alarm.html#api-and-implementation-structure">above</a>.</p>
<p>Alarm Server is part of ESW.HCMS and is not yet built. When built, its functionality will be to watch all severity changes using the admin API and <a href="alarm.html#severity-latching">latch</a> appropriate alarms to disconnected severity. Apart from this, it will also be responsible for logging alarms and generating alarm events for archiving in DMS.ENG. It provides an HTTP interface for various UI layer ESW.HCMS applications for alarm and health visualisations.</p>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/technical/alarm/alarm.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
3.0.0-RC4
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../technical/event/event.html" title="Event Service" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Event Service
</span>
</div>
</a>
<a href="../../technical/time/time.html" title="Time Service" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Time Service
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../."}})</script>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
