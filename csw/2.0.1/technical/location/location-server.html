<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../assets/tmt_favicon.ico">
<title>Location Server</title>
<link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../lib/prettify/prettify.css">
<script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../technical/location/location-server.html" title="Location Server" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
Location Server
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../technical/location/location-server.html" title="Location Server" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../technical/location/location-server.html" title="Location Server">
Location Server
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw
</div>
</a>

</div>
<ul>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../technical/location/location-server.html#location-server" class="header">Location Server</a>
  <ul>
    <li><a href="../../technical/location/location-server.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../technical/location/location-server.html#design" class="header">Design</a></li>
    <li><a href="../../technical/location/location-server.html#internals" class="header">Internals</a></li>
    <li><a href="../../technical/location/location-server.html#java-api" class="header">Java API</a></li>
    <li><a href="../../technical/location/location-server.html#tests" class="header">Tests</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.0.1
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../technical/location/location-server.html#location-server" class="header">Location Server</a>
  <ul>
    <li><a href="../../technical/location/location-server.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../technical/location/location-server.html#design" class="header">Design</a></li>
    <li><a href="../../technical/location/location-server.html#internals" class="header">Internals</a></li>
    <li><a href="../../technical/location/location-server.html#java-api" class="header">Java API</a></li>
    <li><a href="../../technical/location/location-server.html#tests" class="header">Tests</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#location-server" name="location-server" class="anchor"><span class="anchor-link"></span></a>Location Server</h1>
<h2><a href="#introduction" name="introduction" class="anchor"><span class="anchor-link"></span></a>Introduction</h2>
<p>The <a href="https://github.com/tmtsoftware/csw/tree/master/csw-location/csw-location-server">csw-location-server</a> project contains the main implementation of the Location Service. Think of it as a agent which is running on every machine. Normally one instance of the <em>Location Server</em> will run on each host that is running CSW services (although clients can be configured to use a remote host).</p>
<h2><a href="#design" name="design" class="anchor"><span class="anchor-link"></span></a>Design</h2>
<p>Main building blocks of location service are captured below, we will go through each one of them in following sections:</p>
<ul>
  <li><a href="https://doc.akka.io/docs/akka/current/index-cluster.html">Akka Cluster</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/typed/distributed-data.html">Conflict Free Replicated Data Types (CRDTs)</a>: Shares location information within the network.</li>
  <li><a href="https://doc.akka.io/docs/akka-http/current/">Akka HTTP</a></li>
  <li>DeathWatch Actor</li>
</ul>
<p><img src="../../images/locationservice/location-service.png" alt="Location Service" /></p>
<p>Above diagram shows different parts of Location Service and how it will look like in TMT environment. On a single physical machine, we can have multiple JVM&rsquo;s (Java Virtual Machines) running. Roughly these JVM&rsquo;s can be categorized into two types:</p>
<ul>
  <li><code>Container</code>: It can have single or multiple components (HCD, Assembly etc.) running inside it.</li>
  <li><code>Location Service</code>: Think of it as a agent which is running on all the machines in TMT environment.</li>
</ul><div class="callout note "><div class="callout-title">Note</div>
<p>Here onwards, we will refer to Location Service as agent or server interchangeably. Do not confuse it with <a href="location-agent.html">csw-location-agent</a>.</p></div>
<p>Let&rsquo;s discuss different components of <code>Location Server</code> in following sections:</p>
<h3><a href="#cluster-member" name="cluster-member" class="anchor"><span class="anchor-link"></span></a>Cluster Member</h3>
<p>Location Service JVM (precisely Actor System) takes part in <a href="https://doc.akka.io/docs/akka/current/index-cluster.html">Akka Cluster</a>. By default, this actor system binds to port <code>3552</code>. Initially when there is no member in Akka cluster, node joins itself. Such a node is referred as seed node (introducer) and the location of this node needs to be known so that other nodes can join to this known address and form a larger cluster. After the joining process is complete, seed nodes are not special and they participate in the cluster in exactly the same way as other nodes.</p>
<p>Akka Cluster provides cluster <a href="https://doc.akka.io/docs/akka/current/typed/cluster-membership.html">membership</a> service using <a href="https://doc.akka.io/docs/akka/current/typed/cluster-concepts.html#gossip">gossip</a> protocols and an automatic <a href="https://doc.akka.io/docs/akka/current/typed/cluster-concepts.html#failure-detector">failure detector</a>.</p>
<p>Death watch uses the cluster failure detector for nodes in the cluster, i.e. it detects network failures and JVM crashes, in addition to graceful termination of watched actor. Death watch generates the <code>Terminated</code> message to the watching actor when the unreachable cluster node has been downed and removed. Hence we have kept <code>auto-down-unreachable-after = 10s</code> so that in case of failure, interested parties get the death watch notification for the location in around 10s.</p>
<h3><a href="#distributed-data-replicator-" name="distributed-data-replicator-" class="anchor"><span class="anchor-link"></span></a>Distributed Data (Replicator)</h3>
<p>We use Akka Distributed Data to share CSW component locations between nodes in an Akka Cluster. These locations are accessed with an actor called as <code>replicator</code> providing a key-value store like API. We store the following data in this key-value store (distributed data):</p>
<ul>
  <li>
  <p><code>AllServices</code>:  This uses <a href="https://doc.akka.io/docs/akka/current/distributed-data.html?language=scala">LWWMap</a> CRDT from <code>Connection</code> to <code>Location</code>. <code>Connection</code> and <code>Location</code> can be one of <code>Akka</code>, <code>Tcp</code> or <code>HTTP</code> type.  At any point in time, the value of this map represents all the locations registered with <code>Location Service</code> in a TMT environment.</p></li>
  <li>
  <p><code>Service</code>:  This uses <a href="https://doc.akka.io/docs/akka/current/distributed-data.html?language=scala">LWWRegister</a> which holds location of CSW component against unique connection name.</p></li>
</ul>
<h4><a href="#consistency-guarantees" name="consistency-guarantees" class="anchor"><span class="anchor-link"></span></a>Consistency Guarantees</h4>
<ul>
  <li><code>WriteMajority</code>: All the write API&rsquo;s (register, unregister etc.) updates registry (distributed data) with consistency level of <code>WriteMajority</code> which means value will immediately be written to a majority of replicas, i.e. at least N/2 + 1 replicas, where N is the number of nodes in the cluster</li>
  <li><code>ReadLocal</code>: All the get API&rsquo;s (find, resolve, list etc.): retrieves value from registry (distributed data) with consistency level of <code>ReadLocal</code> which means value will only be read from the local replica</li>
</ul>
<p>In TMT environment, we do not want two components to be registered with same connection name. This is achieved by configuring consistency level of <code>WriteMajority</code> for <code>register</code> API. Register API guarantees that a component is registered with Location Service and its entry is replicated to at least N/2 + 1 replicas.</p>
<p>Based on above configuration, it is always guaranteed that only one location of a component will exist at any point in time in registry. Hence it is safe to read location just from local replica with consistency level of <code>ReadLocal</code> with the assumption that eventually location will get replicated on this replica if not present when queried.</p>
<h3><a href="#death-watch-actor" name="death-watch-actor" class="anchor"><span class="anchor-link"></span></a>Death Watch Actor</h3>
<p>Death watch actor registers interest in change notifications for <code>AllServices</code> key. Hence on every addition or removal of location, death watch actor receives <code>Changed[LWWMap[Connection, Location]]</code> message from where it gets all the current locations.</p>
<p>Death watch actor then starts watching all the new locations. When it receives <code>Terminated</code> signal for any of the watched location precisely for actor ref, then it unregister that particular connection from Location Service.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Death watch actor only supports Akka locations and filters out <code>tcp</code> and <code>http</code> locations.</p></div>
<h3><a href="#http-server" name="http-server" class="anchor"><span class="anchor-link"></span></a>HTTP Server</h3>
<p>Location Service provides HTTP routes to get, register, unregister and track locations. Only one instance of location server is started on port <code>7654</code> on evey machine. Client from same machine running in different processes can connect to <code>localhost:7654</code> to access Location Service. In most of the cases, you will not directly talk to this address. You will always use Location Service client provided by CSW which internally connects to <code>localhost:7654</code> to access <code>Location Service</code>.</p>
<h3><a href="#how-location-tracking-works" name="how-location-tracking-works" class="anchor"><span class="anchor-link"></span></a>How location tracking works</h3>
<p>Below diagram illustrate <code>Assembly</code> tracking <code>HCD</code>. Use case shown in diagram is when <code>Assembly</code> starts tracking, before <code>HCD</code> is registered with Location Service. It also shows the abrupt shutdown of <code>HCD</code> and how <code>Assembly</code> gets notification of that.</p>
<p><img src="../../images/locationservice/track.png" alt="Location Track" /></p>
<p>Let us go through each action step by step as shown in diagram:</p>
<ol>
  <li>
    <p><code>Assembly</code> starts tracking <code>HCD</code> by sending <code>HTTP</code> track request using location client to location server.</p>
    <ol>
      <li>
      <p>On receiving track request, location server internally subscribes to the <code>replicator</code> using <code>Service</code> key as explained in previous section and generates stream of <code>TrackingEvent</code></p></li>
      <li>
      <p>Server then maps this stream of <code>TrackingEvent</code> to <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/scala/csw/location/server/http/LocationWebsocketHandler.scala">Websocket</a></p></li>
      <li>
      <p>Server also keeps sending <code>ServerSentEvent.heartbeat</code> every <code>2 seconds</code> to keep connection alive</p></li>
    </ol>
  </li>
  <li>
    <p><code>HCD</code> registers with Location Service by sending <code>register</code> request to location server.</p>
    <ol>
      <li>
      <p>On receiving register request, location server internally updates both <code>Service</code> and <code>AllServices</code> keys by sending <code>update</code> message to <code>replicator</code></p></li>
    </ol>
  </li>
  <li>
  <p>Death watch actor is started with Location Service and it gets notification on every component registration.  In our flow, death watch actor receives notification of <code>HCD</code> getting registered with Location Service from previous step and it immediately starts watching death of <code>HCD</code>.</p></li>
  <li>
  <p>One of the tasks of <code>replicator</code> is to keep replicating <code>CRDT&#39;s</code> from one node to other.  In this case, location of <code>HCD</code> gets replicated from <code>Machine 1</code> to <code>Machine 2</code></p></li>
  <li>
    <p>As soon as <code>replicator</code> from <code>Machine 2</code> receives <code>HCD</code> location, it notifies all the interested parties.</p>
    <ol>
      <li>
      <p>Remember <code>Step 1</code> is interested and receives <code>Changed(key)</code> message from <code>replicator</code> which gets mapped to <code>TrackingEvent</code></p></li>
      <li>
      <p>Location server then maps it to <code>LocationUpdated</code> event and pushes it to <code>Assembly</code> via <code>SSE</code></p></li>
    </ol>
  </li>
  <li>
  <p>Assume that after some time, <code>HCD</code> crashes/terminates/throws exception and shutdowns abruptly.</p></li>
  <li>
  <p>As described in <code>Step 3</code>, Death watch actor is watching <code>HCD</code>.  On <code>HCD&#39;s</code> shutdown, death watch actor <code>unregisters</code> <code>HCD</code> from Location Service by sending update message by removing <code>HCD&#39;s</code> entry from <code>replicator</code>.</p></li>
  <li>
  <p>Eventually this removal of <code>HCD</code> gets replicated to <code>replicator</code> running on <code>Machine 2</code>.</p></li>
  <li>
  <p>On receiving removal of <code>HCD</code> location, same actions gets performed as described in <code>Step 5</code>.  In this case, <code>LocationRemoved</code> event gets pushed to <code>Assembly</code> via <code>SSE</code></p></li>
</ol><div class="callout note "><div class="callout-title">Note</div>
<p>At any point in time, <code>Assembly</code> can choose to cancel tracking. On cancellation, this persistent connection will be released.</p></div>
<h3><a href="#location-service-with-authentication-and-authorization" name="location-service-with-authentication-and-authorization" class="anchor"><span class="anchor-link"></span></a>Location Service with Authentication and Authorization</h3>
<p>Note : <code>Outside</code> below means any machine not present in this Akka cluster.</p>
<p>Below diagram illustrate how Akka cluster will look when authentication and authorization is enabled in <code>Location Server</code>. By default when you start <code>Location Server</code>, it will start in local-only mode (Authentication and authorization  Disabled) and bind to <code>127.0.0.1</code>. To start <code>Location Server</code> in public mode (Authentication and authorization enabled) and bind to <code>0.0.0.0</code>, use  <code>--publicNetwork</code> command line  option when <a href="../../apps/cswlocationserver.html">starting location server</a></p>
<p><img src="../../images/locationservice/location-service-auth.png" alt="Location Authentication and Authorization" /></p>
<p>Why is this needed ?</p>
<ol>
  <li>As <code>Location Server</code> is by default bind to <code>127.0.0.1</code>, no application can establish Http connection from  <code>Outside</code>.</li>
  <li>In production environment, you may need a capability to access protected resources of <code>Location Server</code> and provide  Authentication and Authorization for such resources. E.g. ability to register/unregister components(which has to  undergo maintenance) from a system operator machine present <code>Outside</code>.</li>
  <li>To enable this we need to bind few instances of <code>Location Server</code> to <code>0.0.0.0</code>, so that <code>Outside</code> Http connections  can be made and applications with valid token, can access its protected resources.</li>
</ol>
<h2><a href="#internals" name="internals" class="anchor"><span class="anchor-link"></span></a>Internals</h2>
<p>The <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/scala/csw/location/server/Main.scala">Main</a> class delegates the job of creating the cluster actor and HTTP server instance to the <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/scala/csw/location/server/internal/ServerWiring.scala">ServerWiring</a> class.</p>
<p>The default TCP ports for the actor and HTTP servers are specified in <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/resources/application.conf">application.conf</a>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Due to the way random port numbers are used for CSW components, firewalls should be disabled for these systems, which are assumed to be in an internal network that is protected from outside access.</p></div>
<p>In order to determine the correct IP address to use for the local host, it is necessary to set the <em>INTERFACE_NAME</em> environment variable or property to the name of the network interface to use (There could be multiple NICs). The <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/scala/csw/location/server/commons/ClusterSettings.scala">ClusterSettings</a> class uses that information, along with other settings when starting the cluster actor. It also needs to know the <em>cluster seeds</em>, a comma separated list of <em>host:port</em> values for at least one other actor in the cluster. This information is needed in order to join the Location Service cluster.</p>
<p>The Location Service HTTP server is implemented by the <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/scala/csw/location/server/http/LocationHttpHandler.scala">LocationHttpHandler</a> class, <a href="https://github.com/tmtsoftware/csw/blob/v2.0.1/csw-location/csw-location-server/src/main/scala/csw/location/server/http/LocationWebsocketHandler.scala">LocationWebsocketHandler</a> and talks to the cluster actor on the client&rsquo;s behalf.</p>
<h2><a href="#java-api" name="java-api" class="anchor"><span class="anchor-link"></span></a>Java API</h2>
<p>Since the location <em>server</em> is only accessed internally, there is no extra Java API for it. The location service <em>client</em> and <em>API</em> code does provide Java APIs (see below).</p>
<h2><a href="#tests" name="tests" class="anchor"><span class="anchor-link"></span></a>Tests</h2>
<p>There are numerous tests for the location server, including multi-jvm tests. The tests can be run with:</p>
<ul>
  <li>
  <p>Unit/Component Tests: <code>sbt csw-location-server/test:test</code></p></li>
  <li>
  <p>Multi-Jvm Tests: <code>sbt integration/multi-jvm:testOnly csw.location*</code></p></li>
</ul>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw/tree/master/docs/src/main/technical/location/location-server.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.0.1
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../."}})</script>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
