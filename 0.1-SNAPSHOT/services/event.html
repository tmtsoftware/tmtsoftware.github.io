<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../assets/tmt_favicon.ico">
<title>Event Service · TMT Common Software (CSW)</title>
<link rel="stylesheet" href="../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="TMT Common Software (CSW)" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
TMT Common Software (CSW)
</span>
<span class="md-header-nav__topic">
Event Service
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/tmtsoftware/csw-prod"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw-prod
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</span>
<a href="../index.html" title="TMT Common Software (CSW)">
TMT Common Software (CSW)
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/tmtsoftware/csw-prod"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
tmtsoftware/csw-prod
</div>
</a>

</div>
<ul>
  <li><a href="../commons/getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../commons/create-component.html" class="page">Creating a Component</a></li>
  <li><a href="../commons/multiple-components.html" class="page">Multiple Components</a></li>
  <li><a href="../commons/messages.html" class="page">Messages</a>
  <ul>
    <li><a href="../messages/keys-parameters.html" class="page">Keys and Parameters</a></li>
    <li><a href="../messages/units.html" class="page">Units</a></li>
    <li><a href="../messages/subsystem.html" class="page">Subsystem</a></li>
    <li><a href="../messages/commands.html" class="page">Commands</a></li>
    <li><a href="../messages/events.html" class="page">Events</a></li>
    <li><a href="../messages/states.html" class="page">State Variables</a></li>
    <li><a href="../messages/result.html" class="page">Result</a></li>
  </ul></li>
  <li><a href="../commons/framework.html" class="page">Framework for creating components (HCD, Assembly, Container)</a>
  <ul>
    <li><a href="../framework/describing-components.html" class="page">ComponentInfo</a></li>
    <li><a href="../framework/creating-components.html" class="page">Creating an Assembly or Hcd Component</a></li>
    <li><a href="../framework/handling-lifecycle.html" class="page">Component Handlers</a></li>
    <li><a href="../framework/managing-command-state.html" class="page">Managing Command State</a></li>
    <li><a href="../framework/tracking-connections.html" class="page">Tracking Connections</a></li>
    <li><a href="../framework/publishing-state.html" class="page">Publishing State</a></li>
    <li><a href="../framework/handling-exceptions.html" class="page">Handling Exceptions</a></li>
    <li><a href="../framework/deploying-components.html" class="page">Deploying Components</a></li>
  </ul></li>
  <li><a href="../commons/command.html" class="page">Communication using Commands</a></li>
  <li><a href="../commons/services.html" class="page">Services</a>
  <ul>
    <li><a href="../services/location.html" class="page">Location Service</a></li>
    <li><a href="../services/config.html" class="page">Configuration Service</a></li>
    <li><a href="../services/logging.html" class="page">Logging Service</a></li>
    <li><a href="../services/event.html" class="active page">Event Service</a></li>
  </ul></li>
  <li><a href="../commons/apps.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/cswclusterseed.html" class="page">csw-cluster-seed</a></li>
    <li><a href="../apps/cswlocationagent.html" class="page">csw-location-agent</a></li>
    <li><a href="../apps/cswonfigserverapp.html" class="page">csw-config-server</a></li>
    <li><a href="../apps/cswconfigclientcli.html" class="page">csw-config-client-cli</a></li>
    <li><a href="../apps/csweventcli.html" class="page">csw-event-cli</a></li>
    <li><a href="../apps/hostconfig.html" class="page">csw-host-config</a></li>
  </ul></li>
  <li><a href="../commons/testing.html" class="page">Testing</a></li>
  <li><a href="../commons/sbt-tasks.html" class="page">sbt Tasks</a></li>
  <li><a href="../commons/manuals.html" class="page">Manuals</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../services/event.html#event-service" class="header">Event Service</a>
  <ul>
    <li><a href="../services/event.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../services/event.html#accessing-event-service" class="header">Accessing Event Service</a></li>
    <li><a href="../services/event.html#usage-of-eventpublisher" class="header">Usage of EventPublisher</a></li>
    <li><a href="../services/event.html#usage-of-eventsubscriber" class="header">Usage of EventSubscriber</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 0.1*
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../services/event.html#event-service" class="header">Event Service</a>
  <ul>
    <li><a href="../services/event.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../services/event.html#accessing-event-service" class="header">Accessing Event Service</a></li>
    <li><a href="../services/event.html#usage-of-eventpublisher" class="header">Usage of EventPublisher</a></li>
    <li><a href="../services/event.html#usage-of-eventsubscriber" class="header">Usage of EventSubscriber</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#event-service" name="event-service" class="anchor"><span class="anchor-link"></span></a>Event Service</h1>
<p>The Event Service implements the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">publish/subscribe messaging paradigm</a> where one component publishes an event and all components that have subscribed receive the event. The advantage of this type of message system is that publishers and subscribers are decoupled. This decoupling of publishers and subscribers can allow for greater scalability and a more dynamic network topology. Publishers can publish regardless of whether there are subscribers, and subscribers can subscribe even if there are no publishers. The relationship between publishers and subscribers can be one-to-one, one-to-many, many to one, or even many-to-many. </p>
<p>Event Service is optimized for the high performance requirements of event streams which support multiple streams with varying rates, for ex. 100 Hz, 50 Hz etc. In the TMT control system event streams are created as an output of a calculation by one component for the input to a calculation in one or more other components. Event streams often consist of events that are published at a specific rate. These events are transient, historical events are not stored/persisted. </p>
<p>The Event Service provides an API that allows <a href="../messages/events.html">Event</a>s to be created and published as well as allows clients to subscribe and unsubscribe to specific types of events.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>If you already have a dependency on <code>csw-framework</code> in your <code>build.sbt</code>, then you can skip this as <code>csw-framework</code> depends on <code>csw-event-client</code> Otherwise add below dependency in your <code>build.sbt</code></p>
<dl>
  <dt>sbt</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;org.tmt&quot; %% &quot;csw-event-client&quot; % &quot;0.1-SNAPSHOT&quot;
</code></pre></dd>
</dl>
<h2><a href="#accessing-event-service" name="accessing-event-service" class="anchor"><span class="anchor-link"></span></a>Accessing Event Service</h2>
<p>When you create component handlers using <code>csw-framework</code> as explained <a href="../framework/creating-components.html">here</a>, you get a handle to <code>EventService</code> which is created by <code>csw-framework</code></p>
<p>Using <code>EventService</code> you can start publishing or subscribing to events. <code>EventService</code> injected in component handlers via <code>csw-framwework</code> provides following features: </p>
<ul>
  <li>
  <p>Access to <code>defaultPublisher</code>: Using <code>defaultPublisher</code>, you can publish event or stream of events to event server. In most of the cases, you should use <code>defaultPublisher</code>, because you can then pass the instance of <code>EventService</code> in worker actors or different places in your code and call <code>eventService.defaultPublisher</code> to access publisher. This way you reuse same instance of <code>EventPublisher</code> which means all events published via <code>defaultPublisher</code> go through same tcp connection.</p></li>
  <li>
  <p>Access to <code>defaultSubscriber</code>: Using <code>defaultSubscriber</code>, you can subscribe to specific event keys. You can share <code>defaultSubscriber</code> same way like <code>defaultPublisher</code> by passing instance of <code>EventService</code> to different parts of your code. Unlike <code>defaultPublisher</code>, each subscription <code>defaultSubscriber.subscribe</code> call creates a new tcp connection. This behavior is similar either you use <code>defaultSubscriber</code> or <code>makeNewSubscriber</code> call on <code>EventService</code>. But whenever you create a new <code>EventSubscriber</code>, it creates one more tcp connection which is used to get latest event from event server (Note that this is a different connection than the one which gets created on subscription). That means, with <code>defaultSubscriber</code>, you are sharing same connection for getting latest events and creating a new connection for each subscribe call.</p></li>
  <li>
  <p>Create new <code>Publisher</code> or <code>Subscriber</code>: Whenever a new publisher or subscriber is created, location of event service is resolved. So, in case your event server goes down, and you wish to re-resolve the event server location, you would make a call to <code>makeNewPublisher</code> or <code>makeNewSubscriber</code> instead of using the <code>defaultPublisher</code> and <code>defaultSubscriber</code>. Apart from the above mentioned scenario, one can choose to create a new publisher in case of high frequency event streams to dedicate a separate connection to demanding streams without affecting the performance of all other low frequency (for ex. 1Hz, 20Hz etc.) event streams.</p></li>
</ul>
<h2><a href="#usage-of-eventpublisher" name="usage-of-eventpublisher" class="anchor"><span class="anchor-link"></span></a>Usage of EventPublisher</h2>
<p>Below example demonstrates the usage of publish API with event generator to publish events generated at specified interval and call onError callback to log events that were failed to be published.</p>
<ul>
  <li>eventGenerator: Function responsible for generating events. You can add domain specific logic of generating new events based on certain conditions.</li>
  <li>onError: Function which gets invoked on events which were failed to be published.</li>
</ul>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">private def startPublishingEvents(): Future[Cancellable] = async {
  val publisher = await(eventService.defaultPublisher)
  val baseEvent = SystemEvent(componentInfo.prefix, EventName(&quot;filter_wheel&quot;))

  publisher.publish(eventGenerator(baseEvent), 100.millis, onError)
}

// this holds the logic for event generation, could be based on some computation or current state of HCD
private def eventGenerator(baseEvent: Event): Event = baseEvent match {
  case e: SystemEvent  ⇒ e.copy(eventId = Id(), eventTime = EventTime())
  case e: ObserveEvent ⇒ e.copy(eventId = Id(), eventTime = EventTime())
}

private def onError(publishFailure: PublishFailure): Unit =
  log.error(s&quot;Publish failed for event: [${publishFailure.event}]&quot;, ex = publishFailure.cause)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">private CompletableFuture&lt;Cancellable&gt; startPublishingEvents() {
    Event baseEvent = new SystemEvent(componentInfo.prefix(), new EventName(&quot;filter_wheel&quot;));
    return eventService.defaultPublisher().thenApply(publisher -&gt; publisher.publish(() -&gt; eventGenerator(baseEvent), Duration.ofMillis(100), this::onError));
}

// this holds the logic for event generation, could be based on some computation or current state of HCD
private Event eventGenerator(Event baseEvent) {
    // add logic here to create a new event and return the same
    return baseEvent;
}

private void onError(PublishFailure publishFailure) {
    log.error(&quot;Failed to publish event: [&quot; + publishFailure.event() + &quot;]&quot;, publishFailure.cause());
}</code></pre></dd>
</dl>
<p>You can find complete list of APIs supported by <code>EventPublisher</code> and <code>IEventPublisher</code> with detailed description of each API here: </p>
<ul>
  <li><a href="https://tmtsoftware.github.io/csw-prod/0.1-SNAPSHOT/api/scala/csw/services/event/api/scaladsl/EventPublisher.html">EventPublisher</a></li>
  <li><a href="https://tmtsoftware.github.io/csw-prod/0.1-SNAPSHOT/api/java/?csw/services/event/api/javadsl/IEventPublisher.html">IEventPublisher</a></li>
</ul>
<h2><a href="#usage-of-eventsubscriber" name="usage-of-eventsubscriber" class="anchor"><span class="anchor-link"></span></a>Usage of EventSubscriber</h2>
<p>Below example demonstrates the usage of subscribe API with actorRef.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">// subscribe to HCD&#39;s filter_wheel event stream
subscriber.subscribeActorRef(Set(EventKey(hcd.prefix, EventName(&quot;filter_wheel&quot;))), eventHandler)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">CompletableFuture&lt;IEventSubscription&gt; subscription = subscriberF.thenApply(subscriber -&gt; {
    EventKey filterWheelEventKey = new EventKey(hcdLocation.get().prefix(), new EventName(&quot;filter_wheel&quot;));
    return subscriber.subscribeActorRef(Collections.singleton(filterWheelEventKey), eventHandler);
});</code></pre></dd>
</dl>
<p>In above example, <code>eventHandler</code> is the actorRef which accepts events. If you need to mutate state on receiving each event, then it is recommended to use this API. To use this API, you have to create an actor which takes event and then you can safely keep mutable state inside this actor.</p>
<p>The subscription API shown above receives events as soon as they are published. However, other APIs also support <code>interval</code> and <code>Subscription Mode</code> which help in controlling the rate of events received. This can cater multiple use cases for instance slow subscribers can receive events at their own speed rather than being overloaded with events to catch up with the publisher&rsquo;s speed.</p>
<p>There are two types of Subscription modes:</p>
<ul>
  <li><code>RateAdapterMode</code> which ensures that an event is received exactly at each tick of the specified interval.</li>
  <li><code>RateLimiterMode</code> which ensures that events are received as they are published along with the guarantee that no more than one event is delivered within a given interval.</li>
</ul>
<p>Read more about Subscription Mode <a href="https://tmtsoftware.github.io/csw-prod/0.1-SNAPSHOT/api/scala/csw/services/event/api/scaladsl/SubscriptionMode.html">here</a></p>
<h3><a href="#pattern-subscription" name="pattern-subscription" class="anchor"><span class="anchor-link"></span></a>Pattern Subscription</h3>
<p>Below example demonstrates the usage of pattern subscribe API with callback. Events with keys that match the specified pattern and belong to the given subsystem are received by the subscriber. The callback function provided is called on each event received.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">private def subscribeToSubsystemEvents(subsystem: Subsystem) = async {
  val subscriber = await(eventService.defaultSubscriber)
  subscriber.pSubscribeCallback(subsystem, &quot;*&quot;, callback)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">private void subscribeToSubsystemEvents(Subsystem subsystem)  {
    subscriberF.thenApply(subscriber -&gt; subscriber.pSubscribeCallback(subsystem, &quot;*&quot;, this::callback));
}</code></pre></dd>
</dl><div class="callout warning "><div class="callout-title">Warning</div>
<p>DO NOT include subsystem in the provided pattern. Final pattern generated will be provided pattern prepended with subsystem. For Ex. <code>pSubscribe(Subsytem.WFOS, *)</code> will subscribe to event keys matching pattern : <code>wfos.*</code></p></div>
<h3><a href="#event-subscription" name="event-subscription" class="anchor"><span class="anchor-link"></span></a>Event Subscription</h3>
<p>On subscription to event keys, you get a handle to <code>EventSubscription</code> which provides following APIs:</p>
<ul>
  <li>
  <p><code>unsubscribe</code>: On un-subscribing, the event stream is destroyed and the connection created to event server while subscription is released.</p></li>
  <li>
  <p><code>ready</code>: check if event subscription is successful or not.</p></li>
</ul>
<p>You can find complete list of API&rsquo;s supported by <code>EventSubscriber</code> and <code>IEventSubscriber</code> with detailed description of each API here: </p>
<ul>
  <li><a href="https://tmtsoftware.github.io/csw-prod/0.1-SNAPSHOT/api/scala/csw/services/event/api/scaladsl/EventSubscriber.html">EventSubscriber</a></li>
  <li><a href="https://tmtsoftware.github.io/csw-prod/0.1-SNAPSHOT/api/java/?csw/services/event/api/javadsl/IEventSubscriber.html">IEventSubscriber</a></li>
</ul>
</div>
<div>
<a href="https://github.com/tmtsoftware/csw-prod/tree/master/docs/src/main/services/event.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../services/logging.html" title="Logging Service" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Logging Service
</span>
</div>
</a>
<a href="../commons/apps.html" title="Applications" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Applications
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.5165553b.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
